const overboardLink=document.getElementById("overboardlink");if(overboardLink){if((()=>{const e=JSON.parse(localStorage.getItem("overboardsettings"));(e.add.length>0||e.rem.length>0||!e.include_default)&&overboardLink.setAttribute("href",`/overboard.html?${new URLSearchParams(e)}`)})(),"/overboard.html"===location.pathname){const e=document.getElementById("overboardform");if(e){const t=()=>{const t={add:e.elements.add.value,rem:e.elements.rem.value,include_default:e.elements.include_default.checked};0!==t.add.length||t.include_default||(t.include_default=!0),setLocalStorage("overboardsettings",JSON.stringify(t))};e.addEventListener("submit",t,!1)}}}document.querySelectorAll('input[type="file"]').forEach((e=>{e.style.position="absolute",e.style.border="none",e.style.height="1px",e.style.width="1px"}));class Dragable{constructor(e,t){this.draging=!1,this.xo=0,this.yo=0,this.targetId=t,this.handle=document.querySelector(e),this.target=document.querySelector(t);const s=localStorage.getItem(`${this.targetId}-dragtop`);"null"!=s&&(this.target.style.top=s,this.target.style.bottom="unset");const a=localStorage.getItem(`${this.targetId}-dragleft`);"null"!=a&&(this.target.style.left=a),this.target.style.right="unset",this.target.addEventListener("opened",(e=>this.updateMaxSizes(e))),this.handle.addEventListener("mousedown",(e=>this.startDrag(e))),this.handle.addEventListener("touchstart",(e=>this.startDrag(e)),{passive:!0}),document.addEventListener("mouseup",(e=>this.stopDrag(e))),document.addEventListener("touchend",(e=>this.stopDrag(e))),window.addEventListener("resize",(e=>this.updateMaxSizes(e))),window.addEventListener("orientationchange",(e=>this.updateMaxSizes(e)))}inBounds(e,t,s,a){return e-t<=0?0:e-t+s>a?a-s:e-t}updateMaxSizes(){let e=this.target.getBoundingClientRect();0!==e.width&&(e.right>document.documentElement.clientWidth&&(this.target.style.left=0),e.bottom>document.documentElement.clientHeight&&(this.target.style.top=0),e=this.target.getBoundingClientRect(),this.target.style.maxHeight=document.documentElement.clientHeight-e.top+"px",this.target.style.maxWidth=document.documentElement.clientWidth-e.left+"px")}startDrag(e){this.draging=!0,this.handle.style.cursor="grabbing",this.target.style.position="fixed";const t=this.target.getBoundingClientRect();switch(e.type){case"mousedown":this.xo=e.clientX-t.left,this.yo=e.clientY-t.top,window.addEventListener("mousemove",(e=>this.doDrag(e)));break;case"touchstart":e.preventDefault(),e.stopPropagation(),this.xo=e.targetTouches[0].clientX-t.left,this.yo=e.targetTouches[0].clientY-t.top,window.addEventListener("touchmove",(e=>this.doDrag(e)))}}doDrag(e){if(this.draging){switch(this.updateMaxSizes(),this.target.style.bottom="unset",e.type){case"mousemove":this.target.style.left=`${this.inBounds(e.clientX,this.xo,this.target.offsetWidth,document.documentElement.clientWidth)}px`,this.target.style.top=`${this.inBounds(e.clientY,this.yo,this.target.offsetHeight,document.documentElement.clientHeight)}px`;break;case"touchmove":e.preventDefault(),e.stopPropagation(),this.target.style.left=`${this.inBounds(e.targetTouches[0].clientX,this.xo,this.target.offsetWidth,document.documentElement.clientWidth)}px`,this.target.style.top=`${this.inBounds(e.targetTouches[0].clientY,this.yo,this.target.offsetHeight,document.documentElement.clientHeight)}px`}this.target.style.bottom="unset",setLocalStorage(`${this.targetId}-dragtop`,this.target.style.top),setLocalStorage(`${this.targetId}-dragleft`,this.target.style.left)}}stopDrag(){this.draging&&(this.draging=!1,this.handle.style.cursor="grab",window.removeEventListener("mousemove",(e=>this.doDrag(e))),window.removeEventListener("touchmove",(e=>this.doDrag(e))))}}document.getElementById("postform")&&new Dragable("#postform-dragHandle","#postform");let imageSourcesList,imageSources=new Set(JSON.parse(localStorage.getItem("hiddenimages")));const toggleAllHidden=e=>imageSources.forEach((t=>toggleSource(t,e))),toggleSource=(e,t)=>{document.querySelectorAll(`img.file-thumb[src="${e}"], img.catalog-thumb[src="${e}"]`).forEach((e=>e.classList[t?"add":"remove"]("vh")));document.querySelectorAll(`a.hide-image[data-src="${e}"]`).forEach((e=>e.textContent=t?"Show":"Hide"))};toggleAllHidden(!0);const toggleHandler=e=>{const t=e.target.dataset.src,s=imageSources.has(t);imageSources[s?"delete":"add"](t),imageSourcesList.value=[...imageSources],setLocalStorage("hiddenimages",JSON.stringify([...imageSources])),toggleSource(t,!s)};document.querySelectorAll(".hide-image").forEach((e=>{e.addEventListener("click",toggleHandler,!1)}));const handleHiddenImages=e=>{if(e.detail.json.files.forEach((e=>{let t="/file/";e.hasThumb?t+=`thumb/${e.hash}${e.thumbextension}`:t+=e.filename,imageSources.has(t)&&toggleSource(t,!0)})),!e.detail.hover){const t=e.detail.post.querySelectorAll(".hide-image");for(let e=0;e<t.length;e++)t[e].addEventListener("click",toggleHandler,!1)}};window.addEventListener("addPost",handleHiddenImages,!1),window.addEventListener("settingsReady",(()=>{imageSourcesList=document.getElementById("hiddenimages-setting"),imageSourcesList.value=[...imageSources];document.getElementById("hiddenimages-clear").addEventListener("click",(()=>{toggleAllHidden(!1),imageSources=new Set,imageSourcesList.value="",setLocalStorage("hiddenimages","[]"),console.log("cleared hidden images list")}),!1)}));let yousList,notificationsEnabled="true"==localStorage.getItem("notifications"),notificationYousOnly="true"==localStorage.getItem("notification-yous-only"),yousEnabled="true"==localStorage.getItem("yous-setting"),savedYous=new Set(JSON.parse(localStorage.getItem("yous")));const toggleAllYous=e=>savedYous.forEach((t=>toggleOne(t,e))),toggleQuotes=(e,t)=>{e.forEach((e=>{e.classList[t?"add":"remove"]("you")}))},toggleOne=(e,t)=>{const[s,a]=e.split("-"),o=document.querySelector(`[data-board="${s}"][data-post-id="${a}"]`);if(o){const e=o.querySelector(".post-name");e&&e.classList[t?"add":"remove"]("you")}const i=document.querySelectorAll(`.quote[href^="/${s}/"][href$="#${a}"]`);i&&toggleQuotes(i,t)},formatNotificationOptions=e=>{const t={body:e.nomarkup?e.nomarkup.substring(0,100):""};if(e.files.length>0){let s;const a=e.spoiler||e.files.some((e=>!0===e.spoiler)),o=e.files.find((e=>!e.spoiler&&(!0===e.hasThumb||e.mimetype.startsWith("image/"))));a&&!o?s="/file/spoiler.png":o&&(s=o.hasThumb?`/file/thumb/${o.hash}${o.thumbextension}`:`/file/${o.filename}`),s&&(t.image=s,t.badge=s,t.icon=s)}return t};yousEnabled&&toggleAllYous(yousEnabled);const handleNewYous=e=>{const t=`${e.detail.json.board}-${e.detail.postId}`,s=window.myPostId==e.detail.postId;if(s){savedYous.add(t);const e=[...savedYous];yousList.value=e.toString(),setLocalStorage("yous",JSON.stringify(e))}savedYous.has(t)&&toggleOne(t,yousEnabled);const a=e.detail.json.quotes.map((t=>`${e.detail.json.board}-${t.postId}`)).filter((e=>savedYous.has(e))).length>0,o=e.detail.json.quotes.concat(e.detail.json.backlinks).map((t=>`${e.detail.json.board}-${t.postId}`)).filter((e=>savedYous.has(e))).map((t=>{const[s,a]=t.split("-");return e.detail.post.querySelectorAll(`.quote[href^="/${s}/"][href$="#${a}"]`)})).reduce(((e,t)=>e.concat(Array.from(t))),[]);if(toggleQuotes(o,yousEnabled),!e.detail.nonotify&&!e.detail.hover&&notificationsEnabled&&!s){if(notificationYousOnly&&!a)return;try{console.log("attempting to send notification",t);const s=e.detail.json,o=formatNotificationOptions(s);new Notification(`${a?"New quote in: ":""}${document.title}`,o)}catch(e){console.log("failed to send notification",e)}}};window.addEventListener("addPost",handleNewYous,!1),window.addEventListener("updatePostMessage",handleNewYous,!1),window.addEventListener("settingsReady",(()=>{yousList=document.getElementById("youslist-setting"),yousList.value=[...savedYous];document.getElementById("youslist-clear").addEventListener("click",(()=>{yousEnabled&&toggleAllYous(!1),savedYous=new Set,yousList.value="",setLocalStorage("yous","[]"),console.log("cleared yous")}),!1);const e=document.getElementById("yous-setting");e.checked=yousEnabled,e.addEventListener("change",(()=>{yousEnabled=!yousEnabled,setLocalStorage("yous-setting",yousEnabled),toggleAllYous(yousEnabled),console.log("toggling yous",yousEnabled)}),!1);const t=document.getElementById("notification-yous-only");t.checked=notificationYousOnly,t.addEventListener("change",(()=>{notificationYousOnly=!notificationYousOnly,setLocalStorage("notification-yous-only",notificationYousOnly),console.log("toggling notification only for yous",yousEnabled)}),!1);const s=document.getElementById("notification-setting");s.checked=notificationsEnabled,s.addEventListener("change",(async()=>{if(notificationsEnabled=!notificationsEnabled,notificationsEnabled){if("granted"!=await Notification.requestPermission())return notificationsEnabled=!1,void(s.checked=!1)}console.log("toggling notifications",notificationsEnabled),setLocalStorage("notifications",notificationsEnabled)}),!1)}));const getFiltersFromLocalStorage=()=>JSON.parse(localStorage.getItem("filters1")).reduce(((e,t)=>(t.type.endsWith("r")?e[t.type].push(new RegExp(t.val,"i")):e[t.type].add(t.val),e)),{single:new Set,fid:new Set,fname:new Set,fsub:new Set,ftrip:new Set,fmsg:new Set,fnamer:[],ftripr:[],fsubr:[],fmsgr:[]});let filtersTable,{single:single,fid:fid,fname:fname,ftrip:ftrip,fsub:fsub,fmsg:fmsg,fnamer:fnamer,ftripr:ftripr,fsubr:fsubr,fmsgr:fmsgr}=JSON.parse(localStorage.getItem("filters1")).reduce(((e,t)=>(t.type.endsWith("r")?e[t.type].push(new RegExp(t.val,"i")):e[t.type].add(t.val),e)),{single:new Set,fid:new Set,fname:new Set,fsub:new Set,ftrip:new Set,fmsg:new Set,fnamer:[],ftripr:[],fsubr:[],fmsgr:[]});const updateFiltersTable=()=>{[...filtersTable.children].slice(3).forEach((e=>e.remove())),filtersTable.insertAdjacentHTML("beforeend",pugfilters({filterArr:JSON.parse(localStorage.getItem("filters1"))}));const e=filtersTable.querySelectorAll(".close");for(let t of e){let{type:e,data:s}=t.dataset;e.endsWith("r")&&(s=new RegExp(s,"i")),t.addEventListener("click",(()=>{toggleFilter(e,s)}))}},updateSavedFilters=()=>{setLocalStorage("filters1",JSON.stringify([...[...single].map((e=>({type:"single",val:e}))),...[...fid].map((e=>({type:"fid",val:e}))),...[...ftrip].map((e=>({type:"ftrip",val:e}))),...[...fname].map((e=>({type:"fname",val:e}))),...[...fsub].map((e=>({type:"fsub",val:e}))),...[...fmsg].map((e=>({type:"fmsg",val:e}))),...fnamer.map((e=>({type:"fnamer",val:e.source.toString()}))),...ftripr.map((e=>({type:"ftripr",val:e.source.toString()}))),...fsubr.map((e=>({type:"fsubr",val:e.source.toString()}))),...fmsgr.map((e=>({type:"fmsgr",val:e.source.toString()})))])),updateFiltersTable()},anyFilterMatches=e=>{const{board:t,postId:s,userId:a,name:o,subject:i,tripcode:n}=e.dataset,r=e.querySelector(".post-message"),l=r?r.textContent:null;return single.has(`${t}-${s}`)||fid.has(a)||fname.has(o)||ftrip.has(n)||fsub.has(n)||fmsg.has(l)||fnamer.some((e=>e.test(o)))||ftripr.some((e=>e.test(n)))||fsubr.some((e=>e.test(i)))||fmsgr.some((e=>e.test(l)))},togglePostsHidden=(e,t,s)=>{for(let a of e){const e=!t&&(!anyFilterMatches(a)||s);e?a.classList.remove("hidden"):a.classList.add("hidden"),a.querySelector(".postmenu").children[0].textContent=e?"Hide":"Show"}},getPostsByRegex=(e,t)=>{const s=[];for(let a of document.querySelectorAll(`[${e}]`)){const o=a.getAttribute(e).toString();!0===t.test(o)&&s.push(a)}return s},getPostsByMessage=(e,t=!1)=>[...document.querySelectorAll(`.${isCatalog?"catalog-tile":"post-container"} .post-message`)].filter((s=>t?e.test(s.textContent):s.textContent.includes(e))).map((e=>e.closest("."+(isCatalog?"catalog-tile":"post-container")))),getPostsByFilter=(e,t)=>{let s=[];switch(e){case"single":{const[e,a]=t.split("-"),o=document.querySelector(`[data-board="${e}"][data-post-id="${a}"]`);s=o?[o]:[];break}case"fid":s=document.querySelectorAll(`[data-user-id="${t}"]`);break;case"fname":s=document.querySelectorAll(`[data-name="${CSS.escape(t)}"]`);break;case"fnamer":s=getPostsByRegex("data-name",t);break;case"ftrip":s=document.querySelectorAll(`[data-tripcode="${CSS.escape(t)}"]`);break;case"ftripr":s=getPostsByRegex("data-tripcode",t);break;case"fsub":s=document.querySelectorAll(`[data-subject="${CSS.escape(t)}"]`);break;case"fsubr":s=getPostsByRegex("data-subject",t);break;case"fmsg":s=getPostsByMessage(t);break;case"fmsgr":s=getPostsByMessage(t,!0)}return[...s]},setFilterState=(e,t,s)=>{const a=s?"add":"delete";switch(e){case"single":single[a](t);break;case"fid":fid[a](t);break;case"fname":fname[a](t);break;case"fnamer":fnamer=fnamer.filter((e=>e.source!=t.source)),s&&fnamer.push(t);break;case"ftrip":ftrip[a](t);break;case"ftripr":ftripr=ftripr.filter((e=>e.source!=t.source)),s&&ftripr.push(t);break;case"fsub":fsub[a](t);break;case"fsubr":fsubr=fsubr.filter((e=>e.source!=t.source)),s&&fsubr.push(t);break;case"fmsg":fmsg[a](t);break;case"fmsgr":fmsgr=fmsgr.filter((e=>e.source!=t.source)),s&&fmsgr.push(t)}},toggleFilter=(e,t,s)=>{const a=getPostsByFilter(e,t);setFilterState(e,t,s),togglePostsHidden(a,s,"single"===e),updateSavedFilters()};let actionForm,modalBg,moderatingPost;const cancelModeratePost=e=>{moderatingPost&&(e.preventDefault(),moderatingPost.querySelector(".post-check").checked=!1,moderatingPost.style.zIndex="unset",moderatingPost.classList.contains("op")&&(moderatingPost.style.background="unset"),modalBg.style.display="none",modalBg.style.zIndex=4,actionForm.removeAttribute("open"),moderatingPost=null)},moderatePost=e=>{moderatingPost=e,actionForm.classList.add("floatactions"),actionForm.setAttribute("open","open"),actionForm.style.zIndex=3,e.style.zIndex=3,e.classList.contains("op")&&(e.style.background="var(--post-color)"),modalBg.style.display="unset",modalBg.style.zIndex=3;const t=actionForm.querySelector(".captchafield"),s=e.querySelector(".post-check");Array.from(s.form.elements).filter((e=>"checkedposts"===e.name)).forEach((e=>e.checked=!1)),s.checked=!0,t&&captchaController.loadCaptcha(t)},postMenuChange=function(){const e=this.closest(isCatalog?".catalog-tile":".post-container"),t=e.dataset,s=this.value,a=!e.classList.contains("hidden");let o;switch(this.value="",s){case"single":o=`${t.board}-${t.postId}`;break;case"fid":o=t.userId;break;case"fname":o=t.name;break;case"ftrip":o=t.tripcode;break;case"fsub":o=t.subject;break;case"moderate":return moderatePost(e);case"watch":{const s=e.querySelector(".post-message"),a=(t.subject||s&&s.textContent||"No subject").substring(0,25);return void threadWatcher.add(t.board,t.postId,{subject:a,unread:0,updatedDate:new Date})}}toggleFilter(s,o,a)};for(let e of document.getElementsByClassName("postmenu"))e.value="",e.addEventListener("change",postMenuChange,!1);const getHiddenElems=()=>{let e=[];for(let t of single)e=e.concat(getPostsByFilter("single",t));for(let t of fid)e=e.concat(getPostsByFilter("fid",t));for(let t of fname)e=e.concat(getPostsByFilter("fname",t));for(let t of fsub)e=e.concat(getPostsByFilter("fsub",t));for(let t of fmsg)e=e.concat(getPostsByFilter("fmsg",t));for(let t of ftrip)e=e.concat(getPostsByFilter("ftrip",t));for(let t of fnamer)e=e.concat(getPostsByFilter("fnamer",t));for(let t of ftripr)e=e.concat(getPostsByFilter("ftripr",t));for(let t of fsubr)e=e.concat(getPostsByFilter("fsubr",t));for(let t of fmsgr)e=e.concat(getPostsByFilter("fmsgr",t));return e};togglePostsHidden(getHiddenElems(),!0),window.addEventListener("addPost",(function(e){const t=e.detail.post;if(anyFilterMatches(t)&&t.classList.add("hidden"),e.detail.hover)return;const s=t.querySelector(".postmenu");s.value="",s.addEventListener("change",postMenuChange,!1)})),window.addEventListener("updatePostMessage",(function(e){const t=e.detail.post;anyFilterMatches(t)&&t.classList.add("hidden")})),window.addEventListener("settingsReady",(function(){actionForm=document.getElementById("actionform"),actionForm&&(modalBg=document.querySelector(".modal-bg"),actionForm.firstChild.addEventListener("click",cancelModeratePost),modalBg.addEventListener("click",cancelModeratePost,!1)),filtersTable=document.getElementById("advancedfilters"),updateFiltersTable();const e=document.getElementById("filter-form");e.addEventListener("submit",(t=>{t.preventDefault();const s=e.elements.regex.checked,a=`${e.elements.type.value}${s?"r":""}`,o=s?new RegExp(e.elements.value.value,"i"):e.elements.value.value;console.log("adding filter",a,o),toggleFilter(a,o,!0)}));document.getElementById("filters-clear").addEventListener("click",(()=>{single=new Set,fid=new Set,fname=new Set,fsub=new Set,fmsg=new Set,ftrip=new Set,fnamer=[],ftripr=[],fsubr=[],fmsgr=[],updateFiltersTable(),togglePostsHidden(document.querySelectorAll("."+(isCatalog?"catalog-tile":"post-container")),!1),updateSavedFilters(),console.log("cleared hidden posts")}),!1)}));class ThreadWatcher{init(){this.footer=document.getElementById("bottom"),this.footer&&(this.watchListMap=new Map(JSON.parse(localStorage.getItem("watchlist"))),this.minimised="true"===localStorage.getItem("threadwatcher-minimise"),this.threadMatch=window.location.pathname.match(/^\/(\w+)(?:\/manage)?\/thread\/(\d+)\.html$/),window.addEventListener("storage",(e=>this.storageEventHandler(e))),this.settingsInput=document.getElementById("watchlist-setting"),this.clearButton=document.getElementById("watchlist-clear"),this.clearButton.addEventListener("click",(()=>this.clear()),!1),this.createList({minimised:this.minimised}),this.minimiseButton=this.threadWatcher.firstChild.querySelector(".close"),this.minimiseButton.addEventListener("click",(()=>this.toggleMinimise())),this.isFocused=document.hasFocus(),null!==this.threadMatch&&(window.addEventListener("focus",(()=>this.focusHandler(this.threadMatch[1],this.threadMatch[2]))),window.addEventListener("blur",(()=>this.blurHandler())),!0===this.isFocused&&this.focusHandler(this.threadMatch[1],this.threadMatch[2])),this.refreshInterval=setInterval((()=>this.refresh()),6e4))}refresh(){this.watchListMap.size>0&&console.log("refreshing watchlist");for(let e of this.watchListMap.entries()){const[t,s]=e[0].split("-"),a=e[1];this.fetchThread(t,s,a)}}async fetchThread(e,t,s){let a,o;try{a=await fetch(`/${e}/thread/${t}.json`),o=await a.json()}catch(e){}if(o&&o.replies){const a={...s,subject:(o.subject||o.nomarkup||"No subject").substring(0,25)},i=new Date(s.updatedDate),n=o.replies.filter((e=>new Date(e.date)>i));if(n.length>0&&(this.isFocused&&this.threadMatch&&this.threadMatch[1]===e&&this.threadMatch[2]===t?a.unread=0:a.unread+=n.length),a.subject!==s.subject||a.unread!==s.unread){a.updatedDate=new Date;const s=`${e}-${t}`;this.watchListMap.set(s,a),this.updateRow(e,t,a),this.commit()}}else a&&404===a.status&&(console.log("removing 404 thread from watchlist"),this.remove(e,t))}storageEventHandler(e){if(e.storageArea===localStorage&&"watchlist"===e.key){console.log("updating watchlist from another context");const t=new Map(JSON.parse(e.newValue));this.watchListMap.forEach(((e,s)=>{if(!t.has(s)){const[e,t]=s.split("-");this.deleteRow(e,t)}})),t.forEach(((e,t)=>{const[s,a]=t.split("-"),o=this.watchListMap.get(t);o?!o||o.unread===e.unread&&o.subject===e.subject||this.updateRow(s,a,e):this.addRow(s,a,e)})),this.watchListMap=new Map(JSON.parse(e.newValue)),this.setVisibility()}}focusHandler(e,t){this.isFocused=!0;const s=`${e}-${t}`,a=this.watchListMap.get(s);a&&0!==a.unread&&(a.unread=0,a.updatedDate=new Date,this.watchListMap.set(s,a),this.updateRow(e,t,a),this.commit())}blurHandler(){this.isFocused=!1}commit(){const e=[...this.watchListMap];setLocalStorage("watchlist",JSON.stringify(e)),this.settingsInput.value=e,this.setVisibility()}toggleMinimise(){this.minimised=!this.minimised,this.minimiseButton.textContent=this.minimised?"[+]":"[âˆ’]",this.threadWatcher.classList.toggle("minimised"),setLocalStorage("threadwatcher-minimise",this.minimised)}setVisibility(){this.threadWatcher&&(this.threadWatcher.style.display=0===this.watchListMap.size?"none":null)}createList(){const e=threadwatcher({minimised:this.minimised});this.footer.insertAdjacentHTML("afterend",e),this.threadWatcher=document.getElementById("threadwatcher"),0===this.watchListMap.size&&(this.threadWatcher.style.display="none"),new Dragable("#threadwatcher-dragHandle","#threadwatcher");for(let e of this.watchListMap.entries()){const[t,s]=e[0].split("-"),a=e[1];this.addRow(t,s,a)}}add(e,t,s){const a=`${e}-${t}`;this.watchListMap.has(a)||(this.watchListMap.set(a,s),this.addRow(e,t,s),this.commit())}remove(e,t){this.deleteRow(e,t),this.watchListMap.delete(`${e}-${t}`),this.commit()}clear(){for(let e of this.watchListMap.entries()){const[t,s]=e[0].split("-"),a=e[1];this.deleteRow(t,s,a)}this.watchListMap=new Map,this.commit()}addRow(e,t,s){const a=null!=this.threadMatch&&this.threadMatch[1]===e&&this.threadMatch[2]===t,o=watchedthread({watchedthread:{board:e,postId:t,...s,isCurrentThread:a}});this.threadWatcher.insertAdjacentHTML("beforeend",o);this.threadWatcher.lastChild.querySelector(".close").addEventListener("click",(()=>this.remove(e,t)))}deleteRow(e,t){this.threadWatcher.querySelector(`[data-id="${e}-${t}"]`).remove()}updateRow(e,t,s){const a=this.threadWatcher.querySelector(`[data-id="${e}-${t}"]`);0===s.unread?a.removeAttribute("data-unread"):a.setAttribute("data-unread",s.unread),a.children[1].textContent=`/${e}/ - ${s.subject}`}}const threadWatcher=new ThreadWatcher;window.addEventListener("settingsReady",(()=>{threadWatcher.init()})),isCatalog&&window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("catalogfilter");e.value="";e.addEventListener("input",(()=>{for(let e=0;e<renderSheet[rulesKey].length;e++)if(renderSheet[rulesKey][e].selectorText.startsWith(".catalog-tile:not([data-filter*=")){renderSheet.deleteRule(e);break}e.value.length>0&&renderSheet.insertRule(`.catalog-tile:not([data-filter*="${e.value.replace(/["\\]/g,"\\$&").toLowerCase()}"]) { display: none; }`)}),!1);const t={date:(e,t)=>new Date(t.dataset.date)-new Date(e.dataset.date),bump:(e,t)=>e.dataset.bump-t.dataset.bump,replies:(e,t)=>t.dataset.replies-e.dataset.replies},s=document.getElementsByClassName("catalog-tile"),a=document.getElementById("catalogsort");a.value="";a.addEventListener("change",(e=>{var a;a=e.target.value,console.log("sorting catalog",a),Array.from(s).sort(t[a]||(()=>1)).forEach(((e,t)=>{e.style.order=t}))}),!1)}));let relativeTime="true"==localStorage.getItem("relative"),hour24="true"==localStorage.getItem("24hour"),localTime="true"==localStorage.getItem("localtime"),dates=[];const dateElems=document.getElementsByClassName("reltime");for(let e=0;e<dateElems.length;e++)dates.push(dateElems[e]);const YEAR=31536e6,MONTH=2592e6,WEEK=6048e5,DAY=864e5,HOUR=36e5,MINUTE=6e4,relativeTimeString=e=>{let t=Date.now()-new Date(e).getTime(),s=0,a="",o=!1;return t<0&&(t=Math.abs(t),o=!0),t<6e4?"Now":(t<357e4?(s=Math.round(t/6e4),a=`${s} minute`):t<846e5?(s=Math.round(t/HOUR),a=`${s} hour`):t<6.5*DAY?(s=Math.round(t/DAY),a=`${s} day`):t<3.5*WEEK?(s=Math.round(t/WEEK),a=`${s} week`):t<11.5*MONTH?(s=Math.round(t/MONTH),a=`${s} month`):(s=Math.round(t/YEAR),a=`${s} year`),`${a}${s>1?"s":""} ${o?"from now":"ago"}`)},changeDateFormat=e=>{const t={hour12:!hour24};localTime||(t.timeZone=SERVER_TIMEZONE);const s=hour24?"en-US-u-hc-h23":"en-US",a=new Date(e.dateTime).toLocaleString(s,t);relativeTime?(e.innerText=relativeTimeString(e.dateTime),e.title=a):(e.innerText=a,e.removeAttribute("title"))},updateDates=()=>{for(let e=0;e<dates.length;e++)changeDateFormat(dates[e])};updateDates(),window.addEventListener("settingsReady",(function(){let e=relativeTime?setInterval(updateDates,6e4):void 0;const t=document.getElementById("24hour-setting");t.checked=hour24,t.addEventListener("change",(()=>{hour24=!hour24,setLocalStorage("24hour",hour24),updateDates(),console.log("toggling 24h time",hour24)}),!1);const s=document.getElementById("localtime-setting");s.checked=localTime,s.addEventListener("change",(()=>{localTime=!localTime,setLocalStorage("localtime",localTime),updateDates(),console.log("toggling local time",localTime)}),!1);const a=document.getElementById("relative-setting");a.checked=relativeTime,a.addEventListener("change",(()=>{relativeTime=!relativeTime,setLocalStorage("relative",relativeTime),updateDates(),relativeTime?e=setInterval(updateDates,6e4):clearInterval(e),console.log("toggling relative time",relativeTime)}),!1)}));const handleDateUpdates=(e,t=!1)=>{const s=e.querySelectorAll(".reltime");for(let e of s)t||dates.push(e),changeDateFormat(e)};window.addEventListener("addPost",(function(e){handleDateUpdates(e.detail.post,e.detail.hover)})),window.addEventListener("showModal",(function(e){handleDateUpdates(e.detail.modal)}));