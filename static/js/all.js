const themes=["56chan","adaptive","amoled","army-green","cancer","chaos","choc","clear","darkblue","gurochan","iwakura","lain","miku","mushroom","navy","pink","rei-zero","robot","solarized-dark","solarized-light","tchan","tempus-cozette","tomorrow","tomorrow2","vapor","win95","yotsuba-b","yotsuba"],codeThemes=["a11y-dark","a11y-light","agate","an-old-hope","androidstudio","arduino-light","arta","ascetic","atom-one-dark-reasonable","atom-one-dark","atom-one-light","brown-paper","codepen-embed","color-brewer","dark","default","devibeans","docco","far","felipec","foundation","github-dark-dimmed","github-dark","github","gml","googlecode","gradient-dark","gradient-light","grayscale","hybrid","idea","intellij-light","ir-black","isbl-editor-dark","isbl-editor-light","kimbie-dark","kimbie-light","lightfair","lioshi","magula","mono-blue","monokai-sublime","monokai","night-owl","nnfx-dark","nnfx-light","nord","obsidian","paraiso-dark","paraiso-light","pojoaque","purebasic","qtcreator-dark","qtcreator-light","rainbow","routeros","school-book","shades-of-purple","srcery","stackoverflow-dark","stackoverflow-light","sunburst","tokyo-night-dark","tokyo-night-light","tomorrow-night-blue","tomorrow-night-bright","vs","vs2015","xcode","xt256"],captchaType="text",captchaGridSize=4,SERVER_TIMEZONE="America/Toronto",settings={embedsEnabled:!0,heightUnlimit:!1,hideRecursive:!0,crispImages:!1,hideThumbnails:!1,nonColorIds:!1,alwaysShowSpoilers:!1,hidePostStubs:!1,smoothScrolling:!0,threadWatcher:!0,defaultVolume:100,loop:!0,imageLoadingBars:!0,live:!0,scrollToPosts:!1,localTime:!0,hour24Time:!1,relativeTime:!0,notificationsEnabled:!1,notificationsYousOnly:!0,showYous:!0,hideDeletedPostContent:!1,tegakiWidth:500,tegakiHeight:500},extraLocals={meta:{siteName:"",url:""},reverseImageLinksURL:"https://tineye.com/search?url=%s"},isCatalog=/^\/(\w+\/(manage\/)?)?catalog.html/.test(window.location.pathname),isThread=/\/\w+\/thread\/\d+.html/.test(window.location.pathname),isModView=/\/\w+\/manage\/(thread\/)?(index|\d+).html/.test(window.location.pathname),isManage=/\/(\w+\/manage|globalmanage)\/(recent|reports|bans|boards|logs|settings|banners|accounts|news|custompages).html/.test(window.location.pathname),isGlobalRecent="/globalmanage/recent.html"===window.location.pathname,isRecent=isGlobalRecent||window.location.pathname.endsWith("/manage/recent.html");function setLocalStorage(e,t){try{localStorage.setItem(e,t)}catch(e){deleteStartsWith()}finally{localStorage.setItem(e,t)}}function appendLocalStorageArray(e,t){const a=JSON.parse(localStorage.getItem(e));a.push(t),setLocalStorage(e,JSON.stringify(a))}function deleteStartsWith(e="hovercache"){const t=Object.keys(localStorage).filter((t=>t.startsWith(e)));for(let e=0;e<t.length;e++)localStorage.removeItem(t[e])}function setDefaultLocalStorage(e,t){localStorage.getItem(e)||setLocalStorage(e,t)}const localStorageDefaults={volume:settings.defaultVolume,loop:settings.loop,imageloadingbars:settings.imageLoadingBars,live:settings.live,scroll:settings.scrollToPosts,localtime:settings.localTime,relative:settings.relativeTime,"24hour":settings.hour24Time,notifications:settings.notificationsEnabled,"notification-yous-only":settings.notificationsYousOnly,"yous-setting":settings.showYous,threadwatcher:settings.threadWatcher,"threadwatcher-minimise":!1,disableboardcss:!1,"tegakiwidth-setting":settings.tegakiWidth,"tegakiheight-setting":settings.tegakiHeight,filters1:"[]",yous:"[]",watchlist:"[]",name:"",theme:"default",codetheme:"default",customcss:"",overboardsettings:'{"add":"","rem":"","include_default":true}'};function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_classes(e,t){return Array.isArray(e)?pug_classes_array(e,t):e&&"object"==typeof e?pug_classes_object(e):e||""}function pug_classes_array(e,t){for(var a,i="",s="",n=Array.isArray(t),o=0;o<e.length;o++)(a=pug_classes(e[o]))&&(n&&t[o]&&(a=pug_escape(a)),i=i+s+a,s=" ");return i}function pug_classes_object(e){var t="",a="";for(var i in e)i&&e[i]&&pug_has_own_property.call(e,i)&&(t=t+a+i,a=" ");return t}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}Object.entries(localStorageDefaults).map((e=>setDefaultLocalStorage(e[0],e[1])));var pug_has_own_property=Object.prototype.hasOwnProperty,pug_match_html=/["&<>]/;function pug_style(e){if(!e)return"";if("object"==typeof e){var t="";for(var a in e)pug_has_own_property.call(e,a)&&(t=t+a+":"+e[a]+";");return t}return e+""}function modal(e){var t,a="",i={},s=e||{};return function(e,s,n,o,r,l,c,d,p,h,u,g,f,m,y,k){i.report=t=function(i,s=!1){this&&this.block,this&&this.attributes;a=a+'<div class="reports post-container"><input class="post-check" type="checkbox" name="checkedreports"'+pug_attr("value",i.id,!0,!1)+"/> ";const n=!0===k?i.ip.raw:i.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`${s?"recent.html":""}?ip=${c(n)}`,!0,!1)+">["+pug_escape(null==(t=n)?"":t)+"]</a> ";const o=new e(i.date);a=a+'<time class="reltime"'+pug_attr("datetime",o.toISOString(),!0,!1)+">"+pug_escape(null==(t=o.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> | Reason: "+pug_escape(null==(t=i.reason)?"":t)+"</div>"},i.post=t=function(o,r,l=!1,d=!1,p=!1,u=!1){this&&this.block,this&&this.attributes;a=a+'<div class="anchor"'+pug_attr("id",o.postId,!0,!1)+"></div><div"+(pug_attr("class",pug_classes(["post-container "+(o.thread||!0===p?"":"op")],[!0]),!1,!1)+pug_attr("data-board",o.board,!0,!1)+pug_attr("data-post-id",o.postId,!0,!1)+pug_attr("data-user-id",o.userId,!0,!1)+pug_attr("data-name",o.name,!0,!1)+pug_attr("data-tripcode",o.tripcode,!0,!1)+pug_attr("data-subject",o.subject,!0,!1)+pug_attr("data-email",o.email,!0,!1))+">";const g=`/${o.board}/${f||l||d?"manage/":""}thread/${o.thread||o.postId}.html`;if(a+='<div class="post-info"><span><label>',u||(d?a=a+'<input class="post-check" type="checkbox" name="globalcheckedposts"'+pug_attr("value",o._id,!0,!1)+"/>":p||(a=a+'<input class="post-check" type="checkbox" name="checkedposts"'+pug_attr("value",o.postId,!0,!1)+"/>"),a+=" "),l){const e=!0===k?o.ip.raw:o.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`${y?"../":""}recent.html?ip=${c(e)}`,!0,!1)+">["+pug_escape(null==(t=e)?"":t)+"]</a>"}else if(f)a=a+'<a class="bold"'+pug_attr("href",`${y?"../":""}recent.html?postid=${o.postId}`,!0,!1)+">[+]</a>";else if(d){const e=!0===k?o.ip.raw:o.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`?ip=${c(e)}`,!0,!1)+">["+pug_escape(null==(t=e)?"":t)+"]</a>"}a+=" ",o.thread||(o.sticky||o.bumplocked||o.locked||o.cyclic)&&(a+='<span class="post-icons">',o.sticky&&(a=a+'<img src="/file/sticky.png" height="14" width="14"'+pug_attr("title",`Sticky (${o.sticky})`,!0,!1)+"/> "),o.bumplocked&&(a+='<img src="/file/bumplock.png" height="14" width="14" title="Bumplocked"/> '),o.locked&&(a+='<img src="/file/lock.png" height="14" width="14" title="Locked"/> '),o.cyclic&&(a+='<img src="/file/cyclic.png" height="14" width="14" title="Cyclic"/> '),a+="</span>"),o.subject&&(a=a+'<span class="post-subject">'+pug_escape(null==(t=o.subject)?"":t)+"</span> "),a=o.email?a+'<a class="post-name"'+pug_attr("href",`mailto:${o.email}`,!0,!1)+">"+pug_escape(null==(t=o.name)?"":t)+"</a>":a+'<span class="post-name">'+pug_escape(null==(t=o.name)?"":t)+"</span>",a+=" </label>",o.country&&o.country.code&&(a=!0===o.country.custom?a+"<span"+pug_attr("title",o.country.name,!0,!1)+'><img class="customflag"'+pug_attr("src",`/flag/${o.board}/${o.country.src}`,!0,!1)+' alt=" " loading="lazy"/></span> ':a+"<span"+(pug_attr("class",pug_classes([`flag flag-${o.country.code.toLowerCase()}`],[!0]),!1,!1)+pug_attr("title",o.country.name,!0,!1)+pug_attr("alt",o.country.name,!0,!1))+"></span> "),o.tripcode&&(a=a+'<span class="post-tripcode">'+pug_escape(null==(t=o.tripcode)?"":t)+"</span> "),o.capcode&&(a=a+'<span class="post-capcode">'+pug_escape(null==(t=o.capcode)?"":t)+"</span> ");const v=new e(o.date);a=a+'<time class="post-date reltime"'+pug_attr("datetime",v.toISOString(),!0,!1)+">"+pug_escape(null==(t=v.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> ",o.userId&&(a=a+'<span class="user-id"'+pug_attr("style",pug_style(`background-color: #${o.userId}`),!0,!1)+">"+pug_escape(null==(t=o.userId)?"":t)+"</span> "),a=a+'</span><span class="post-links"><a class="noselect no-decoration"'+pug_attr("href",`${g}#${o.postId}`,!0,!1)+'>No.</a><span class="post-quoters"><a class="no-decoration"'+pug_attr("href",`${g}#postform`,!0,!1)+">"+pug_escape(null==(t=o.postId)?"":t)+"</a></span> ",!o.thread&&(r||l||d)&&(a=a+' <span class="noselect"><a'+pug_attr("href",`${g}`,!0,!1)+">[Open]</a></span>"),a+='<select class="jsonly postmenu"><option value="single">Hide</option>',o.userId&&(a+='<option value="fid">Filter ID</option>'),o.name&&(a+='<option value="fname">Filter Name</option>'),o.subject&&(a+='<option value="fsub">Filter Subject</option>'),o.tripcode&&(a+='<option value="ftrip">Filter Tripcode</option>'),u||p||(a+='<option value="moderate">Moderate</option>'),o.thread||(a+='<option value="watch">Watch</option>'),a+='</select></span></div><div class="post-data">',o.files.length>0&&(a=a+"<div"+pug_attr("class",pug_classes(["post-files",o.files.length>1?"fn":""],[!1,!0]),!1,!1)+">",function(){var e=o.files;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var r=e[i];a+='<div class="post-file">';const s=r.mimetype.split("/")[0];a=a+'<span class="post-file-info"><span><a class="filename"'+pug_attr("href","/file/"+r.filename,!0,!1)+pug_attr("title","Download "+r.originalFilename,!0,!1)+pug_attr("download",r.originalFilename,!0,!1)+">"+pug_escape(null==(t=o.spoiler||r.spoiler?"Spoiler File":r.originalFilename)?"":t)+"</a></span><br/>",d&&null!=r.phash&&(a=a+"<span>"+pug_escape(null==(t=r.phash)?"":t)+"</span><br/>"),r.attachment||o.spoiler||r.spoiler||(a=a+'<span class="jsonly"><b>[</b><a class="dummy-link hide-image noselect"'+pug_attr("data-src",`/file/${r.hasThumb?"thumb/"+r.hash+r.thumbextension:r.filename}`,!0,!1)+">Hide</a><b>]</b></span>"),a=a+"<span>  ("+pug_escape(null==(t=r.sizeString)?"":t),r.geometryString&&(a=a+", "+pug_escape(null==(t=r.geometryString)?"":t)),r.durationString&&(a=a+", "+pug_escape(null==(t=r.durationString)?"":t)),a+=")</span>","image"===s&&(n&&!0===n.settings.reverseImageSearchLinks||u||l||d)&&(a=a+" <span><a"+pug_attr("href",`${m.replace("%s",c(h.url+"/file/"+r.filename))}`,!0,!1)+' rel="nofollow" referrerpolicy="same-origin" title="Reverse Image Search" target="_blank">Reverse</a></span>'),a=a+'</span><div class="post-file-src"'+pug_attr("data-type",s,!0,!1)+pug_attr("data-attachment",r.attachment?"true":"false",!0,!1)+'><a target="_blank"'+pug_attr("href",`/file/${r.filename}`,!0,!1)+">",o.spoiler||r.spoiler?a+='<div class="spoilerimg file-thumb"></div>':r.hasThumb?a=a+'<img class="file-thumb"'+pug_attr("src",`/file/thumb/${r.hash}${r.thumbextension}`,!0,!1)+pug_attr("height",r.geometry.thumbheight,!0,!1)+pug_attr("width",r.geometry.thumbwidth,!0,!1)+' loading="lazy"/>':r.attachment?a=a+'<div class="attachmentimg file-thumb"'+pug_attr("data-mimetype",r.mimetype,!0,!1)+"></div>":"audio"===s?a+='<div class="audioimg file-thumb"></div>':a=a+'<img class="file-thumb"'+pug_attr("src",`/file/${r.filename}`,!0,!1)+pug_attr("height",r.geometry.height,!0,!1)+pug_attr("width",r.geometry.width,!0,!1)+' loading="lazy"/>',a+="</a></div></div>"}else{s=0;for(var i in e){s++;r=e[i];a+='<div class="post-file">';const p=r.mimetype.split("/")[0];a=a+'<span class="post-file-info"><span><a class="filename"'+pug_attr("href","/file/"+r.filename,!0,!1)+pug_attr("title","Download "+r.originalFilename,!0,!1)+pug_attr("download",r.originalFilename,!0,!1)+">"+pug_escape(null==(t=o.spoiler||r.spoiler?"Spoiler File":r.originalFilename)?"":t)+"</a></span><br/>",d&&null!=r.phash&&(a=a+"<span>"+pug_escape(null==(t=r.phash)?"":t)+"</span><br/>"),r.attachment||o.spoiler||r.spoiler||(a=a+'<span class="jsonly"><b>[</b><a class="dummy-link hide-image noselect"'+pug_attr("data-src",`/file/${r.hasThumb?"thumb/"+r.hash+r.thumbextension:r.filename}`,!0,!1)+">Hide</a><b>]</b></span>"),a=a+"<span>  ("+pug_escape(null==(t=r.sizeString)?"":t),r.geometryString&&(a=a+", "+pug_escape(null==(t=r.geometryString)?"":t)),r.durationString&&(a=a+", "+pug_escape(null==(t=r.durationString)?"":t)),a+=")</span>","image"===p&&(n&&!0===n.settings.reverseImageSearchLinks||u||l||d)&&(a=a+" <span><a"+pug_attr("href",`${m.replace("%s",c(h.url+"/file/"+r.filename))}`,!0,!1)+' rel="nofollow" referrerpolicy="same-origin" title="Reverse Image Search" target="_blank">Reverse</a></span>'),a=a+'</span><div class="post-file-src"'+pug_attr("data-type",p,!0,!1)+pug_attr("data-attachment",r.attachment?"true":"false",!0,!1)+'><a target="_blank"'+pug_attr("href",`/file/${r.filename}`,!0,!1)+">",o.spoiler||r.spoiler?a+='<div class="spoilerimg file-thumb"></div>':r.hasThumb?a=a+'<img class="file-thumb"'+pug_attr("src",`/file/thumb/${r.hash}${r.thumbextension}`,!0,!1)+pug_attr("height",r.geometry.thumbheight,!0,!1)+pug_attr("width",r.geometry.thumbwidth,!0,!1)+' loading="lazy"/>':r.attachment?a=a+'<div class="attachmentimg file-thumb"'+pug_attr("data-mimetype",r.mimetype,!0,!1)+"></div>":"audio"===p?a+='<div class="audioimg file-thumb"></div>':a=a+'<img class="file-thumb"'+pug_attr("src",`/file/${r.filename}`,!0,!1)+pug_attr("height",r.geometry.height,!0,!1)+pug_attr("width",r.geometry.width,!0,!1)+' loading="lazy"/>',a+="</a></div></div>"}}}.call(this),a+="</div>"),o.message&&f&&(o.message=o.message.replace(new s(`<a class="quote" href="/${o.board}/`,"g"),`<a class="quote" href="/${o.board}/manage/`));let T=o.message;if(o.message)if(r){const e=o.message.split("\n");if(e.length>15)T=e.slice(0,15).join("\n");else if(o.message.length>1500){T=o.message.substring(0,1500).replace(/<([\w]+)?([^>]*)?$/,"");const e=T.lastIndexOf("<a"),t=T.lastIndexOf("</a>");e>=0&&(-1===t||t<e)&&(T+="</a>")}a=a+'<pre class="post-message">'+(null==(t=T)?"":t)+"</pre>"}else a=a+'<pre class="post-message">'+(null==(t=o.message)?"":t)+"</pre>";if(o.message||0!==o.files.length||(a+="<p>No message or files.</p>"),o.edited){const i=new e(o.edited.date);a=a+'<small class="cb mt-5 ml-5 edited">Last edited <time class="reltime"'+pug_attr("datetime",i.toISOString(),!0,!1)+">"+pug_escape(null==(t=i.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> by "+pug_escape(null==(t=o.edited.username)?"":t)+"</small>"}if(o.banmessage&&(a=a+'<p class="ban"><span class="message">USER WAS BANNED FOR THIS POST</span> <span class="reason"'+pug_attr("data-reason",o.banmessage,!0,!1)+">"+pug_escape(null==(t=o.banmessage)?"":t)+"</span></p>"),T!==o.message&&(a=a+'<div class="cb mt-5 ml-5">Message too long. <a class="viewfulltext"'+pug_attr("href",`${g}#${o.postId}`,!0,!1)+">View the full text</a></div>"),o.omittedposts||o.omittedfiles){a=a+'<div class="cb mt-5 ml-5"><img class="jsonly dummy-link expand-omitted" height="12" width="12"'+pug_attr("data-shown",o.replies.length,!0,!1)+pug_attr("data-board",o.board,!0,!1)+pug_attr("data-thread",o.postId,!0,!1)+' src="/file/plus.png"/>';const e=o.omittedposts,i=o.omittedfiles;a=a+"<span>"+pug_escape(null==(t=e)?"":t)+" repl"+pug_escape(null==(t=e>1?"ies":"y")?"":t)+"\n"+pug_escape(null==(t=i>0?` and ${i} file${i>1?"s":""}`:"")?"":t)+" omitted. </span><a"+pug_attr("href",g,!0,!1)+">View the full thread</a></div>"}if(null!=o.previewbacklinks){if(o.previewbacklinks.length>0){if(a+='<div class="replies mt-5 ml-5">Replies: ',function(){var e=o.previewbacklinks;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${g}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}else{s=0;for(var i in e){s++;n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${g}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}}}.call(this),o.previewbacklinks.length<o.backlinks.length){const e=o.backlinks.length-o.previewbacklinks.length;a=a+"+ <a"+pug_attr("href",`${g}#${o.postId}`,!0,!1)+">"+pug_escape(null==(t=e)?"":t)+" earlier</a>\n "}a+="</div>"}}else o.backlinks&&o.backlinks.length>0&&(a+='<div class="replies mt-5 ml-5">Replies: ',function(){var e=o.backlinks;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${g}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}else{s=0;for(var i in e){s++;n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${g}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}}}.call(this),a+="</div>");a+="</div></div>",!0===l&&function(){var e=o.reports;if("number"==typeof e.length)for(var t=0,a=e.length;t<a;t++){var s=e[t];i.report(s,!0)}else{a=0;for(var t in e){a++;s=e[t];i.report(s,!0)}}}.call(this),!0===d&&function(){var e=o.globalreports;if("number"==typeof e.length)for(var t=0,a=e.length;t<a;t++){var s=e[t];i.report(s)}else{a=0;for(var t in e){a++;s=e[t];i.report(s)}}}.call(this)},i.ban=t=function(s,n){this&&this.block,this&&this.attributes;a+="<tr><td>",(!n||null==s.appeal&&!0===s.allowAppeal)&&(a=a+'<input class="post-check" type="checkbox" name="checkedbans"'+pug_attr("value",s._id,!0,!1)+"/>"),a+="</td><td>",s.board?a=a+"<a"+pug_attr("href",`/${s.board}/`,!0,!1)+">/"+pug_escape(null==(t=s.board)?"":t)+"/</a>":a+="Global",a=a+"</td><td>"+pug_escape(null==(t=s.reason)?"":t)+"</td>";const o=!0===k?s.ip.raw:s.ip.cloak;a=(a=!0===k?a+"<td>"+pug_escape(null==(t=o)?"":t)+"</td>":a+"<td>"+pug_escape(null==(t=o)?"":t)+pug_escape(null==(t=".*".repeat(s.range))?"":t)+"</td>")+"<td>"+pug_escape(null==(t=0===s.type?"IP":1===s.type?"Bypass":"Pruned IP")?"":t)+"</td><td>"+pug_escape(null==(t=0===s.range?"Single":1===s.range?"Narrow":"Wide")?"":t)+"</td><td>"+pug_escape(null==(t=n&&!0!==s.showUser?"Hidden User":s.issuer)?"":t)+"</td>";const r=new e(s.date);a=a+'<td><time class="right reltime"'+pug_attr("datetime",r.toISOString(),!0,!1)+">"+pug_escape(null==(t=r.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time></td>";const l=new e(s.expireAt);a=a+'<td><time class="right reltime"'+pug_attr("datetime",l.toISOString(),!0,!1)+">"+pug_escape(null==(t=l.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+'</time></td><td class="banposts">',s.posts&&s.posts.length>0?(a+='Hover to view<div class="thread">',function(){var e=s.posts;if("number"==typeof e.length)for(var t=0,a=e.length;t<a;t++){var n=e[t];i.post(n,!1,!1,!1,!0)}else{a=0;for(var t in e){a++;n=e[t];i.post(n,!1,!1,!1,!0)}}}.call(this),a+="</div>"):a+="<Posts>not shown</Posts>",a+="</td><td>",s.seen?a+="&#10003;":a+="&#10799;",a+="</td><td>",s.allowAppeal&&!s.appeal?a+="&#10003;":a+="&#10799;",a+="</td><td>",s.appeal?a=a+'<textarea rows="1" disabled="true">'+pug_escape(null==(t=s.appeal)?"":t)+"</textarea>":s.allowAppeal?a+="No appeal submitted":a+="-",a+="</td></tr>"},i.modal=t=function(e){this&&this.block,this&&this.attributes;if(a=a+'<div class="modal-bg"'+pug_attr("style",pug_style(e.hidden?"display:none":""),!0,!1)+'></div><div class="modal"'+pug_attr("id",e.settings?"settingsmodal":"",!0,!1)+pug_attr("style",pug_style(e.hidden?"display:none":""),!0,!1)+'><div class="row"><p class="bold">'+pug_escape(null==(t=e.title)?"":t)+'</p><a class="close postform-style" id="modalclose">×</a></div>',e.bans){a+='<h1 class="board-title">Banned!</h1><div class="row" id="modalbanned">';const t=e.bans;a+='<form class="form-post" action="/forms/appeal" enctype="application/x-www-form-urlencoded" method="POST" data-captcha-preload="true"><div class="table-container mv-10 text-center horscroll"><table class="bantable"><tr><th></th><th>Board</th><th>Reason</th><th>IP/ID</th><th>Type</th><th>Range</th><th>Issuer</th><th>Issue Date</th><th>Expiry</th><th>Post(s)</th><th>Seen?</th><th>Appealable?</th><th>Appeal',function(){var e=t;if("number"==typeof e.length)for(var a=0,s=e.length;a<s;a++){var n=e[a];i.ban(n,!0)}else{s=0;for(var a in e){s++;n=e[a];i.ban(n,!0)}}}.call(this),a+="</th></tr></table></div>";if(!0===t.filter((e=>!0===e.allowAppeal&&!e.appeal)).length>0){if(a=a+'<h4 class="no-m-p">Appeal:<div class="form-wrapper flexleft mt-10"><input type="hidden" name="_csrf"'+pug_attr("value",l,!0,!1)+'/><div class="row"><div class="label">Message</div><textarea rows="5" name="message"'+pug_attr("required",!0,!0,!1)+"></textarea></div>","text"===r){switch(a+='<section class="row"><div class="label"><span>Captcha<span class="required">*</span></span></div><div class="col">',r){case"google":a=a+'<div class="g-recaptcha"'+pug_attr("data-sitekey",`${d}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"hcaptcha":a=a+'<div class="h-captcha"'+pug_attr("data-sitekey",`${p}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"text":a=a+'<noscript class="no-m-p"><iframe class="captcha" src="/captcha.html"'+pug_attr("width=210",!0,!0,!1)+' height="80" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none;"></div><input class="captchafield" type="text" name="captcha" autocomplete="off" placeholder="Captcha text" pattern=".{6}"'+pug_attr("required",!0,!0,!1)+' title="6 characters"/>';break;case"grid":u||(a+='<a class="text-center" href="/faq.html#captcha">Instructions</a>'),a+='<div class="catalog"><noscript class="no-m-p"><iframe class="captcha" src="/captcha.html" width="150" height="150" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none"></div><div class="captchafield noselect">';for(let e=0;e<o**2;e++)a=a+'<label class="captchachecklabel"><input type="checkbox" name="captcha"'+pug_attr("value",e,!0,!1)+'/><span class="captchacheckbox"></span></label>';a+="</div></div>"}a+="</div></section>"}else{switch(a+='<div class="row label mr-0"><div class="pv-5">Captcha<span class="required">*</span></div>',r){case"google":a=a+'<div class="g-recaptcha"'+pug_attr("data-sitekey",`${d}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"hcaptcha":a=a+'<div class="h-captcha"'+pug_attr("data-sitekey",`${p}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"text":a=a+'<noscript class="no-m-p"><iframe class="captcha" src="/captcha.html"'+pug_attr("width=210",!0,!0,!1)+' height="80" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none;"></div><input class="captchafield" type="text" name="captcha" autocomplete="off" placeholder="Captcha text" pattern=".{6}"'+pug_attr("required",!0,!0,!1)+' title="6 characters"/>';break;case"grid":u||(a+='<a class="text-center" href="/faq.html#captcha">Instructions</a>'),a+='<div class="catalog"><noscript class="no-m-p"><iframe class="captcha" src="/captcha.html" width="150" height="150" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none"></div><div class="captchafield noselect">';for(let e=0;e<o**2;e++)a=a+'<label class="captchachecklabel"><input type="checkbox" name="captcha"'+pug_attr("value",e,!0,!1)+'/><span class="captchacheckbox"></span></label>';a+="</div></div>"}a+="</div>"}a+='<input type="submit" value="submit"/></div></h4>'}a+="</form></div>"}(e.message||e.messages||e.error||e.errors)&&(a+='<div class="row"><ul class="nomarks">',e.message&&(a=a+"<li>"+pug_escape(null==(t=e.message)?"":t)+"</li>"),e.error&&(a=a+"<li>"+pug_escape(null==(t=e.error)?"":t)+"</li>"),e.messages&&function(){var i=e.messages;if("number"==typeof i.length)for(var s=0,n=i.length;s<n;s++){var o=i[s];a=a+"<li>"+pug_escape(null==(t=o)?"":t)+"</li>"}else{n=0;for(var s in i){n++;o=i[s];a=a+"<li>"+pug_escape(null==(t=o)?"":t)+"</li>"}}}.call(this),e.errors&&function(){var i=e.errors;if("number"==typeof i.length)for(var s=0,n=i.length;s<n;s++){var o=i[s];a=a+"<li>"+pug_escape(null==(t=o)?"":t)+"</li>"}else{n=0;for(var s in i){n++;o=i[s];a=a+"<li>"+pug_escape(null==(t=o)?"":t)+"</li>"}}}.call(this),a+="</ul></div>"),e.frame?a=a+'<div class="row f1"><iframe class="bypass" id="modalframe"'+pug_attr("src",e.frame,!0,!1)+' frameborder="0" scrolling="no"></iframe></div>':e.link?a=a+'<div class="row"><a class="button mv-0"'+pug_attr("href",e.link.href,!0,!1)+' target="_blank">'+pug_escape(null==(t=e.link.text)?"":t)+"</a></div>":e.redirect&&"Success"===e.title?a=a+'<div class="row"><a class="button mv-0"'+pug_attr("href",e.redirect,!0,!1)+">OK</a></div>":e.settings&&(a+='<div class="row"><div class="form-wrapper flexleft mt-10"><div class="row wrap sb"><div class="col mr-5"><div class="row"><label class="postform-style ph-5"><input id="live-setting" type="checkbox"/></label><div class="rlabel">Live posts</div></div><div class="row"><label class="postform-style ph-5"><input id="notification-setting" type="checkbox"/></label><div class="rlabel">Notifications</div></div><div class="row"><label class="postform-style ph-5"><input id="notification-yous-only" type="checkbox"/></label><div class="rlabel">Only notify (You)s</div></div><div class="row"><label class="postform-style ph-5"><input id="scroll-setting" type="checkbox"/></label><div class="rlabel">Scroll to new posts</div></div><div class="row"><label class="postform-style ph-5"><input id="localtime-setting" type="checkbox"/></label><div class="rlabel">Local time</div></div><div class="row"><label class="postform-style ph-5"><input id="24hour-setting" type="checkbox"/></label><div class="rlabel">24h time</div></div><div class="row"><label class="postform-style ph-5"><input id="relative-setting" type="checkbox"/></label><div class="rlabel">Show relative time</div></div><div class="row"><label class="postform-style ph-5"><input id="noncolorids-setting" type="checkbox"/></label><div class="rlabel">Non-color IDs</div></div><div class="row"><label class="postform-style ph-5"><input id="hidepoststubs-setting" type="checkbox"/></label><div class="rlabel">Hide post stubs</div></div><div class="row"><label class="postform-style ph-5"><input id="hidedeletedpostcontent-setting" type="checkbox"/></label><div class="rlabel">Hide deleted post content</div></div><div class="row"><label class="postform-style ph-5"><input id="disableboardcss-setting" type="checkbox"/></label><div class="rlabel">Disable board custom CSS</div></div></div><div class="col"><div class="row"><label class="postform-style ph-5"><input id="hidethumbnails-setting" type="checkbox"/></label><div class="rlabel">Hide thumbnails</div></div><div class="row"><label class="postform-style ph-5"><input id="hiderecursive-setting" type="checkbox"/></label><div class="rlabel">Recursive post hide</div></div><div class="row"><label class="postform-style ph-5"><input id="loop-setting" type="checkbox"/></label><div class="rlabel">Loop audio/video</div></div><div class="row"><label class="postform-style ph-5"><input id="heightlimit-setting" type="checkbox"/></label><div class="rlabel">Unlimit media height</div></div><div class="row"><label class="postform-style ph-5"><input id="crispimages-setting" type="checkbox"/></label><div class="rlabel">Crisp image rendering</div></div><div class="row"><label class="postform-style ph-5"><input id="imageloadingbars-setting" type="checkbox"/></label><div class="rlabel">Image loading bars</div></div><div class="row"><label class="postform-style ph-5"><input id="alwaysshowspoilers-setting" type="checkbox"/></label><div class="rlabel">Always reveal text spoilers</div></div><div class="row"><label class="postform-style ph-5"><input id="yous-setting" type="checkbox"/></label><div class="rlabel">Show (You)s</div></div><div class="row"><label class="postform-style ph-5"><input id="smoothscrolling-setting" type="checkbox"/></label><div class="rlabel">Smooth scrolling</div></div><div class="row"><label class="postform-style ph-5"><input id="threadwatcher-setting" type="checkbox"/></label><div class="rlabel">Thread watcher</div></div></div></div><div class="row wrap sb mt-5"><div class="col mr-5"><div class="row"><div class="label">Video/Audio volume</div><label class="postform-style ph-5"><input id="volume-setting" type="range" min="0" max="100"/></label></div><div class="row"><div class="label">Default name</div><input id="name-setting" type="text" name="name"/></div><div class="row"><div class="label">Post password</div><input id="postpassword-setting" type="password" name="postpassword" autocomplete="new-password"/></div><div class="row"><div class="label">Theme</div><select id="theme-setting"><option value="default">default</option>',function(){var i=e.settings.themes;if("number"==typeof i.length)for(var s=0,n=i.length;s<n;s++){var o=i[s];a=a+"<option"+pug_attr("value",o,!0,!1)+">"+pug_escape(null==(t=o)?"":t)+"</option>"}else{n=0;for(var s in i){n++;o=i[s];a=a+"<option"+pug_attr("value",o,!0,!1)+">"+pug_escape(null==(t=o)?"":t)+"</option>"}}}.call(this),a+='</select></div><div class="row"><div class="label">Code theme</div><select id="codetheme-setting"><option value="default">default</option>',function(){var i=e.settings.codeThemes;if("number"==typeof i.length)for(var s=0,n=i.length;s<n;s++){var o=i[s];a=a+"<option"+pug_attr("value",o,!0,!1)+">"+pug_escape(null==(t=o)?"":t)+"</option>"}else{n=0;for(var s in i){n++;o=i[s];a=a+"<option"+pug_attr("value",o,!0,!1)+">"+pug_escape(null==(t=o)?"":t)+"</option>"}}}.call(this),a=a+'</select></div></div><div class="col"><div class="row"><div class="label">(You)s</div><input class="mr-1" id="youslist-setting" type="text"'+pug_attr("readonly",!0,!0,!1)+'/><input id="youslist-clear" type="button" value="Clear"/></div><div class="row"><div class="label">Watchlist</div><input class="mr-1" id="watchlist-setting" type="text"'+pug_attr("readonly",!0,!0,!1)+'/><input id="watchlist-clear" type="button" value="Clear"/></div><div class="row"><div class="label">Hidden images</div><input class="mr-1" id="hiddenimages-setting" type="text"'+pug_attr("readonly",!0,!0,!1)+'/><input id="hiddenimages-clear" type="button" value="Clear"/></div><div class="row"><div class="label">Cache</div><input class="mr-1" id="hovercachelist-setting" type="text"'+pug_attr("readonly",!0,!0,!1)+'/><input id="hovercachelist-clear" type="button" value="Clear"/></div><div class="row"><div class="label">Tegaki Size</div><input class="mr-1 w50" id="tegakiwidth-setting" type="number"/><div class="postform-style ph-5 mr-1">× </div><input class="mr-1 w50" id="tegakiheight-setting" type="number"/></div></div></div><div class="row mt-5"><div class="label">Custom CSS</div><textarea id="customcss-setting" rows="7"></textarea></div><div class="row mt-5"><form class="text-center" id="filter-form"><table class="fw"><tbody id="advancedfilters"><tr><th colspan="4">Post Filters</th></tr><tr><td>Type</td><td>Value</td><td>Regex?</td><td><input class="right" id="filters-clear" type="button" value="Clear"/></td></tr><tr><td><select name="type"><option value="fname">Name</option><option value="ftrip">Tripcode</option><option value="fsub">Subject</option><option value="fmsg">Message</option></select></td><td><input id="filter-value-input"'+pug_attr("required",!0,!0,!1)+' type="text" name="value"/></td><td><input type="checkbox" name="regex"/></td><td><input class="right" type="submit" value="Add"/></td></tr></tbody></table></form></div><div class="row mt-5"><div class="label">Import/Export Settings<small class="title">Do NOT import untrusted settings data!</small><small>Export does not include post password or (You)\'s</small></div><textarea id="import-export-setting" type="text"></textarea></div><div class="row"><input class="mr-1" id="export-setting" type="button" value="Export"/><input id="import-setting" type="button" value="Import"/></div></div></div>'),a+="</div>"},i.modal(g)}.call(this,"Date"in s?s.Date:"undefined"!=typeof Date?Date:void 0,"RegExp"in s?s.RegExp:"undefined"!=typeof RegExp?RegExp:void 0,"board"in s?s.board:"undefined"!=typeof board?board:void 0,"captchaGridSize"in s?s.captchaGridSize:4,"captchaType"in s?s.captchaType:"text","csrf"in s?s.csrf:"undefined"!=typeof csrf?csrf:void 0,"encodeURIComponent"in s?s.encodeURIComponent:"undefined"!=typeof encodeURIComponent?encodeURIComponent:void 0,"googleRecaptchaSiteKey"in s?s.googleRecaptchaSiteKey:"undefined"!=typeof googleRecaptchaSiteKey?googleRecaptchaSiteKey:void 0,"hcaptchaSiteKey"in s?s.hcaptchaSiteKey:"undefined"!=typeof hcaptchaSiteKey?hcaptchaSiteKey:void 0,"meta"in s?s.meta:"undefined"!=typeof meta?meta:void 0,"minimal"in s?s.minimal:"undefined"!=typeof minimal?minimal:void 0,"modal"in s?s.modal:void 0!==modal?modal:void 0,"modview"in s?s.modview:"undefined"!=typeof modview?modview:void 0,"reverseImageLinksURL"in s?s.reverseImageLinksURL:"undefined"!=typeof reverseImageLinksURL?reverseImageLinksURL:void 0,"upLevel"in s?s.upLevel:"undefined"!=typeof upLevel?upLevel:void 0,"viewRawIp"in s?s.viewRawIp:"undefined"!=typeof viewRawIp?viewRawIp:void 0),a}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}pug_match_html=/["&<>]/;function pugfilters(e){var t,a="",i={},s=e||{};return function(e){i.filters=t=function(e){this&&this.block,this&&this.attributes;const i={single:"Single",fid:"ID",fname:"Name",ftrip:"Tripcode",fnamer:"Name",ftripr:"Tripcode",fsub:"Subject",fsubr:"Subject",fmsg:"Message",fmsgr:"Message"};e.length>0?function(){var s=e;if("number"==typeof s.length)for(var n=0,o=s.length;n<o;n++){var r=s[n];a=a+"<tr><td>"+pug_escape(null==(t=i[r.type])?"":t)+"</td><td>"+pug_escape(null==(t=r.val.toString())?"":t)+"</td><td><input"+pug_attr("disabled",!0,!0,!1)+' type="checkbox"'+pug_attr("checked",r.type.endsWith("r"),!0,!1)+'/></td><td><a class="right close"'+pug_attr("data-type",r.type,!0,!1)+pug_attr("data-data",r.val,!0,!1)+">×</a></td></tr>"}else{o=0;for(var n in s){o++;r=s[n];a=a+"<tr><td>"+pug_escape(null==(t=i[r.type])?"":t)+"</td><td>"+pug_escape(null==(t=r.val.toString())?"":t)+"</td><td><input"+pug_attr("disabled",!0,!0,!1)+' type="checkbox"'+pug_attr("checked",r.type.endsWith("r"),!0,!1)+'/></td><td><a class="right close"'+pug_attr("data-type",r.type,!0,!1)+pug_attr("data-data",r.val,!0,!1)+">×</a></td></tr>"}}}.call(this):a+='<td colspan="4">No Filters</td>'},i.filters(e)}.call(this,"filterArr"in s?s.filterArr:"undefined"!=typeof filterArr?filterArr:void 0),a}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_classes(e,t){return Array.isArray(e)?pug_classes_array(e,t):e&&"object"==typeof e?pug_classes_object(e):e||""}function pug_classes_array(e,t){for(var a,i="",s="",n=Array.isArray(t),o=0;o<e.length;o++)(a=pug_classes(e[o]))&&(n&&t[o]&&(a=pug_escape(a)),i=i+s+a,s=" ");return i}function pug_classes_object(e){var t="",a="";for(var i in e)i&&e[i]&&pug_has_own_property.call(e,i)&&(t=t+a+i,a=" ");return t}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}pug_has_own_property=Object.prototype.hasOwnProperty,pug_match_html=/["&<>]/;function pug_style(e){if(!e)return"";if("object"==typeof e){var t="";for(var a in e)pug_has_own_property.call(e,a)&&(t=t+a+":"+e[a]+";");return t}return e+""}function post(e){var t,a="",i={},s=e||{};return function(e,s,n,o,r,l,c,d,p,h,u,g){i.report=t=function(i,s=!1){this&&this.block,this&&this.attributes;a=a+'<div class="reports post-container"><input class="post-check" type="checkbox" name="checkedreports"'+pug_attr("value",i.id,!0,!1)+"/> ";const n=!0===g?i.ip.raw:i.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`${s?"recent.html":""}?ip=${o(n)}`,!0,!1)+">["+pug_escape(null==(t=n)?"":t)+"]</a> ";const r=new e(i.date);a=a+'<time class="reltime"'+pug_attr("datetime",r.toISOString(),!0,!1)+">"+pug_escape(null==(t=r.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> | Reason: "+pug_escape(null==(t=i.reason)?"":t)+"</div>"},i.post=t=function(r,l,p=!1,f=!1,m=!1,y=!1){this&&this.block,this&&this.attributes;a=a+'<div class="anchor"'+pug_attr("id",r.postId,!0,!1)+"></div><div"+(pug_attr("class",pug_classes(["post-container "+(r.thread||!0===m?"":"op")],[!0]),!1,!1)+pug_attr("data-board",r.board,!0,!1)+pug_attr("data-post-id",r.postId,!0,!1)+pug_attr("data-user-id",r.userId,!0,!1)+pug_attr("data-name",r.name,!0,!1)+pug_attr("data-tripcode",r.tripcode,!0,!1)+pug_attr("data-subject",r.subject,!0,!1)+pug_attr("data-email",r.email,!0,!1))+">";const k=`/${r.board}/${d||p||f?"manage/":""}thread/${r.thread||r.postId}.html`;if(a+='<div class="post-info"><span><label>',y||(f?a=a+'<input class="post-check" type="checkbox" name="globalcheckedposts"'+pug_attr("value",r._id,!0,!1)+"/>":m||(a=a+'<input class="post-check" type="checkbox" name="checkedposts"'+pug_attr("value",r.postId,!0,!1)+"/>"),a+=" "),p){const e=!0===g?r.ip.raw:r.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`${u?"../":""}recent.html?ip=${o(e)}`,!0,!1)+">["+pug_escape(null==(t=e)?"":t)+"]</a>"}else if(d)a=a+'<a class="bold"'+pug_attr("href",`${u?"../":""}recent.html?postid=${r.postId}`,!0,!1)+">[+]</a>";else if(f){const e=!0===g?r.ip.raw:r.ip.cloak;a=a+'<a class="bold"'+pug_attr("href",`?ip=${o(e)}`,!0,!1)+">["+pug_escape(null==(t=e)?"":t)+"]</a>"}a+=" ",r.thread||(r.sticky||r.bumplocked||r.locked||r.cyclic)&&(a+='<span class="post-icons">',r.sticky&&(a=a+'<img src="/file/sticky.png" height="14" width="14"'+pug_attr("title",`Sticky (${r.sticky})`,!0,!1)+"/> "),r.bumplocked&&(a+='<img src="/file/bumplock.png" height="14" width="14" title="Bumplocked"/> '),r.locked&&(a+='<img src="/file/lock.png" height="14" width="14" title="Locked"/> '),r.cyclic&&(a+='<img src="/file/cyclic.png" height="14" width="14" title="Cyclic"/> '),a+="</span>"),r.subject&&(a=a+'<span class="post-subject">'+pug_escape(null==(t=r.subject)?"":t)+"</span> "),a=r.email?a+'<a class="post-name"'+pug_attr("href",`mailto:${r.email}`,!0,!1)+">"+pug_escape(null==(t=r.name)?"":t)+"</a>":a+'<span class="post-name">'+pug_escape(null==(t=r.name)?"":t)+"</span>",a+=" </label>",r.country&&r.country.code&&(a=!0===r.country.custom?a+"<span"+pug_attr("title",r.country.name,!0,!1)+'><img class="customflag"'+pug_attr("src",`/flag/${r.board}/${r.country.src}`,!0,!1)+' alt=" " loading="lazy"/></span> ':a+"<span"+(pug_attr("class",pug_classes([`flag flag-${r.country.code.toLowerCase()}`],[!0]),!1,!1)+pug_attr("title",r.country.name,!0,!1)+pug_attr("alt",r.country.name,!0,!1))+"></span> "),r.tripcode&&(a=a+'<span class="post-tripcode">'+pug_escape(null==(t=r.tripcode)?"":t)+"</span> "),r.capcode&&(a=a+'<span class="post-capcode">'+pug_escape(null==(t=r.capcode)?"":t)+"</span> ");const v=new e(r.date);a=a+'<time class="post-date reltime"'+pug_attr("datetime",v.toISOString(),!0,!1)+">"+pug_escape(null==(t=v.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> ",r.userId&&(a=a+'<span class="user-id"'+pug_attr("style",pug_style(`background-color: #${r.userId}`),!0,!1)+">"+pug_escape(null==(t=r.userId)?"":t)+"</span> "),a=a+'</span><span class="post-links"><a class="noselect no-decoration"'+pug_attr("href",`${k}#${r.postId}`,!0,!1)+'>No.</a><span class="post-quoters"><a class="no-decoration"'+pug_attr("href",`${k}#postform`,!0,!1)+">"+pug_escape(null==(t=r.postId)?"":t)+"</a></span> ",!r.thread&&(l||p||f)&&(a=a+' <span class="noselect"><a'+pug_attr("href",`${k}`,!0,!1)+">[Open]</a></span>"),a+='<select class="jsonly postmenu"><option value="single">Hide</option>',r.userId&&(a+='<option value="fid">Filter ID</option>'),r.name&&(a+='<option value="fname">Filter Name</option>'),r.subject&&(a+='<option value="fsub">Filter Subject</option>'),r.tripcode&&(a+='<option value="ftrip">Filter Tripcode</option>'),y||m||(a+='<option value="moderate">Moderate</option>'),r.thread||(a+='<option value="watch">Watch</option>'),a+='</select></span></div><div class="post-data">',r.files.length>0&&(a=a+"<div"+pug_attr("class",pug_classes(["post-files",r.files.length>1?"fn":""],[!1,!0]),!1,!1)+">",function(){var e=r.files;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var l=e[i];a+='<div class="post-file">';const s=l.mimetype.split("/")[0];a=a+'<span class="post-file-info"><span><a class="filename"'+pug_attr("href","/file/"+l.filename,!0,!1)+pug_attr("title","Download "+l.originalFilename,!0,!1)+pug_attr("download",l.originalFilename,!0,!1)+">"+pug_escape(null==(t=r.spoiler||l.spoiler?"Spoiler File":l.originalFilename)?"":t)+"</a></span><br/>",f&&null!=l.phash&&(a=a+"<span>"+pug_escape(null==(t=l.phash)?"":t)+"</span><br/>"),l.attachment||r.spoiler||l.spoiler||(a=a+'<span class="jsonly"><b>[</b><a class="dummy-link hide-image noselect"'+pug_attr("data-src",`/file/${l.hasThumb?"thumb/"+l.hash+l.thumbextension:l.filename}`,!0,!1)+">Hide</a><b>]</b></span>"),a=a+"<span>  ("+pug_escape(null==(t=l.sizeString)?"":t),l.geometryString&&(a=a+", "+pug_escape(null==(t=l.geometryString)?"":t)),l.durationString&&(a=a+", "+pug_escape(null==(t=l.durationString)?"":t)),a+=")</span>","image"===s&&(n&&!0===n.settings.reverseImageSearchLinks||y||p||f)&&(a=a+" <span><a"+pug_attr("href",`${h.replace("%s",o(c.url+"/file/"+l.filename))}`,!0,!1)+' rel="nofollow" referrerpolicy="same-origin" title="Reverse Image Search" target="_blank">Reverse</a></span>'),a=a+'</span><div class="post-file-src"'+pug_attr("data-type",s,!0,!1)+pug_attr("data-attachment",l.attachment?"true":"false",!0,!1)+'><a target="_blank"'+pug_attr("href",`/file/${l.filename}`,!0,!1)+">",r.spoiler||l.spoiler?a+='<div class="spoilerimg file-thumb"></div>':l.hasThumb?a=a+'<img class="file-thumb"'+pug_attr("src",`/file/thumb/${l.hash}${l.thumbextension}`,!0,!1)+pug_attr("height",l.geometry.thumbheight,!0,!1)+pug_attr("width",l.geometry.thumbwidth,!0,!1)+' loading="lazy"/>':l.attachment?a=a+'<div class="attachmentimg file-thumb"'+pug_attr("data-mimetype",l.mimetype,!0,!1)+"></div>":"audio"===s?a+='<div class="audioimg file-thumb"></div>':a=a+'<img class="file-thumb"'+pug_attr("src",`/file/${l.filename}`,!0,!1)+pug_attr("height",l.geometry.height,!0,!1)+pug_attr("width",l.geometry.width,!0,!1)+' loading="lazy"/>',a+="</a></div></div>"}else{s=0;for(var i in e){s++;l=e[i];a+='<div class="post-file">';const d=l.mimetype.split("/")[0];a=a+'<span class="post-file-info"><span><a class="filename"'+pug_attr("href","/file/"+l.filename,!0,!1)+pug_attr("title","Download "+l.originalFilename,!0,!1)+pug_attr("download",l.originalFilename,!0,!1)+">"+pug_escape(null==(t=r.spoiler||l.spoiler?"Spoiler File":l.originalFilename)?"":t)+"</a></span><br/>",f&&null!=l.phash&&(a=a+"<span>"+pug_escape(null==(t=l.phash)?"":t)+"</span><br/>"),l.attachment||r.spoiler||l.spoiler||(a=a+'<span class="jsonly"><b>[</b><a class="dummy-link hide-image noselect"'+pug_attr("data-src",`/file/${l.hasThumb?"thumb/"+l.hash+l.thumbextension:l.filename}`,!0,!1)+">Hide</a><b>]</b></span>"),a=a+"<span>  ("+pug_escape(null==(t=l.sizeString)?"":t),l.geometryString&&(a=a+", "+pug_escape(null==(t=l.geometryString)?"":t)),l.durationString&&(a=a+", "+pug_escape(null==(t=l.durationString)?"":t)),a+=")</span>","image"===d&&(n&&!0===n.settings.reverseImageSearchLinks||y||p||f)&&(a=a+" <span><a"+pug_attr("href",`${h.replace("%s",o(c.url+"/file/"+l.filename))}`,!0,!1)+' rel="nofollow" referrerpolicy="same-origin" title="Reverse Image Search" target="_blank">Reverse</a></span>'),a=a+'</span><div class="post-file-src"'+pug_attr("data-type",d,!0,!1)+pug_attr("data-attachment",l.attachment?"true":"false",!0,!1)+'><a target="_blank"'+pug_attr("href",`/file/${l.filename}`,!0,!1)+">",r.spoiler||l.spoiler?a+='<div class="spoilerimg file-thumb"></div>':l.hasThumb?a=a+'<img class="file-thumb"'+pug_attr("src",`/file/thumb/${l.hash}${l.thumbextension}`,!0,!1)+pug_attr("height",l.geometry.thumbheight,!0,!1)+pug_attr("width",l.geometry.thumbwidth,!0,!1)+' loading="lazy"/>':l.attachment?a=a+'<div class="attachmentimg file-thumb"'+pug_attr("data-mimetype",l.mimetype,!0,!1)+"></div>":"audio"===d?a+='<div class="audioimg file-thumb"></div>':a=a+'<img class="file-thumb"'+pug_attr("src",`/file/${l.filename}`,!0,!1)+pug_attr("height",l.geometry.height,!0,!1)+pug_attr("width",l.geometry.width,!0,!1)+' loading="lazy"/>',a+="</a></div></div>"}}}.call(this),a+="</div>"),r.message&&d&&(r.message=r.message.replace(new s(`<a class="quote" href="/${r.board}/`,"g"),`<a class="quote" href="/${r.board}/manage/`));let T=r.message;if(r.message)if(l){const e=r.message.split("\n");if(e.length>15)T=e.slice(0,15).join("\n");else if(r.message.length>1500){T=r.message.substring(0,1500).replace(/<([\w]+)?([^>]*)?$/,"");const e=T.lastIndexOf("<a"),t=T.lastIndexOf("</a>");e>=0&&(-1===t||t<e)&&(T+="</a>")}a=a+'<pre class="post-message">'+(null==(t=T)?"":t)+"</pre>"}else a=a+'<pre class="post-message">'+(null==(t=r.message)?"":t)+"</pre>";if(r.message||0!==r.files.length||(a+="<p>No message or files.</p>"),r.edited){const i=new e(r.edited.date);a=a+'<small class="cb mt-5 ml-5 edited">Last edited <time class="reltime"'+pug_attr("datetime",i.toISOString(),!0,!1)+">"+pug_escape(null==(t=i.toLocaleString(void 0,{hourCycle:"h23"}))?"":t)+"</time> by "+pug_escape(null==(t=r.edited.username)?"":t)+"</small>"}if(r.banmessage&&(a=a+'<p class="ban"><span class="message">USER WAS BANNED FOR THIS POST</span> <span class="reason"'+pug_attr("data-reason",r.banmessage,!0,!1)+">"+pug_escape(null==(t=r.banmessage)?"":t)+"</span></p>"),T!==r.message&&(a=a+'<div class="cb mt-5 ml-5">Message too long. <a class="viewfulltext"'+pug_attr("href",`${k}#${r.postId}`,!0,!1)+">View the full text</a></div>"),r.omittedposts||r.omittedfiles){a=a+'<div class="cb mt-5 ml-5"><img class="jsonly dummy-link expand-omitted" height="12" width="12"'+pug_attr("data-shown",r.replies.length,!0,!1)+pug_attr("data-board",r.board,!0,!1)+pug_attr("data-thread",r.postId,!0,!1)+' src="/file/plus.png"/>';const e=r.omittedposts,i=r.omittedfiles;a=a+"<span>"+pug_escape(null==(t=e)?"":t)+" repl"+pug_escape(null==(t=e>1?"ies":"y")?"":t)+"\n"+pug_escape(null==(t=i>0?` and ${i} file${i>1?"s":""}`:"")?"":t)+" omitted. </span><a"+pug_attr("href",k,!0,!1)+">View the full thread</a></div>"}if(null!=r.previewbacklinks){if(r.previewbacklinks.length>0){if(a+='<div class="replies mt-5 ml-5">Replies: ',function(){var e=r.previewbacklinks;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${k}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}else{s=0;for(var i in e){s++;n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${k}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}}}.call(this),r.previewbacklinks.length<r.backlinks.length){const e=r.backlinks.length-r.previewbacklinks.length;a=a+"+ <a"+pug_attr("href",`${k}#${r.postId}`,!0,!1)+">"+pug_escape(null==(t=e)?"":t)+" earlier</a>\n "}a+="</div>"}}else r.backlinks&&r.backlinks.length>0&&(a+='<div class="replies mt-5 ml-5">Replies: ',function(){var e=r.backlinks;if("number"==typeof e.length)for(var i=0,s=e.length;i<s;i++){var n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${k}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}else{s=0;for(var i in e){s++;n=e[i];a=a+'<a class="quote"'+pug_attr("href",`${k}#${n.postId}`,!0,!1)+">&gt;&gt;"+pug_escape(null==(t=n.postId)?"":t)+"</a> "}}}.call(this),a+="</div>");a+="</div></div>",!0===p&&function(){var e=r.reports;if("number"==typeof e.length)for(var t=0,a=e.length;t<a;t++){var s=e[t];i.report(s,!0)}else{a=0;for(var t in e){a++;s=e[t];i.report(s,!0)}}}.call(this),!0===f&&function(){var e=r.globalreports;if("number"==typeof e.length)for(var t=0,a=e.length;t<a;t++){var s=e[t];i.report(s)}else{a=0;for(var t in e){a++;s=e[t];i.report(s)}}}.call(this)},i.post(p,!1,l,r)}.call(this,"Date"in s?s.Date:"undefined"!=typeof Date?Date:void 0,"RegExp"in s?s.RegExp:"undefined"!=typeof RegExp?RegExp:void 0,"board"in s?s.board:"undefined"!=typeof board?board:void 0,"encodeURIComponent"in s?s.encodeURIComponent:"undefined"!=typeof encodeURIComponent?encodeURIComponent:void 0,"globalmanage"in s?s.globalmanage:"undefined"!=typeof globalmanage?globalmanage:void 0,"manage"in s?s.manage:"undefined"!=typeof manage?manage:void 0,"meta"in s?s.meta:"undefined"!=typeof meta?meta:void 0,"modview"in s?s.modview:"undefined"!=typeof modview?modview:void 0,"post"in s?s.post:void 0!==post?post:void 0,"reverseImageLinksURL"in s?s.reverseImageLinksURL:"undefined"!=typeof reverseImageLinksURL?reverseImageLinksURL:void 0,"upLevel"in s?s.upLevel:"undefined"!=typeof upLevel?upLevel:void 0,"viewRawIp"in s?s.viewRawIp:"undefined"!=typeof viewRawIp?viewRawIp:void 0),a}window.addEventListener("DOMContentLoaded",(()=>{let e,t;const a=()=>{e.style.display="none",t.style.display="none"},i=()=>{e.style.display="unset",t.style.display="unset"},s=modal({modal:{title:"Settings",settings:{themes:themes,codeThemes:codeThemes},hidden:!0}});document.body.insertAdjacentHTML("afterbegin",s),t=document.getElementsByClassName("modal-bg")[0],e=document.getElementsByClassName("modal")[0],t.onclick=a,e.getElementsByClassName("close")[0].onclick=a;const n=document.getElementById("settings");n&&(n.onclick=i),window.dispatchEvent(new CustomEvent("settingsReady"))}));let socket,socketPingInterval,forceUpdate,newPost,liveEnabled="true"==localStorage.getItem("live"),scrollEnabled="true"==localStorage.getItem("scroll");window.addEventListener("settingsReady",(function(){let e="WebSocket"in window||"MozWebSocket"in window;const t=document.getElementById("livecolor"),a=document.getElementById("livetext"),i=(isThread||isRecent)&&a?a.childNodes[1]:null;let s=a&&a.dataset.room;const n=a&&"true"===a.dataset.viewRawIp,o=document.getElementById("updatepostsbutton"),r=(e,a)=>{t.style.backgroundColor=a,i.nodeValue=`${e}`};let l,c={};const d=document.getElementsByClassName("post-container");for(let e=0;e<d.length;e++){const t=d[e],{board:a,postId:i}=t.dataset;c[a]=Math.max(c[a]||0,i)}const p=e=>{console.log("got mark post message",e);const t=document.getElementById(e.postId).nextSibling;switch(t.classList.add("marked"),t.setAttribute("data-mark",e.mark),e.type){case"delete":case"move":if(t.classList.contains("op")){const t=document.getElementsByClassName("post-container");Array.from(t).forEach((t=>{t.classList.add("marked"),t.setAttribute("data-mark",e.mark)})),document.getElementById("postform").remove();const a=document.getElementsByClassName("post-button");Array.from(a).forEach((e=>e.remove())),!0===socket.connected&&socket.disconnect()}}};newPost=(e,t={})=>{const a=e;c[a.board]=a.postId;const i=post({viewRawIp:n,post:a,modview:isModView,manage:isRecent&&!isGlobalRecent,globalmanage:isGlobalRecent,upLevel:isThread,...extraLocals});let s;if(t.insertPoint)s=t.insertPoint;else if(isRecent){const e=document.querySelector("hr"),t=document.createElement("hr"),a=document.createElement("div");a.classList.add("thread"),s=a,e.insertAdjacentElement("beforebegin",t),t.insertAdjacentElement("afterend",a)}else s=document.querySelector(".thread");s.insertAdjacentHTML(t.insertPosition||"beforeend",i),isRecent&&Array.from(document.querySelectorAll(".thread")).slice(20).forEach((e=>{e.previousSibling.remove(),e.remove()}));for(let e=0;e<a.quotes.length;e++){const t=a.quotes[e],i=document.querySelector(`.post-container[data-post-id="${t.postId}"][data-board="${a.board}"]`);if(i){let e=i.querySelector(".replies");if(!e){const t=i.querySelector(".post-data"),a=document.createElement("div");a.textContent="Replies: ",a.classList.add("replies","mt-5","ml-5"),t.appendChild(a),e=a}if(new RegExp(`>>${a.postId}(\\s|$)`).test(e.innerText))continue;const t=document.createElement("a"),s=document.createTextNode(" ");t.href=`/${a.board}/${isModView||isRecent?"manage/":""}thread/${a.thread||a.postId}.html#${a.postId}`,t.textContent=`>>${a.postId}`,t.classList.add("quote"),e.appendChild(t),e.appendChild(s)}}const o=document.getElementById(a.postId),r=o.nextSibling;scrollEnabled&&(isGlobalRecent?window.scrollTo(0,0):o.scrollIntoView());const l=new CustomEvent("addPost",{detail:{nonotify:t.nonotify,post:r,postId:a.postId,json:a}});setTimeout((()=>{window.dispatchEvent(l)}),50)};let h,u=window.location.pathname.replace(/\.html$/,".json").split("/");isModView&&u.splice(2,1),h=u.join("/");const g=async()=>{let e;console.log("fetching posts from api"),r("Fetching posts...","yellow");let t=[];try{e=await fetch(h).then((e=>e.json()))}catch(e){console.error(e)}const a=e&&e.replies?e.replies:e;if(a&&Array.isArray(a)&&a.length>0&&(t=a.filter((e=>e.postId>(c[e.board]||0))),t.length>0))for(let e=0;e<t.length;e++)newPost(t[e]);return r("Updated","green"),t.length};let f,m=5e3;forceUpdate=async()=>{o.disabled=!0,clearTimeout(l),m=await g()>0?5e3:Math.min(2*m,9e4),setTimeout((()=>{o.disabled=!1}),1e4),liveEnabled&&(f=Date.now(),l=setTimeout(forceUpdate,m))},setInterval((()=>{if(liveEnabled&&f){const e=Math.abs((m-(Date.now()-f))/1e3);o.value=`Update (${e.toFixed(0)}s)`}}),1e3);const y=()=>{if(e){if(o.style.display="none",!s){const e=window.location.pathname.replace(/\.html$/,"").split("/");s=`${e[1]}-${e[e.length-1]}`}socket=io({transports:["websocket"],reconnectionAttempts:3,reconnectionDelay:3e3,reconnectionDelayMax:15e3});const t=()=>{const e=Date.now();socket.volatile.emit("ping",(()=>{const t=Date.now()-e;r(`Connected for live posts (${t}ms)`,"#0de600")}))};socket.on("connect",(async()=>{console.log("socket connected"),await g(),socket.emit("room",s),clearInterval(socketPingInterval),socketPingInterval=setInterval(t,2e4)})),socket.on("message",(e=>{console.log(e,s),"joined"===e&&(r("Connected for live posts","#0de600"),t())})),socket.on("reconnect_attempt",(()=>{r("Attempting to reconnect...","yellow")})),socket.on("disconnect",(()=>{console.log("lost connection to room"),r("Disconnected","red")})),socket.on("reconnect",(()=>{console.log("reconnected to room"),g()})),socket.on("error",(e=>{r("Socket error","orange"),console.error(e)})),socket.on("connect_error",(e=>{r("Error connecting","orange"),console.error(e)})),socket.on("reconnect_error",(e=>{r("Error reconnecting","orange"),console.error(e)})),socket.on("reconnect_failed",(t=>{r("Failed reconnecting","orange"),console.error(t),console.log("failed to reconnnect, falling back to polling"),socket.close(),e=!1,y()})),socket.on("newPost",newPost),socket.on("markPost",p)}else o.removeAttribute("style"),forceUpdate()},k=()=>{o.value="Update",o.removeAttribute("style"),clearTimeout(l),socket&&e&&socket.disconnect(),r("Live posts off","darkgray")},v=document.getElementById("live-setting");v.checked=liveEnabled,v.addEventListener("change",(()=>{liveEnabled=!liveEnabled,liveEnabled?y():k(),console.log("toggling live posts",liveEnabled),setLocalStorage("live",liveEnabled)}),!1);const T=document.getElementById("scroll-setting");T.checked=scrollEnabled,T.addEventListener("change",(()=>{scrollEnabled=!scrollEnabled,console.log("toggling post scrolling",scrollEnabled),setLocalStorage("scroll",scrollEnabled)}),!1),(isThread||isRecent)&&o&&(o.addEventListener("click",forceUpdate),liveEnabled?y():k())}));const captchaCookieRegex=/captchaid=(.[^;]*)/gi;class CaptchaController{constructor(){this.captchaFields=[],this.refreshing=!1}init(){this.captchaFields=document.getElementsByClassName("captchafield"),this.refreshing=!1;for(let e of this.captchaFields)this.setupCaptchaField(e)}captchaAge(){const e=document.cookie.match(captchaCookieRegex);if(!e)return;const t=new URLSearchParams(e[0]).get("captchaid");if(t){const e=new Date(1e3*parseInt(t.slice(0,8),16));return Date.now()-e}}startRefreshTimer(){clearTimeout(this.refreshTimer);const e=this.captchaAge();null!=e&&(console.log("Refreshing captcha in ",3e5-e),this.refreshTimer=setTimeout((()=>{this.refreshCaptchas()}),3e5-e))}setupCaptchaField(e){if("true"==e.closest("form").dataset.captchaPreload)return this.loadCaptcha(e);e.placeholder="focus to load captcha",e.addEventListener("focus",(()=>this.loadCaptcha(e)),{once:!0})}refreshCaptchas(e){if(this.refreshing)return null;this.refreshing=!0,e&&e.target.classList.add("spin");for(let e of document.querySelectorAll('input[name="captcha"]'))e.checked=!1;document.cookie="captchaid=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";const t=new XMLHttpRequest;t.onload=()=>{this.startRefreshTimer();for(let e of this.captchaFields){e.previousSibling.children[0]?e.previousSibling.children[0].src=t.responseURL:this.loadCaptcha(e,t.responseURL)}this.refreshing=!1,e&&e.target.classList.remove("spin")},t.onerror=()=>{this.refreshing=!1,e&&e.target.classList.remove("spin")},t.open("GET","/captcha",!0),t.send(null)}removeCaptcha(){const e=document.getElementById("postform").querySelector(".captcha");if(e){e.closest(".row").remove()}}addMissingCaptcha(){const e=document.getElementById("submitpost"),t=captchaformsection({captchaGridSize:4});e.insertAdjacentHTML("beforebegin",t);const a=e.previousSibling.querySelector(".captchafield");this.loadCaptcha(a)}loadCaptcha(e,t="/captcha"){const a=e.previousSibling;if(a.children.length>0)return;const i=document.createElement("img"),s=document.createElement("div");a.style.display="",i.style.margin="0 auto",i.style.display="flex",s.classList.add("captcharefresh","noselect"),s.addEventListener("click",(e=>this.refreshCaptchas(e)),!0),s.textContent="↻",e.placeholder="loading",i.src=t,i.onload=()=>{e.placeholder="Captcha text",a.appendChild(i),a.appendChild(s),this.startRefreshTimer()}}}const captchaController=new CaptchaController;window.addEventListener("DOMContentLoaded",(()=>{captchaController.init()}));var TegakiStrings={badDimensions:"Invalid dimensions.",promptWidth:"Canvas width in pixels",promptHeight:"Canvas height in pixels",confirmDelLayers:"Delete selected layers?",confirmMergeLayers:"Merge selected layers?",tooManyLayers:"Layer limit reached.",errorLoadImage:"Could not load the image.",noActiveLayer:"No active layer.",hiddenActiveLayer:"The active layer is not visible.",confirmCancel:"Are you sure? Your work will be lost.",confirmChangeCanvas:"Are you sure? Changing the canvas will clear all layers and history and disable replay recording.",color:"Color",size:"Size",alpha:"Opacity",flow:"Flow",zoom:"Zoom",layers:"Layers",switchPalette:"Switch color palette",paletteSlotReplace:"Right click to replace with the current color",layer:"Layer",addLayer:"Add layer",delLayers:"Delete layers",mergeLayers:"Merge layers",moveLayerUp:"Move up",moveLayerDown:"Move down",toggleVisibility:"Toggle visibility",newCanvas:"New",open:"Open",save:"Save",saveAs:"Save As",export:"Export",undo:"Undo",redo:"Redo",close:"Close",finish:"Finish",tip:"Tip",pressure:"Pressure",preserveAlpha:"Preserve Alpha",pen:"Pen",pencil:"Pencil",airbrush:"Airbrush",pipette:"Pipette",blur:"Blur",eraser:"Eraser",bucket:"Bucket",tone:"Tone",gapless:"Gapless",play:"Play",pause:"Pause",rewind:"Rewind",slower:"Slower",faster:"Faster",recordingEnabled:"Recording replay",errorLoadReplay:"Could not load the replay: ",loadingReplay:"Loading replay…"};class TegakiTool{constructor(){this.id=0,this.name=null,this.keybind=null,this.useFlow=!1,this.useSizeDynamics=!1,this.useAlphaDynamics=!1,this.useFlowDynamics=!1,this.usePreserveAlpha=!1,this.step=0,this.size=1,this.alpha=1,this.flow=1,this.useSize=!0,this.useAlpha=!0,this.useFlow=!0,this.noCursor=!1,this.color="#000000",this.rgb=[0,0,0],this.brushSize=0,this.brushAlpha=0,this.brushFlow=0,this.stepSize=0,this.center=0,this.sizeDynamicsEnabled=!1,this.alphaDynamicsEnabled=!1,this.flowDynamicsEnabled=!1,this.preserveAlphaEnabled=!1,this.tip=-1,this.tipList=null,this.stepAcc=0,this.shapeCache=null,this.kernel=null}brushFn(e,t,a,i){}start(e,t){}commit(){}draw(e,t){}usesDynamics(){return this.useSizeDynamics||this.useAlphaDynamics||this.useFlowDynamics}enabledDynamics(){return this.sizeDynamicsEnabled||this.alphaDynamicsEnabled||this.flowDynamicsEnabled}setSize(e){this.size=e}setAlpha(e){this.alpha=e,this.brushAlpha=e}setFlow(e){this.flow=e,this.brushFlow=this.easeFlow(e)}easeFlow(e){return e}setColor(e){this.rgb=$T.hexToRgb(e)}setSizeDynamics(e){this.useSizeDynamics&&(e||this.setSize(this.size),this.sizeDynamicsEnabled=e)}setAlphaDynamics(e){this.useAlphaDynamics&&(e||this.setAlpha(this.alpha),this.alphaDynamicsEnabled=e)}setFlowDynamics(e){this.useFlowDynamics&&(e||this.setFlow(this.flow),this.flowDynamicsEnabled=e)}setPreserveAlpha(e){this.preserveAlphaEnabled=e}set(){this.setAlpha(this.alpha),this.setFlow(this.flow),this.setSize(this.size),this.setColor(Tegaki.toolColor),Tegaki.onToolChanged(this)}}class TegakiBrush extends TegakiTool{constructor(){super()}generateShape(e){}brushFn(e,t,a,i){var s,n,o,r,l,c,d,p,h,u,g,f,m,y,k,v,T,b,w,L,C,S,I,E,x,_,A,$,D;for(D=this.preserveAlphaEnabled,c=this.kernel,A=this.brushAlpha,$=this.brushFlow,_=this.brushSize,s=Tegaki.activeLayer.imageData.data,n=Tegaki.ghostBuffer.data,o=Tegaki.blendBuffer.data,r=Tegaki.baseWidth,l=Tegaki.baseHeight,r,k=this.rgb[0],v=this.rgb[1],T=this.rgb[2],p=0;p<_;++p)if(!((u=t+p+i)<0||u>=l))for(d=0;d<_;++d)(h=e+d+a)<0||h>=r||(f=c[4*(p*_+d)+3]/255)<=0||(y=o[(E=4*(u*r+h))+3]/255,y+=f*$*(A-y),(x=Math.ceil(255*y))>o[E+3]&&(0===o[E]&&(n[E]=s[E],n[E+1]=s[E+1],n[E+2]=s[E+2],n[E+3]=s[E+3]),o[E]=1,o[E+3]=x,C=n[E],S=n[E+1],I=n[E+2],b=(k*y+C*(g=n[E+3]/255)*(1-y))/(m=g+y-g*y),w=(v*y+S*g*(1-y))/m,L=(T*y+I*g*(1-y))/m,s[E]=k>C?Math.ceil(b):Math.floor(b),s[E+1]=v>S?Math.ceil(w):Math.floor(w),s[E+2]=T>I?Math.ceil(L):Math.floor(L),D||(s[E+3]=Math.ceil(255*m))))}generateShapeCache(e){var t,a;if(this.shapeCache||(this.shapeCache=new Array(Tegaki.maxSize)),!this.shapeCache[0]||e)for(t=0;t<Tegaki.maxSize;++t)a=this.generateShape(t+1),this.shapeCache[t]=a,this.setShape(a)}updateDynamics(e){var t,a,i;if(t=TegakiPressure.lerp(e),this.sizeDynamicsEnabled){if(0===(i=Math.ceil(t*this.size)))return!1;a=this.shapeCache[i-1],this.setShape(a)}if(this.alphaDynamicsEnabled){if((i=this.alpha*t)<=0)return!1;this.brushAlpha=i}if(this.flowDynamicsEnabled){if((i=this.flow*t)<=0)return!1;this.brushFlow=this.easeFlow(i)}return!0}start(e,t){var a,i;this.stepAcc=0,this.posX=e,this.posY=t,this.enabledDynamics()&&!this.updateDynamics(1)||(a=e-this.center,i=t-this.center,this.readImageData(a,i,this.brushSize,this.brushSize),this.brushFn(0,0,a,i),this.writeImageData(a,i,this.brushSize,this.brushSize))}commit(){Tegaki.clearBuffers()}draw(e,t){var a,i,s,n,o,r,l,c,d,p,h,u,g,f,m,y,k,v,T,b,w;for(h=this.stepAcc,(s=this.posX)<e?(l=e-s,o=s,a=1):(l=s-e,o=e,a=-1),(n=this.posY)<t?(c=t-n,r=n,i=1):(c=n-t,r=t,i=-1),this.enabledDynamics()&&(f=Math.sqrt((e-s)*(e-s)+(t-n)*(t-n))),this.sizeDynamicsEnabled?(y=(m=this.shapeCache[this.size-1]).center,k=m.brushSize):(y=this.center,k=this.brushSize),o-=y,r-=y,b=l+k,w=c+k,this.readImageData(o,r,b,w),d=(l>c?l:0!==c?-c:0)/2,0!==l&&(l=-l),T=!1,u=s,g=n;h+=Math.max(Math.abs(u-s),Math.abs(g-n)),u=s,g=n,h>=this.stepSize&&(this.enabledDynamics()?(v=f>0?1-Math.sqrt((e-s)*(e-s)+(t-n)*(t-n))/f:0,this.updateDynamics(v)&&(this.brushFn(s-this.center-o,n-this.center-r,o,r),T=!0)):(this.brushFn(s-this.center-o,n-this.center-r,o,r),T=!0),h=0),s!==e||n!==t;)(p=d)>l&&(d-=c,s+=a),p<c&&(d-=l,n+=i);this.stepAcc=h,this.posX=e,this.posY=t,T&&this.writeImageData(o,r,b,w)}writeImageData(e,t,a,i){Tegaki.activeLayer.ctx.putImageData(Tegaki.activeLayer.imageData,0,0,e,t,a,i)}readImageData(e,t,a,i){}setShape(e){this.center=e.center,this.stepSize=e.stepSize,this.brushSize=e.brushSize,this.kernel=e.kernel}setSize(e){this.size=e,this.sizeDynamicsEnabled?this.generateShapeCache():this.setShape(this.generateShape(e))}setSizeDynamics(e){this.useSizeDynamics&&this.sizeDynamicsEnabled!==e&&(e?this.generateShapeCache():this.setShape(this.generateShape(this.size)),this.sizeDynamicsEnabled=e)}setTip(e){this.tipId=e,this.sizeDynamicsEnabled?this.generateShapeCache(!0):this.setShape(this.generateShape(this.size))}}class TegakiPencil extends TegakiBrush{constructor(){super(),this.id=1,this.name="pencil",this.keybind="b",this.step=.01,this.useFlow=!1,this.size=1,this.alpha=1,this.useSizeDynamics=!0,this.useAlphaDynamics=!0,this.usePreserveAlpha=!0}generateShape(e){var t,a,i,s,n,o,r,l,c;for(l=0|e/2,c=0|(e+1)%2,s=new ImageData(e,e),n=new Uint32Array(s.data.buffer),r=4278190080,a=l,i=0,t=1-l,o=l;a>=i;)n[o+a-c+(o+i-c)*e]=r,n[o+i-c+(o+a-c)*e]=r,n[o-i+(o+a-c)*e]=r,n[o-a+(o+i-c)*e]=r,n[o-i+(o-a)*e]=r,n[o-a+(o-i)*e]=r,n[o+i-c+(o-a)*e]=r,n[o+a-c+(o-i)*e]=r,++i,t+=t<=0?2*i+1:2*(i- --a)+1;return l>0&&Tegaki.tools.bucket.fill(s,l,l,this.rgb,1),{center:l,stepSize:Math.ceil(e*this.step),brushSize:e,kernel:s.data}}}class TegakiAirbrush extends TegakiBrush{constructor(){super(),this.id=3,this.name="airbrush",this.keybind="a",this.step=.1,this.size=32,this.alpha=1,this.useSizeDynamics=!0,this.useAlphaDynamics=!0,this.useFlowDynamics=!0,this.usePreserveAlpha=!0}easeFlow(e){return 1-Math.sqrt(1-e)}generateShape(e){var t,a,i,s,n,o,r,l,c,d,p,h;for(a=e,e*=2,i=new ImageData(e,e).data,s=e*e*4,o=Math.sqrt(a*a),l=c=-(r=Math.round(a)),t=0;t<s;)l>=r?(l=-r,++c):((d=l)<0&&(d=-d),(p=c)<0&&(p=-p),(n=Math.sqrt(d*d+p*p))>=o?h=0:0===n?h=255:((h=n/o+.1)>1&&(h=1),h=255*(1-Math.exp(1-1/h)/h)),i[t+3]=h,t+=4,++l);return{center:a,stepSize:Math.ceil(e*this.step),brushSize:e,kernel:i}}}class TegakiPen extends TegakiBrush{constructor(){super(),this.id=2,this.name="pen",this.keybind="p",this.step=.05,this.size=8,this.alpha=1,this.flow=1,this.useSizeDynamics=!0,this.useAlphaDynamics=!0,this.useFlowDynamics=!0,this.usePreserveAlpha=!0}easeFlow(e){return 1-Math.sqrt(1-Math.pow(e,3))}generateShape(e){var t,a,i,s,n,o,r,l,c,d,p,h,u,g,f,m;for(f=Math.floor(e/2)+1,4,16,d=4*(m=e+2),l=Math.floor(d/2),c=Math.floor((d+1)%2),s=new ImageData(d,d),p=new Uint32Array(s.data.buffer),r=1426063360,a=l,i=0,t=1-l,o=l;a>=i;)p[o+a-c+(o+i-c)*d]=r,p[o+i-c+(o+a-c)*d]=r,p[o-i+(o+a-c)*d]=r,p[o-a+(o+i-c)*d]=r,p[o-i+(o-a)*d]=r,p[o-a+(o-i)*d]=r,p[o+i-c+(o-a)*d]=r,p[o+a-c+(o-i)*d]=r,++i,t+=t<=0?2*i+1:2*(i- --a)+1;for(r=4278190080,a=l-3,i=0,t=1-l,o=l;a>=i;)p[o+a-c+(o+i-c)*d]=r,p[o+i-c+(o+a-c)*d]=r,p[o-i+(o+a-c)*d]=r,p[o-a+(o+i-c)*d]=r,p[o-i+(o-a)*d]=r,p[o-a+(o-i)*d]=r,p[o+i-c+(o-a)*d]=r,p[o+a-c+(o-i)*d]=r,++i,t+=t<=0?2*i+1:2*(i- --a)+1;for(l>0&&Tegaki.tools.bucket.fill(s,l,l,this.rgb,1),p=s.data,n=new ImageData(m,m).data,a=0;a<m;++a)for(i=0;i<m;++i){for(h=4*(i*m+a)+3,r=0,u=0;u<4;++u)for(g=0;g<4;++g)r+=p[4*((g+4*i)*d+(u+4*a))+3];n[h]=r/16}return{center:f,stepSize:Math.ceil(e*this.step),brushSize:m,kernel:n}}}class TegakiBucket extends TegakiTool{constructor(){super(),this.id=4,this.name="bucket",this.keybind="g",this.step=100,this.useSize=!1,this.useFlow=!1,this.noCursor=!0}fill(e,t,a,i,s){var n,o,r,l,c,d,p,h,u,g,f,m,y,k,v,T,b,w,L,C,S;for(C=e.width,S=e.height,n=i[0],o=i[1],r=i[2],l=4*(a*C+t),c=(L=e.data)[l],d=L[l+1],p=L[l+2],h=L[l+3],g=new Uint8Array(C*S*4),(u=[])[0]=t,u[1]=a;u.length;){for(v=(f=u.pop())*C,T=(y=f-1)*C,b=(k=f+1)*C,w=m=u.pop();w>=0&&(l=4*(v+w),this.testPixel(L,l,g,c,d,p,h));)this.blendPixel(L,l,n,o,r,s),g[l]=1,y>=0&&(l=4*(T+w),this.testPixel(L,l,g,c,d,p,h)&&(u.push(w),u.push(y))),k<S&&(l=4*(b+w),this.testPixel(L,l,g,c,d,p,h)&&(u.push(w),u.push(k))),w--;for(w=m+1;w<C&&(l=4*(v+w),this.testPixel(L,l,g,c,d,p,h));)this.blendPixel(L,l,n,o,r,s),g[l]=1,y>=0&&(l=4*(T+w),this.testPixel(L,l,g,c,d,p,h)&&(u.push(w),u.push(y))),k<S&&(l=4*(b+w),this.testPixel(L,l,g,c,d,p,h)&&(u.push(w),u.push(k))),++w}}brushFn(e,t){e<0||t<0||e>=Tegaki.baseWidth||t>=Tegaki.baseHeight||(this.fill(Tegaki.activeLayer.imageData,e,t,this.rgb,this.alpha),Tegaki.activeLayer.ctx.putImageData(Tegaki.activeLayer.imageData,0,0))}blendPixel(e,t,a,i,s,n){var o,r,l,c,d,p,h,u;o=e[t],r=e[t+1],l=e[t+2],d=(a*n+o*(c=e[t+3]/255)*(1-n))/(u=c+n-c*n),p=(i*n+r*c*(1-n))/u,h=(s*n+l*c*(1-n))/u,e[t]=a>o?Math.ceil(d):Math.floor(d),e[t+1]=i>r?Math.ceil(p):Math.floor(p),e[t+2]=s>l?Math.ceil(h):Math.floor(h),e[t+3]=Math.ceil(255*u)}testPixel(e,t,a,i,s,n,o){return!a[t]&&e[t]==i&&e[++t]==s&&e[++t]==n&&e[++t]==o}start(e,t){this.brushFn(e,t)}draw(e,t){this.brushFn(e,t)}setSize(e){}}class TegakiTone extends TegakiPencil{constructor(){super(),this.id=5,this.name="tone",this.keybind="t",this.step=.01,this.useFlow=!1,this.size=8,this.alpha=.5,this.useSizeDynamics=!0,this.useAlphaDynamics=!0,this.usePreserveAlpha=!0,this.matrix=[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]],this.mapCache=null,this.mapWidth=0,this.mapHeight=0}start(e,t){this.mapWidth===Tegaki.baseWidth&&this.mapHeight===Tegaki.baseHeight||this.generateMapCache(!0),super.start(e,t)}brushFn(e,t,a,i){var s,n,o,r,l,c,d,p,h,u,g,f,m,y;if(s=Tegaki.activeLayer.imageData.data,m=Tegaki.baseWidth,y=Tegaki.baseHeight,n=this.kernel,o=this.brushSize,this.mapWidth,c=this.preserveAlphaEnabled,!((l=Math.round(16*this.brushAlpha)-1)<0))for(r=this.mapCache[l],u=0;u<o;++u)if(!((f=t+u+i)<0||f>=y))for(h=0;h<o;++h)(g=e+h+a)<0||g>=m||0!==n[4*(u*o+h)+3]&&(d=4*(p=f*m+g),0===r[p]&&(s[d]=this.rgb[0],s[d+1]=this.rgb[1],s[d+2]=this.rgb[2],c||(s[d+3]=255)))}generateMap(e,t,a){var i,s,n;for(i=new Uint8Array(e*t),n=0;n<t;++n)for(s=0;s<e;++s)a<this.matrix[n%4][s%4]&&(i[e*n+s]=1);return i}generateMapCache(e){var t,a;if(a=this.matrix.length*this.matrix[0].length,this.mapCache||(this.mapCache=new Array(a)),e||!this.mapCache[0]||this.mapWidth!==Tegaki.baseWidth||this.mapHeight!==Tegaki.baseHeight)for(this.mapWidth=Tegaki.baseWidth,this.mapHeight=Tegaki.baseHeight,t=0;t<a;++t)this.mapCache[t]=this.generateMap(this.mapWidth,this.mapHeight,t)}setAlpha(e){super.setAlpha(e),this.generateMapCache()}}class TegakiPipette extends TegakiTool{constructor(){super(),this.id=6,this.name="pipette",this.keybind="i",this.step=100,this.useSize=!1,this.useAlpha=!1,this.useFlow=!1,this.noCursor=!0}start(e,t){this.draw(e,t)}draw(e,t){var a,i;i=Tegaki.flatten().getContext("2d"),a=$T.getColorAt(i,e,t),Tegaki.setToolColor(a)}set(){Tegaki.onToolChanged(this)}commit(){}setSize(){}setAlpha(){}}class TegakiBlur extends TegakiBrush{constructor(){super(),this.id=7,this.name="blur",this.step=.25,this.useFlow=!1,this.size=32,this.alpha=.5,this.useAlphaDynamics=!0,this.usePreserveAlpha=!1}writeImageData(e,t,a,i){var s,n,o,r,l,c,d;for(c=Tegaki.activeLayer.imageData.data,d=Tegaki.blendBuffer.data,l=Tegaki.baseWidth,s=0;s<a;++s)for(o=e+s,n=0;n<i;++n)c[r=4*((t+n)*l+o)]=d[r],c[r+1]=d[r+1],c[r+2]=d[r+2],c[r+3]=d[r+3];super.writeImageData(e,t,a,i)}readImageData(e,t,a,i){var s,n,o,r,l,c,d;for(c=Tegaki.activeLayer.imageData.data,d=Tegaki.blendBuffer.data,l=Tegaki.baseWidth,s=0;s<a;++s)for(o=e+s,n=0;n<i;++n)d[r=4*((t+n)*l+o)]=c[r],d[r+1]=c[r+1],d[r+2]=c[r+2],d[r+3]=c[r+3]}brushFn(e,t,a,i){var s,n,o,r,l,c,d,p,h,u,g,f,m,y,k,v,T,b,w,L,C,S,I,E,x;if(!((p=(h=this.brushAlpha)*h*h)<=0))for(n=this.brushSize,d=this.kernel,o=Tegaki.activeLayer.imageData.data,r=Tegaki.blendBuffer.data,l=(f=Tegaki.baseWidth)-1,c=(m=Tegaki.baseHeight)-1,y=0;y<n;++y)if(!((u=e+y+a)<0||u>=f))for(k=0;k<n;++k)if(!((g=t+k+i)<0||g>=m||(S=4*(g*f+u),0===d[4*(k*n+y)+3]||u<=0||g<=0||u>=l||g>=c))){for(v=T=b=w=E=0,L=-1;L<2;++L)for(C=-1;C<2;++C)I=o[(s=4*((g-C)*f+(u-L)))+3],0===L&&0===C?(x=I*h,E+=h):(x=I*p,E+=p),v+=o[s]*x,T+=o[++s]*x,b+=o[++s]*x,w+=x;(w/=E)<=0||(r[S]=Math.round(v/E/w),r[S+1]=Math.round(T/E/w),r[S+2]=Math.round(b/E/w),r[S+3]=Math.round(w))}}}TegakiBlur.prototype.generateShape=TegakiPencil.prototype.generateShape;class TegakiEraser extends TegakiBrush{constructor(){super(),this.id=8,this.name="eraser",this.keybind="e",this.step=.1,this.size=8,this.alpha=1,this.useFlow=!1,this.useSizeDynamics=!0,this.useAlphaDynamics=!0,this.usePreserveAlpha=!1,this.tipId=0,this.tipList=["pencil","pen","airbrush"]}brushFn(e,t,a,i){var s,n,o,r,l,c,d,p,h,u,g,f,m,y,k;for(k=this.brushAlpha,y=this.brushSize,r=this.kernel,s=Tegaki.activeLayer.imageData.data,o=Tegaki.ghostBuffer.data,n=Tegaki.blendBuffer.data,l=Tegaki.baseWidth,c=Tegaki.baseHeight,g=0;g<y;++g)if(!((m=t+g+i)<0||m>=c))for(u=0;u<y;++u)(f=e+u+a)<0||f>=l||(d=r[4*(g*y+u)+3]/255,0===o[h=4*(m*l+f)+3]&&(o[h]=s[h]),p=n[h]/255,p+=d*(k-p),n[h]=Math.floor(255*p),s[h]=Math.floor(o[h]*(1-p)))}generateShape(e){return 0===this.tipId?this.generateShapePencil(e):1===this.tipId?this.generateShapePen(e):this.generateShapeAirbrush(e)}}TegakiEraser.prototype.generateShapePencil=TegakiPencil.prototype.generateShape,TegakiEraser.prototype.generateShapePen=TegakiPen.prototype.generateShape,TegakiEraser.prototype.generateShapeAirbrush=TegakiAirbrush.prototype.generateShape;class TegakiBinReader{constructor(e){this.pos=0,this.view=new DataView(e),this.buf=e}readInt8(){var e=this.view.getInt8(this.pos);return this.pos+=1,e}readUint8(){var e=this.view.getUint8(this.pos);return this.pos+=1,e}readInt16(){var e=this.view.getInt16(this.pos);return this.pos+=2,e}readUint16(){var e=this.view.getUint16(this.pos);return this.pos+=2,e}readUint32(){var e=this.view.getUint32(this.pos);return this.pos+=4,e}readFloat32(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e}}class TegakiBinWriter{constructor(e){this.pos=0,this.view=new DataView(e),this.buf=e}writeInt8(e){this.view.setInt8(this.pos,e),this.pos+=1}writeUint8(e){this.view.setUint8(this.pos,e),this.pos+=1}writeInt16(e){this.view.setInt16(this.pos,e),this.pos+=2}writeUint16(e){this.view.setUint16(this.pos,e),this.pos+=2}writeUint32(e){this.view.setUint32(this.pos,e),this.pos+=4}writeFloat32(e){this.view.setFloat32(this.pos,e),this.pos+=4}}var TegakiUI={draggedNode:null,draggedLabelLastX:0,draggedLabelFn:null,statusTimeout:0,layerPreviewCtxCache:new WeakMap,getLayerPreviewSize:function(){return $T.calcThumbSize(Tegaki.baseWidth,Tegaki.baseHeight,24)},setupDragLabel:function(e,t){TegakiUI.draggedLabelFn=t,TegakiUI.draggedLabelLastX=e.clientX,$T.on(document,"pointermove",TegakiUI.processDragLabel),$T.on(document,"pointerup",TegakiUI.clearDragLabel)},processDragLabel:function(e){TegakiUI.draggedLabelFn.call(Tegaki,e.clientX-TegakiUI.draggedLabelLastX),TegakiUI.draggedLabelLastX=e.clientX},clearDragLabel:function(e){$T.off(document,"pointermove",TegakiUI.processDragLabel),$T.off(document,"pointerup",TegakiUI.clearDragLabel)},printMsg:function(e,t=5e3){TegakiUI.clearMsg(),$T.id("tegaki-status-output").textContent=e,t>0&&(TegakiUI.statusTimeout=setTimeout(TegakiUI.clearMsg,5e3))},clearMsg:function(){TegakiUI.statusTimeout&&(clearTimeout(TegakiUI.statusTimeout),TegakiUI.statusTimeout=0),$T.id("tegaki-status-output").textContent=""},buildUI:function(){var e,t,a,i,s,n;return(e=$T.el("div")).id="tegaki",(a=$T.el("div")).id="tegaki-menu-cnt",Tegaki.replayMode?(a.appendChild(TegakiUI.buildViewerMenuBar()),a.appendChild(TegakiUI.buildReplayControls())):a.appendChild(TegakiUI.buildMenuBar()),a.appendChild(TegakiUI.buildToolModeBar()),e.appendChild(a),e.appendChild(TegakiUI.buildDummyFilePicker()),(t=$T.el("div")).id="tegaki-tools-cnt",t.appendChild(TegakiUI.buildToolsMenu()),e.appendChild(t),[n,s]=TegakiUI.buildCanvasCnt(),e.appendChild(n),(i=$T.el("div")).id="tegaki-ctrl-cnt",i.appendChild(TegakiUI.buildZoomCtrlGroup()),i.appendChild(TegakiUI.buildColorCtrlGroup(Tegaki.toolColor)),i.appendChild(TegakiUI.buildSizeCtrlGroup()),i.appendChild(TegakiUI.buildAlphaCtrlGroup()),i.appendChild(TegakiUI.buildFlowCtrlGroup()),i.appendChild(TegakiUI.buildLayersCtrlGroup()),e.appendChild(i),e.appendChild(TegakiUI.buildStatusCnt()),[e,n,s]},buildDummyFilePicker:function(){var e=$T.el("input");return e.type="file",e.id="tegaki-filepicker",e.className="tegaki-hidden",e.accept="image/png, image/jpeg",$T.on(e,"change",Tegaki.onOpenFileSelected),e},buildMenuBar:function(){var e,t;return(e=$T.el("div")).id="tegaki-menu-bar",(t=$T.el("span")).className="tegaki-mb-btn",t.textContent=TegakiStrings.newCanvas,$T.on(t,"click",Tegaki.onNewClick),e.appendChild(t),(t=$T.el("span")).className="tegaki-mb-btn",t.textContent=TegakiStrings.open,$T.on(t,"click",Tegaki.onOpenClick),e.appendChild(t),(t=$T.el("span")).className="tegaki-mb-btn",t.textContent=TegakiStrings.export,$T.on(t,"click",Tegaki.onExportClick),e.appendChild(t),(t=$T.el("span")).id="tegaki-undo-btn",t.className="tegaki-mb-btn",t.textContent=TegakiStrings.undo,t.title=TegakiKeybinds.getCaption("undo"),$T.on(t,"click",Tegaki.onUndoClick),e.appendChild(t),(t=$T.el("span")).id="tegaki-redo-btn",t.className="tegaki-mb-btn",t.textContent=TegakiStrings.redo,t.title=TegakiKeybinds.getCaption("redo"),$T.on(t,"click",Tegaki.onRedoClick),e.appendChild(t),(t=$T.el("span")).className="tegaki-mb-btn",t.textContent=TegakiStrings.close,$T.on(t,"click",Tegaki.onCancelClick),e.appendChild(t),(t=$T.el("span")).id="tegaki-finish-btn",t.className="tegaki-mb-btn",t.textContent=TegakiStrings.finish,$T.on(t,"click",Tegaki.onDoneClick),e.appendChild(t),e},buildViewerMenuBar:function(){var e,t;return(e=$T.el("div")).id="tegaki-menu-bar",(t=$T.el("span")).id="tegaki-finish-btn",t.className="tegaki-mb-btn",t.textContent=TegakiStrings.close,$T.on(t,"click",Tegaki.onCloseViewerClick),e.appendChild(t),e},buildToolModeBar:function(){var e,t,a,i;return(e=$T.el("div")).id="tegaki-toolmode-bar",Tegaki.tool||e.classList.add("tegaki-hidden"),(t=$T.el("span")).id="tegaki-tool-mode-dynamics",t.className="tegaki-toolmode-grp",(a=$T.el("span")).className="tegaki-toolmode-lbl",a.textContent=TegakiStrings.pressure,t.appendChild(a),(a=$T.el("span")).id="tegaki-tool-mode-dynamics-ctrl",a.className="tegaki-toolmode-ctrl",(i=$T.el("span")).id="tegaki-tool-mode-dynamics-size",i.className="tegaki-sw-btn",i.textContent=TegakiStrings.size,$T.on(i,"mousedown",Tegaki.onToolPressureSizeClick),a.appendChild(i),(i=$T.el("span")).id="tegaki-tool-mode-dynamics-alpha",i.className="tegaki-sw-btn",i.textContent=TegakiStrings.alpha,$T.on(i,"mousedown",Tegaki.onToolPressureAlphaClick),a.appendChild(i),(i=$T.el("span")).id="tegaki-tool-mode-dynamics-flow",i.className="tegaki-sw-btn",i.textContent=TegakiStrings.flow,$T.on(i,"mousedown",Tegaki.onToolPressureFlowClick),a.appendChild(i),t.appendChild(a),e.appendChild(t),(t=$T.el("span")).id="tegaki-tool-mode-mask",t.className="tegaki-toolmode-grp",(a=$T.el("span")).id="tegaki-toolmode-ctrl-tip",a.className="tegaki-toolmode-ctrl",(i=$T.el("span")).id="tegaki-tool-mode-mask-alpha",i.className="tegaki-sw-btn",i.textContent=TegakiStrings.preserveAlpha,$T.on(i,"mousedown",Tegaki.onToolPreserveAlphaClick),a.appendChild(i),t.appendChild(a),e.appendChild(t),(t=$T.el("span")).id="tegaki-tool-mode-tip",t.className="tegaki-toolmode-grp",(a=$T.el("span")).className="tegaki-toolmode-lbl",a.textContent=TegakiStrings.tip,t.appendChild(a),(a=$T.el("span")).id="tegaki-tool-mode-tip-ctrl",a.className="tegaki-toolmode-ctrl",t.appendChild(a),e.appendChild(t),e},buildToolsMenu:function(){var e,t,a,i;for(i in(e=$T.el("div")).id="tegaki-tools-grid",Tegaki.tools)(t=$T.el("span")).setAttribute("data-tool",i),a=TegakiStrings[i],Tegaki.tools[i].keybind&&(a+=" ("+Tegaki.tools[i].keybind.toUpperCase()+")"),t.setAttribute("title",a),t.id="tegaki-tool-btn-"+i,t.className="tegaki-tool-btn tegaki-icon tegaki-"+i,$T.on(t,"click",Tegaki.onToolClick),e.appendChild(t);return e},buildCanvasCnt:function(){var e,t,a;return(e=$T.el("div")).id="tegaki-canvas-cnt",(t=$T.el("div")).id="tegaki-layers-wrap",(a=$T.el("div")).id="tegaki-layers",t.appendChild(a),e.appendChild(t),[e,a]},buildCtrlGroup:function(e,t){var a,i;return(a=$T.el("div")).className="tegaki-ctrlgrp",e&&(a.id="tegaki-ctrlgrp-"+e),void 0!==t&&((i=$T.el("div")).className="tegaki-ctrlgrp-title",i.textContent=t,a.appendChild(i)),a},buildLayersCtrlGroup:function(){var e,t,a,i;return t=this.buildCtrlGroup("layers",TegakiStrings.layers),(a=$T.el("div")).id="tegaki-layers-opts",(i=$T.el("div")).id="tegaki-layer-alpha-cell",(e=$T.el("span")).className="tegaki-label-xs tegaki-lbl-c tegaki-drag-lbl",e.textContent=TegakiStrings.alpha,$T.on(e,"pointerdown",Tegaki.onLayerAlphaDragStart),i.appendChild(e),(e=$T.el("input")).id="tegaki-layer-alpha-opt",e.className="tegaki-stealth-input tegaki-range-lbl-xs",e.setAttribute("maxlength",3),$T.on(e,"input",Tegaki.onLayerAlphaChange),i.appendChild(e),a.appendChild(i),t.appendChild(a),(e=$T.el("div")).id="tegaki-layers-grid",t.appendChild(e),(a=$T.el("div")).id="tegaki-layers-ctrl",(e=$T.el("span")).title=TegakiStrings.addLayer,e.className="tegaki-ui-btn tegaki-icon tegaki-plus",$T.on(e,"click",Tegaki.onLayerAddClick),a.appendChild(e),(e=$T.el("span")).title=TegakiStrings.delLayers,e.className="tegaki-ui-btn tegaki-icon tegaki-minus",$T.on(e,"click",Tegaki.onLayerDeleteClick),a.appendChild(e),(e=$T.el("span")).id="tegaki-layer-merge",e.title=TegakiStrings.mergeLayers,e.className="tegaki-ui-btn tegaki-icon tegaki-level-down",$T.on(e,"click",Tegaki.onMergeLayersClick),a.appendChild(e),(e=$T.el("span")).id="tegaki-layer-up",e.title=TegakiStrings.moveLayerUp,e.setAttribute("data-up","1"),e.className="tegaki-ui-btn tegaki-icon tegaki-up-open",$T.on(e,"click",Tegaki.onMoveLayerClick),a.appendChild(e),(e=$T.el("span")).id="tegaki-layer-down",e.title=TegakiStrings.moveLayerDown,e.className="tegaki-ui-btn tegaki-icon tegaki-down-open",$T.on(e,"click",Tegaki.onMoveLayerClick),a.appendChild(e),t.appendChild(a),t},buildSizeCtrlGroup:function(){var e,t,a;return t=this.buildCtrlGroup("size",TegakiStrings.size),(a=$T.el("div")).className="tegaki-ctrlrow",(e=$T.el("input")).id="tegaki-size",e.className="tegaki-ctrl-range",e.min=1,e.max=Tegaki.maxSize,e.type="range",e.title=TegakiKeybinds.getCaption("toolSize"),$T.on(e,"input",Tegaki.onToolSizeChange),a.appendChild(e),(e=$T.el("input")).id="tegaki-size-lbl",e.setAttribute("maxlength",3),e.className="tegaki-stealth-input tegaki-range-lbl",$T.on(e,"input",Tegaki.onToolSizeChange),a.appendChild(e),t.appendChild(a),t},buildAlphaCtrlGroup:function(){var e,t,a;return t=this.buildCtrlGroup("alpha",TegakiStrings.alpha),(a=$T.el("div")).className="tegaki-ctrlrow",(e=$T.el("input")).id="tegaki-alpha",e.className="tegaki-ctrl-range",e.min=0,e.max=100,e.step=1,e.type="range",$T.on(e,"input",Tegaki.onToolAlphaChange),a.appendChild(e),(e=$T.el("input")).id="tegaki-alpha-lbl",e.setAttribute("maxlength",3),e.className="tegaki-stealth-input tegaki-range-lbl",$T.on(e,"input",Tegaki.onToolAlphaChange),a.appendChild(e),t.appendChild(a),t},buildFlowCtrlGroup:function(){var e,t,a;return t=this.buildCtrlGroup("flow",TegakiStrings.flow),(a=$T.el("div")).className="tegaki-ctrlrow",(e=$T.el("input")).id="tegaki-flow",e.className="tegaki-ctrl-range",e.min=0,e.max=100,e.step=1,e.type="range",$T.on(e,"input",Tegaki.onToolFlowChange),a.appendChild(e),(e=$T.el("input")).id="tegaki-flow-lbl",e.setAttribute("maxlength",3),e.className="tegaki-stealth-input tegaki-range-lbl",$T.on(e,"input",Tegaki.onToolFlowChange),a.appendChild(e),t.appendChild(a),t},buildZoomCtrlGroup:function(){var e,t,a;return a=this.buildCtrlGroup("zoom",TegakiStrings.zoom),(t=$T.el("div")).className="tegaki-ui-btn tegaki-icon tegaki-plus",t.id="tegaki-zoomin-btn",t.setAttribute("data-in",1),$T.on(t,"click",Tegaki.onZoomChange),a.appendChild(t),(t=$T.el("div")).className="tegaki-ui-btn tegaki-icon tegaki-minus",t.id="tegaki-zoomout-btn",t.setAttribute("data-out",1),$T.on(t,"click",Tegaki.onZoomChange),a.appendChild(t),(e=$T.el("div")).id="tegaki-zoom-lbl",a.appendChild(e),a},buildColorCtrlGroup:function(e){var t,a,i,s,n,o,r,l,c;for(o=/ Edge\//i.test(window.navigator.userAgent),s=this.buildCtrlGroup("color",TegakiStrings.color),(a=$T.el("div")).id="tegaki-color-ctrl",(t=$T.el("div")).id="tegaki-color",o&&t.classList.add("tegaki-hidden"),t.style.backgroundColor=e,$T.on(t,"mousedown",Tegaki.onMainColorClick),a.appendChild(t),(t=$T.el("div")).id="tegaki-palette-switcher",(i=$T.el("span")).id="tegaki-palette-prev-btn",i.title=TegakiStrings.switchPalette,i.setAttribute("data-prev","1"),i.className="tegaki-ui-btn tegaki-icon tegaki-left-open tegaki-disabled",$T.on(i,"click",Tegaki.onSwitchPaletteClick),t.appendChild(i),(i=$T.el("span")).id="tegaki-palette-next-btn",i.title=TegakiStrings.switchPalette,i.className="tegaki-ui-btn tegaki-icon tegaki-right-open",$T.on(i,"click",Tegaki.onSwitchPaletteClick),t.appendChild(i),a.appendChild(t),s.appendChild(a),(a=$T.el("div")).id="tegaki-color-grids",r=0;r<TegakiColorPalettes.length;++r){for(n of((t=$T.el("div")).setAttribute("data-id",r),c="tegaki-color-grid",(l=TegakiColorPalettes[r]).length<=18?c+=" tegaki-color-grid-20":c+=" tegaki-color-grid-15",r>0&&(c+=" tegaki-hidden"),t.className=c,l))(i=$T.el("div")).title=TegakiStrings.paletteSlotReplace,i.className="tegaki-color-btn",i.setAttribute("data-color",n),i.style.backgroundColor=n,$T.on(i,"mousedown",Tegaki.onPaletteColorClick),t.appendChild(i);a.appendChild(t)}return s.appendChild(a),(t=$T.el("input")).id="tegaki-colorpicker",!o&&t.classList.add("tegaki-invis"),t.value=n,t.type="color",$T.on(t,"change",Tegaki.onColorPicked),s.appendChild(t),s},buildStatusCnt:function(){var e,t;return(e=$T.el("div")).id="tegaki-status-cnt",Tegaki.saveReplay&&((t=$T.el("div")).id="tegaki-status-replay",t.textContent="⬤",t.setAttribute("title",TegakiStrings.recordingEnabled),e.appendChild(t)),(t=$T.el("div")).id="tegaki-status-output",e.appendChild(t),(t=$T.el("div")).id="tegaki-status-version",t.textContent="tegaki.js v"+Tegaki.VERSION,e.appendChild(t),e},buildReplayControls:function(){var e,t,a;return(e=$T.el("div")).id="tegaki-replay-controls",e.className="tegaki-hidden",(t=$T.el("span")).id="tegaki-replay-gapless-btn",t.className="tegaki-ui-cb-w",$T.on(t,"click",Tegaki.onReplayGaplessClick),(a=$T.el("span")).id="tegaki-replay-gapless-cb",a.className="tegaki-ui-cb",t.appendChild(a),(a=$T.el("span")).className="tegaki-menu-lbl",a.textContent=TegakiStrings.gapless,t.appendChild(a),e.appendChild(t),(t=$T.el("span")).id="tegaki-replay-play-btn",t.className="tegaki-ui-btn tegaki-icon tegaki-play",t.setAttribute("title",TegakiStrings.play),$T.on(t,"click",Tegaki.onReplayPlayPauseClick),e.appendChild(t),(t=$T.el("span")).className="tegaki-ui-btn tegaki-icon tegaki-to-start",t.setAttribute("title",TegakiStrings.rewind),$T.on(t,"click",Tegaki.onReplayRewindClick),e.appendChild(t),(t=$T.el("span")).id="tegaki-replay-slower-btn",t.className="tegaki-ui-btn tegaki-icon tegaki-fast-bw",t.setAttribute("title",TegakiStrings.slower),$T.on(t,"click",Tegaki.onReplaySlowDownClick),e.appendChild(t),(a=$T.el("span")).id="tegaki-replay-speed-lbl",a.className="tegaki-menu-lbl",a.textContent="1.0",e.appendChild(a),(t=$T.el("span")).id="tegaki-replay-faster-btn",t.className="tegaki-ui-btn tegaki-icon tegaki-fast-fw",t.setAttribute("title",TegakiStrings.faster),$T.on(t,"click",Tegaki.onReplaySpeedUpClick),e.appendChild(t),(a=$T.el("span")).id="tegaki-replay-now-lbl",a.className="tegaki-menu-lbl",a.textContent="00:00",e.appendChild(a),(a=$T.el("span")).id="tegaki-replay-end-lbl",a.className="tegaki-menu-lbl",a.textContent="00:00",e.appendChild(a),e},buildLayerGridCell:function(e){var t,a,i;return(t=$T.el("div")).id="tegaki-layers-cell-"+e.id,t.className="tegaki-layers-cell",t.setAttribute("data-id",e.id),t.draggable=!0,t.setAttribute("data-id",e.id),$T.on(t,"pointerdown",TegakiUI.onLayerSelectorPtrDown),$T.on(t,"pointerup",Tegaki.onLayerSelectorClick),$T.on(t,"dragstart",TegakiUI.onLayerDragStart),$T.on(t,"dragover",TegakiUI.onLayerDragOver),$T.on(t,"drop",TegakiUI.onLayerDragDrop),$T.on(t,"dragend",TegakiUI.onLayerDragEnd),$T.on(t,"dragleave",TegakiUI.onLayerDragLeave),$T.on(t,"dragexit",TegakiUI.onLayerDragLeave),(i=$T.el("div")).className="tegaki-layers-cell-v",(a=$T.el("span")).id="tegaki-layers-cb-v-"+e.id,a.className="tegaki-ui-cb",a.setAttribute("data-id",e.id),a.title=TegakiStrings.toggleVisibility,$T.on(a,"click",Tegaki.onLayerToggleVisibilityClick),e.visible&&(a.className+=" tegaki-ui-cb-a"),i.appendChild(a),t.appendChild(i),(i=$T.el("div")).className="tegaki-layers-cell-p",(a=$T.el("canvas")).id="tegaki-layers-p-canvas-"+e.id,a.className="tegaki-alpha-bg-xs",[a.width,a.height]=TegakiUI.getLayerPreviewSize(),i.appendChild(a),t.appendChild(i),(i=$T.el("div")).className="tegaki-layers-cell-n",(a=$T.el("div")).id="tegaki-layer-name-"+e.id,a.className="tegaki-ellipsis",a.setAttribute("data-id",e.id),a.textContent=e.name,$T.on(a,"dblclick",Tegaki.onLayerNameChangeClick),i.appendChild(a),t.appendChild(i),t},onLayerSelectorPtrDown:function(e){"mouse"===e.pointerType?this.hasAttribute("data-nodrag")&&(this.removeAttribute("data-nodrag"),$T.on(this,"dragstart",TegakiUI.onLayerDragStart)):this.hasAttribute("data-nodrag")||(this.setAttribute("data-nodrag",1),$T.off(this,"dragstart",TegakiUI.onLayerDragStart))},onLayerDragStart:function(e){var t,a;e.ctrlKey||(TegakiUI.draggedNode=null,$T.id("tegaki-layers-grid").children[1]?(a=+e.target.getAttribute("data-id"),(t=$T.el("div")).className="tegaki-invis",e.dataTransfer.setDragImage(t,0,0),e.dataTransfer.setData("text/plain",a),e.dataTransfer.effectAllowed="move",TegakiUI.draggedNode=e.target,TegakiUI.updateLayersGridDragExt(!0)):e.preventDefault())},onLayerDragOver:function(e){e.preventDefault(),e.dataTransfer.dropEffect="move",TegakiUI.updateLayersGridDragEffect(e.target,+TegakiUI.draggedNode.getAttribute("data-id"))},onLayerDragLeave:function(e){TegakiUI.updateLayersGridDragEffect()},onLayerDragEnd:function(e){TegakiUI.draggedNode=null,TegakiUI.updateLayersGridDragExt(!1),TegakiUI.updateLayersGridDragEffect()},onLayerDragDrop:function(e){var t,a,i;e.preventDefault(),TegakiUI.draggedNode=null,[t]=TegakiUI.layersGridFindDropTgt(e.target),a=+e.dataTransfer.getData("text/plain"),TegakiUI.updateLayersGridDragEffect(e.target.parentNode),TegakiUI.updateLayersGridDragExt(!1),TegakiUI.layersGridCanDrop(t,a)&&(i=t?TegakiLayers.getLayerPosById(t):Tegaki.layers.length,TegakiLayers.selectedLayersHas(a)||Tegaki.setActiveLayer(a),Tegaki.moveSelectedLayers(i))},updateLayersGridDragExt:function(e){var t,a;(t=$T.id("tegaki-layers-grid")).children[1]&&(e?((a=$T.el("div")).id="tegaki-layers-cell-dx",a.draggable=!0,$T.on(a,"dragover",TegakiUI.onLayerDragOver),$T.on(a,"drop",TegakiUI.onLayerDragDrop),t.parentNode.insertBefore(a,t)):(a=$T.id("tegaki-layers-cell-dx"))&&a.parentNode.removeChild(a))},updateLayersGridDragEffect:function(e,t){var a,i;for(a of $T.cls("tegaki-layers-cell-d",$T.id("tegaki-ctrlgrp-layers")))a.classList.remove("tegaki-layers-cell-d");e&&t&&([i,e]=TegakiUI.layersGridFindDropTgt(e),TegakiUI.layersGridCanDrop(i,t)&&(e||(e=$T.id("tegaki-layers-grid")),e.classList.add("tegaki-layers-cell-d")))},layersGridFindDropTgt:function(e){var t,a;for(t=+e.getAttribute("data-id"),a=$T.id("tegaki-ctrlgrp-layers");!e.draggable&&e!==a;)t=+(e=e.parentNode).getAttribute("data-id");return e!==a&&e.draggable?[t,e]:[0,null]},layersGridCanDrop:function(e,t){var a;if(e===t)return!1;if((a=$T.id("tegaki-layers-cell-"+t)).previousElementSibling){if(+a.previousElementSibling.getAttribute("data-id")===e)return!1}else if(!e)return!1;return!0},setReplayMode:function(e){Tegaki.bg.classList[e?"add":"remove"]("tegaki-replay-mode")},onToolChanged:function(){$T.id("tegaki-toolmode-bar").classList.remove("tegaki-hidden"),TegakiUI.updateToolSize(),TegakiUI.updateToolAlpha(),TegakiUI.updateToolFlow(),TegakiUI.updateToolModes()},updateLayerAlphaOpt:function(){$T.id("tegaki-layer-alpha-opt").value=Math.round(100*Tegaki.activeLayer.alpha)},updateLayerName:function(e){var t;(t=$T.id("tegaki-layer-name-"+e.id))&&(t.textContent=e.name)},updateLayerPreview:function(e){var t,a;(t=$T.id("tegaki-layers-p-canvas-"+e.id))&&((a=TegakiUI.getLayerPreviewCtx(e))||((a=t.getContext("2d")).imageSmoothingEnabled=!1,TegakiUI.setLayerPreviewCtx(e,a)),$T.clearCtx(a),a.drawImage(e.canvas,0,0,t.width,t.height))},updateLayerPreviewSize:function(e){var t,a,i;for(a of(i=TegakiUI.getLayerPreviewSize(),Tegaki.layers))(t=$T.id("tegaki-layers-p-canvas-"+a.id))&&([t.width,t.height]=i,e&&TegakiUI.updateLayerPreview(a))},getLayerPreviewCtx:function(e){TegakiUI.layerPreviewCtxCache.get(e)},setLayerPreviewCtx:function(e,t){TegakiUI.layerPreviewCtxCache.set(e,t)},deleteLayerPreviewCtx:function(e){TegakiUI.layerPreviewCtxCache.delete(e)},updateLayersGridClear:function(){$T.id("tegaki-layers-grid").innerHTML=""},updateLayersGrid:function(){var e,t,a;for(e of(a=$T.frag(),Tegaki.layers))t=TegakiUI.buildLayerGridCell(e),a.insertBefore(t,a.firstElementChild);TegakiUI.updateLayersGridClear(),undefined.appendChild(a)},updateLayersGridActive:function(e){var t;(t=$T.cls("tegaki-layers-cell-a",$T.id("tegaki-layers-grid"))[0])&&t.classList.remove("tegaki-layers-cell-a"),(t=$T.id("tegaki-layers-cell-"+e))&&t.classList.add("tegaki-layers-cell-a"),TegakiUI.updateLayerAlphaOpt()},updateLayersGridAdd:function(e,t){var a,i,s;a=TegakiUI.buildLayerGridCell(e),i=$T.id("tegaki-layers-grid"),s=t?$T.id("tegaki-layers-cell-"+t):null,i.insertBefore(a,s)},updateLayersGridRemove:function(e){var t;(t=$T.id("tegaki-layers-cell-"+e))&&t.parentNode.removeChild(t)},updayeLayersGridOrder:function(){var e,t,a;for(e of(t=$T.id("tegaki-layers-grid"),Tegaki.layers))a=$T.id("tegaki-layers-cell-"+e.id),t.insertBefore(a,t.firstElementChild)},updateLayersGridVisibility:function(e,t){var a;(a=$T.id("tegaki-layers-cb-v-"+e))&&(t?a.classList.add("tegaki-ui-cb-a"):a.classList.remove("tegaki-ui-cb-a"))},updateLayersGridSelectedClear:function(){var e,t;for(e of Tegaki.layers)(t=$T.id("tegaki-layers-cell-"+e.id))&&t.classList.remove("tegaki-layers-cell-s")},updateLayersGridSelectedSet:function(e,t){var a;(a=$T.id("tegaki-layers-cell-"+e))&&(t?a.classList.add("tegaki-layers-cell-s"):a.classList.remove("tegaki-layers-cell-s"))},updateToolSize:function(){var e=$T.id("tegaki-ctrlgrp-size");Tegaki.tool.useSize?(e.classList.remove("tegaki-hidden"),$T.id("tegaki-size-lbl").value=Tegaki.tool.size,$T.id("tegaki-size").value=Tegaki.tool.size):e.classList.add("tegaki-hidden")},updateToolAlpha:function(){var e,t=$T.id("tegaki-ctrlgrp-alpha");Tegaki.tool.useAlpha?(t.classList.remove("tegaki-hidden"),e=Math.round(100*Tegaki.tool.alpha),$T.id("tegaki-alpha-lbl").value=e,$T.id("tegaki-alpha").value=e):t.classList.add("tegaki-hidden")},updateToolFlow:function(){var e,t=$T.id("tegaki-ctrlgrp-flow");Tegaki.tool.useFlow?(t.classList.remove("tegaki-hidden"),e=Math.round(100*Tegaki.tool.flow),$T.id("tegaki-flow-lbl").value=e,$T.id("tegaki-flow").value=e):t.classList.add("tegaki-hidden")},updateToolDynamics:function(){var e,t;e=$T.id("tegaki-tool-mode-dynamics"),Tegaki.tool.usesDynamics()?(t=$T.id("tegaki-tool-mode-dynamics-size"),Tegaki.tool.useSizeDynamics?(Tegaki.tool.sizeDynamicsEnabled?t.classList.add("tegaki-sw-btn-a"):t.classList.remove("tegaki-sw-btn-a"),t.classList.remove("tegaki-hidden")):t.classList.add("tegaki-hidden"),t=$T.id("tegaki-tool-mode-dynamics-alpha"),Tegaki.tool.useAlphaDynamics?(Tegaki.tool.alphaDynamicsEnabled?t.classList.add("tegaki-sw-btn-a"):t.classList.remove("tegaki-sw-btn-a"),t.classList.remove("tegaki-hidden")):t.classList.add("tegaki-hidden"),t=$T.id("tegaki-tool-mode-dynamics-flow"),Tegaki.tool.useFlowDynamics?(Tegaki.tool.flowDynamicsEnabled?t.classList.add("tegaki-sw-btn-a"):t.classList.remove("tegaki-sw-btn-a"),t.classList.remove("tegaki-hidden")):t.classList.add("tegaki-hidden"),e.classList.remove("tegaki-hidden")):e.classList.add("tegaki-hidden")},updateToolShape:function(){var e,t,a,i,s;if(t=$T.id("tegaki-tool-mode-tip"),Tegaki.tool.tipList){for(s=Tegaki.tool.tipList,(a=$T.id("tegaki-tool-mode-tip-ctrl")).innerHTML="",e=0;e<s.length;++e)(i=$T.el("span")).id="tegaki-tool-mode-tip-"+e,i.className="tegaki-sw-btn",i.setAttribute("data-id",e),i.textContent=TegakiStrings[s[e]],$T.on(i,"mousedown",Tegaki.onToolTipClick),a.appendChild(i),Tegaki.tool.tipId===e&&i.classList.add("tegaki-sw-btn-a");t.classList.remove("tegaki-hidden")}else t.classList.add("tegaki-hidden")},updateToolPreserveAlpha:function(){var e,t;t=$T.id("tegaki-tool-mode-mask"),Tegaki.tool.usePreserveAlpha?(e=$T.id("tegaki-tool-mode-mask-alpha"),Tegaki.tool.preserveAlphaEnabled?e.classList.add("tegaki-sw-btn-a"):e.classList.remove("tegaki-sw-btn-a"),t.classList.remove("tegaki-hidden")):t.classList.add("tegaki-hidden")},updateToolModes:function(){var e,t;for(e of(TegakiUI.updateToolShape(),TegakiUI.updateToolDynamics(),TegakiUI.updateToolPreserveAlpha(),t=!1,$T.id("tegaki-toolmode-bar").children))t||e.classList.contains("tegaki-hidden")?e.classList.remove("tegaki-ui-borderless"):(e.classList.add("tegaki-ui-borderless"),t=!0)},updateUndoRedo:function(e,t){var a,i;Tegaki.replayMode||(a=$T.id("tegaki-undo-btn").classList,i=$T.id("tegaki-redo-btn").classList,e?a.contains("tegaki-disabled")&&a.remove("tegaki-disabled"):a.contains("tegaki-disabled")||a.add("tegaki-disabled"),t?i.contains("tegaki-disabled")&&i.remove("tegaki-disabled"):i.contains("tegaki-disabled")||i.add("tegaki-disabled"))},updateZoomLevel:function(){$T.id("tegaki-zoom-lbl").textContent=100*Tegaki.zoomFactor+"%",Tegaki.zoomLevel+Tegaki.zoomBaseLevel>=Tegaki.zoomFactorList.length?$T.id("tegaki-zoomin-btn").classList.add("tegaki-disabled"):$T.id("tegaki-zoomin-btn").classList.remove("tegaki-disabled"),Tegaki.zoomLevel+Tegaki.zoomBaseLevel<=0?$T.id("tegaki-zoomout-btn").classList.add("tegaki-disabled"):$T.id("tegaki-zoomout-btn").classList.remove("tegaki-disabled")},updateColorPalette:function(){var e,t;for(e of(t=Tegaki.colorPaletteId,$T.cls("tegaki-color-grid",$T.id("tegaki-color-grids"))))+e.getAttribute("data-id")===t?e.classList.remove("tegaki-hidden"):e.classList.add("tegaki-hidden");e=$T.id("tegaki-palette-prev-btn"),0===t?e.classList.add("tegaki-disabled"):e.classList.remove("tegaki-disabled"),e=$T.id("tegaki-palette-next-btn"),t===TegakiColorPalettes.length-1?e.classList.add("tegaki-disabled"):e.classList.remove("tegaki-disabled")},updateReplayTime:function(e){var t,a,i=Tegaki.replayViewer;(t=i.getCurrentPos())>(a=i.getDuration())&&(t=a),$T.id("tegaki-replay-now-lbl").textContent=$T.msToHms(t),e&&($T.id("tegaki-replay-end-lbl").textContent=$T.msToHms(a))},updateReplayControls:function(){TegakiUI.updateReplayGapless(),TegakiUI.updateReplayPlayPause(),TegakiUI.updateReplaySpeed()},updateReplayGapless:function(){var e,t=Tegaki.replayViewer;e=$T.id("tegaki-replay-gapless-cb"),t.gapless?e.classList.add("tegaki-ui-cb-a"):e.classList.remove("tegaki-ui-cb-a")},updateReplayPlayPause:function(){var e,t=Tegaki.replayViewer;e=$T.id("tegaki-replay-play-btn"),t.playing?(e.classList.remove("tegaki-play"),e.classList.add("tegaki-pause"),e.setAttribute("title",TegakiStrings.pause)):(e.classList.add("tegaki-play"),e.classList.remove("tegaki-pause"),e.setAttribute("title",TegakiStrings.play),t.getCurrentPos()<t.getDuration()?e.classList.remove("tegaki-disabled"):e.classList.add("tegaki-disabled"))},updateReplaySpeed:function(){var e,t=Tegaki.replayViewer;$T.id("tegaki-replay-speed-lbl").textContent=t.speed.toFixed(1),e=$T.id("tegaki-replay-slower-btn"),0===t.speedIndex?e.classList.add("tegaki-disabled"):e.classList.remove("tegaki-disabled"),e=$T.id("tegaki-replay-faster-btn"),t.speedIndex===t.speedList.length-1?e.classList.add("tegaki-disabled"):e.classList.remove("tegaki-disabled")},enableReplayControls:function(e){e?$T.id("tegaki-replay-controls").classList.remove("tegaki-hidden"):$T.id("tegaki-replay-controls").classList.add("tegaki-hidden")},setRecordingStatus:function(e){var t=$T.id("tegaki-status-replay");e?t.classList.remove("tegaki-hidden"):t.classList.add("tegaki-hidden")}},$T={docEl:document.documentElement,id:function(e){return document.getElementById(e)},cls:function(e,t){return(t||document).getElementsByClassName(e)},on:function(e,t,a){e.addEventListener(t,a,!1)},off:function(e,t,a){e.removeEventListener(t,a,!1)},el:function(e){return document.createElement(e)},frag:function(){return document.createDocumentFragment()},copyImageData:e=>new ImageData(new Uint8ClampedArray(e.data),e.width),copyCanvas:function(e,t){var a;return t?a=e.cloneNode(!1):((a=$T.el("canvas")).width=e.width,a.height=e.height),a.getContext("2d").drawImage(e,0,0),a},clearCtx:function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)},hexToRgb:function(e){var t=e.match(/^#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})$/i);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null},RgbToHex:function(e,t,a){return"#"+((1<<24)+(e<<16)+(t<<8)+a).toString(16).slice(1)},getColorAt:function(e,t,a){var i=e.getImageData(t,a,1,1).data;return"#"+("0"+i[0].toString(16)).slice(-2)+("0"+i[1].toString(16)).slice(-2)+("0"+i[2].toString(16)).slice(-2)},generateFilename:function(){return"tegaki_"+(new Date).toISOString().split(".")[0].replace(/[^0-9]/g,"_")},sortAscCb:function(e,t){return e>t?1:e<t?-1:0},sortDescCb:function(e,t){return e>t?-1:e<t?1:0},msToHms:function(e){var t,a,i,s;return i=(i=0|e/1e3)-3600*(t=0|i/3600)-60*(a=0|(i-3600*t)/60),s=[],t&&s.push(t<10?"0"+t:t),a?s.push(a<10?"0"+a:a):s.push("00"),i?s.push(i<10?"0"+i:i):s.push("00"),s.join(":")},calcThumbSize(e,t,a){var i;return e>a&&(i=a/e,e=a,t*=i),t>a&&(i=a/t,t=a,e*=i),[Math.ceil(e),Math.ceil(t)]}},TegakiPressure={pressureNow:0,pressureThen:0,toShort:function(e){return 0|65535*e},get:function(){return this.pressureNow},lerp:function(e){return this.pressureThen*(1-e)+this.pressureNow*e},push:function(e){this.pressureThen=this.pressureNow,this.pressureNow=e/65535},set:function(e){this.pressureThen=this.pressureNow=e/65535}},TegakiLayers={cloneLayer:function(e){var t=Object.assign({},e);return t.canvas=$T.copyCanvas(e.canvas,!0),t.ctx=t.canvas.getContext("2d"),t.imageData=$T.copyImageData(e.imageData),t},getCanvasById:function(e){return $T.id("tegaki-canvas-"+e)},getActiveLayer:function(){return Tegaki.activeLayer},getLayerPosById:function(e){var t,a=Tegaki.layers;for(t=0;t<a.length;++t)if(a[t].id===e)return t;return-1},getTopFencedLayerId:function(){var e,t,a=Tegaki.layers;for(e=a.length-1;e>=0&&!TegakiLayers.selectedLayersHas(a[e].id);e--);for(e-=1;e>=0&&TegakiLayers.selectedLayersHas(a[e].id);e--);return(t=a[e])?t.id:0},getSelectedEdgeLayerPos:function(e){var t,a=Tegaki.layers;if(e)for(t=Tegaki.layers.length-1;t>=0&&!TegakiLayers.selectedLayersHas(a[t].id);t--);else{for(t=0;t<a.length&&!TegakiLayers.selectedLayersHas(a[t].id);++t);t>=a.length&&(t=-1)}return t},getTopLayer:function(){return Tegaki.layers[Tegaki.layers.length-1]},getTopLayerId:function(){var e=TegakiLayers.getTopLayer();return e?e.id:0},getLayerBelowId:function(e){var t;return(t=TegakiLayers.getLayerPosById(e))<1?null:Tegaki.layers[t-1]},getLayerById:function(e){return Tegaki.layers[TegakiLayers.getLayerPosById(e)]},isSameLayerOrder:function(e,t){var a,i;if(e.length!==t.length)return!1;for(a=0;i=e[a];++a)if(i.id!==t[a].id)return!1;return!0},addLayer:function(e={}){var t,a,i,s,n,o,r,l,c;for(i in Tegaki.activeLayer?(l=Tegaki.activeLayer.id,r=TegakiLayers.getLayerPosById(Tegaki.activeLayer.id),o=$T.cls("tegaki-layer",Tegaki.layersCnt)[r]):(r=-1,o=null),o||(o=Tegaki.layersCnt.firstElementChild),(a=$T.el("canvas")).className="tegaki-layer",a.width=Tegaki.baseWidth,a.height=Tegaki.baseHeight,t=++Tegaki.layerCounter,a.id="tegaki-canvas-"+t,a.setAttribute("data-id",t),s={name:TegakiStrings.layer+" "+t,visible:!0,alpha:1},c=a.getContext("2d"),n={id:t,canvas:a,ctx:c,imageData:c.getImageData(0,0,a.width,a.height)},s)void 0!==e[i]&&(s[i]=e[i]),n[i]=s[i];return Tegaki.layers.splice(r+1,0,n),TegakiUI.updateLayersGridAdd(n,l),Tegaki.layersCnt.insertBefore(a,o.nextElementSibling),Tegaki.onLayerStackChanged(),new TegakiHistoryActions.AddLayer(n,l,t)},deleteLayers:function(e,t){var a,i,s,n,o,r;for(a of(r={aLayerIdBefore:Tegaki.activeLayer?Tegaki.activeLayer.id:-1,aLayerIdAfter:TegakiLayers.getTopFencedLayerId()},n=[],o=[],e))i=TegakiLayers.getLayerPosById(a),s=Tegaki.layers[i],n.push([i,s]),Tegaki.layersCnt.removeChild(s.canvas),o.push(i),TegakiUI.updateLayersGridRemove(a),TegakiUI.deleteLayerPreviewCtx(s);for(i of o=o.sort($T.sortDescCb))Tegaki.layers.splice(i,1);return t&&Object.assign(r,t),Tegaki.onLayerStackChanged(),new TegakiHistoryActions.DeleteLayers(n,r)},mergeLayers:function(e){var t,a,i,s,n,o,r,l,c,d;for(r of(l=[],Tegaki.layers))e.has(r.id)&&l.push(r);if(!(l.length<1)){if(1===l.length){if(!(n=TegakiLayers.getLayerBelowId(l[0].id)))return;l.unshift(n),d=!0}else n=l[l.length-1],d=!1;for(r of((t=$T.el("canvas")).width=Tegaki.baseWidth,t.height=Tegaki.baseHeight,a=t.getContext("2d"),s=$T.copyImageData(n.imageData),c=[],l))r.id!==n.id&&c.push(r.id),a.globalAlpha=r.alpha,a.drawImage(r.canvas,0,0);return $T.clearCtx(n.ctx),n.ctx.drawImage(t,0,0),TegakiLayers.syncLayerImageData(n),i=$T.copyImageData(n.imageData),o=TegakiLayers.deleteLayers(c,{tgtLayerId:n.id,tgtLayerAlpha:n.alpha,aLayerIdAfter:n.id,imageDataBefore:s,imageDataAfter:i,mergeDown:d}),TegakiLayers.setLayerAlpha(n,1),TegakiUI.updateLayerAlphaOpt(),TegakiUI.updateLayerPreview(n),Tegaki.onLayerStackChanged(),o}},moveLayers:function(e,t){var a,i,s,n,o,r,l;if(e.size&&Tegaki.layers.length){for(i of(r=t>=Tegaki.layers.length?TegakiLayers.getTopLayer().canvas.nextElementSibling:(i=Tegaki.layers[t]).canvas,s=[],n=[],o=[],l=t,a=0,Tegaki.layers))e.has(i.id)?(t>0&&a<=t&&l--,s.push([a,i]),o.push(i)):n.push(i),++a;if(n.splice(l,0,...o),!TegakiLayers.isSameLayerOrder(n,Tegaki.layers)){for(i of(Tegaki.layers=n,s))Tegaki.layersCnt.insertBefore(i[1].canvas,r);return TegakiUI.updayeLayersGridOrder(),Tegaki.onLayerStackChanged(),new TegakiHistoryActions.MoveLayers(s,t,Tegaki.activeLayer?Tegaki.activeLayer.id:-1)}}},setLayerVisibility:function(e,t){e.visible=t,t?e.canvas.classList.remove("tegaki-hidden"):e.canvas.classList.add("tegaki-hidden"),Tegaki.onLayerStackChanged(),TegakiUI.updateLayersGridVisibility(e.id,t)},setLayerAlpha:function(e,t){e.alpha=t,e.canvas.style.opacity=t},setActiveLayer:function(e){var t,a;e||(e=TegakiLayers.getTopLayerId())?(t=TegakiLayers.getLayerPosById(e))<0||(a=Tegaki.layers[t],Tegaki.activeLayer&&Tegaki.copyContextState(Tegaki.activeLayer.ctx,a.ctx),Tegaki.activeLayer=a,TegakiLayers.selectedLayersClear(),TegakiLayers.selectedLayersAdd(e),TegakiUI.updateLayersGridActive(e),TegakiUI.updateLayerAlphaOpt(),Tegaki.onLayerStackChanged()):Tegaki.activeLayer=null},syncLayerImageData(e,t=null){e.imageData=t?$T.copyImageData(t):e.ctx.getImageData(0,0,Tegaki.baseWidth,Tegaki.baseHeight)},selectedLayersHas:function(e){return Tegaki.selectedLayers.has(+e)},selectedLayersClear:function(){Tegaki.selectedLayers.clear(),TegakiUI.updateLayerAlphaOpt(),TegakiUI.updateLayersGridSelectedClear()},selectedLayersAdd:function(e){Tegaki.selectedLayers.add(+e),TegakiUI.updateLayerAlphaOpt(),TegakiUI.updateLayersGridSelectedSet(e,!0)},selectedLayersRemove:function(e){Tegaki.selectedLayers.delete(+e),TegakiUI.updateLayerAlphaOpt(),TegakiUI.updateLayersGridSelectedSet(e,!1)},selectedLayersToggle:function(e){TegakiLayers.selectedLayersHas(e)?TegakiLayers.selectedLayersRemove(e):TegakiLayers.selectedLayersAdd(e)}},TegakiKeybinds={keyMap:{},captionMap:{},clear:function(){this.keyMap={},this.captionMap={}},bind:function(e,t,a,i,s){this.keyMap[e]=[t,a],i&&(this.captionMap[i]=s)},getCaption(e){return this.captionMap[e]},resolve:function(e){var t,a,i,s;("INPUT"!=(s=e.target).nodeName||"text"!==s.type&&"number"!==s.type)&&(a=[],e.ctrlKey&&a.push("ctrl"),e.shiftKey&&a.push("shift"),i=e.key.toLowerCase(),a[0]&&(i=a.join("+")+"+"+i),!(t=TegakiKeybinds.keyMap[i])||e.altKey||e.metaKey||(e.preventDefault(),e.stopPropagation(),t[0][t[1]]()))}},TegakiHistory={maxSize:50,undoStack:[],redoStack:[],pendingAction:null,clear:function(){this.undoStack=[],this.redoStack=[],this.pendingAction=null,this.onChange(0)},push:function(e){e&&(e.coalesce&&this.undoStack[this.undoStack.length-1]instanceof e.constructor&&this.undoStack[this.undoStack.length-1].coalesce(e)||(this.undoStack.push(e),this.undoStack.length>this.maxSize&&this.undoStack.shift(),this.redoStack.length>0&&(this.redoStack=[]),this.onChange(0)))},undo:function(){var e;this.undoStack.length&&((e=this.undoStack.pop()).undo(),this.redoStack.push(e),this.onChange(-1))},redo:function(){var e;this.redoStack.length&&((e=this.redoStack.pop()).redo(),this.undoStack.push(e),this.onChange(1))},onChange:function(e){Tegaki.onHistoryChange(this.undoStack.length,this.redoStack.length,e)},sortPosLayerCallback:function(e,t){return e[0]>t[0]?1:e[0]<t[0]?-1:0}},TegakiHistoryActions={Dummy:function(){this.undo=function(){},this.redo=function(){}},Draw:function(e){this.coalesce=!1,this.imageDataBefore=null,this.imageDataAfter=null,this.layerId=e},DeleteLayers:function(e,t){var a;for(a of(this.coalesce=!1,this.layerPosMap=[],e.sort(TegakiHistory.sortPosLayerCallback)))a[1]=TegakiLayers.cloneLayer(a[1]),this.layerPosMap.push(a);if(this.tgtLayerId=null,this.aLayerIdBefore=null,this.aLayerIdAfter=null,this.imageDataBefore=null,this.imageDataAfter=null,this.mergeDown=!1,t)for(let e in t)this[e]=t[e]},AddLayer:function(e,t,a){this.coalesce=!1,this.layer=e,this.layerId=e.id,this.aLayerIdBefore=t,this.aLayerIdAfter=a},MoveLayers:function(e,t,a){this.coalesce=!1,this.layers=e,this.belowPos=t,this.aLayerId=a},SetLayersAlpha:function(e,t){this.layerAlphas=e,this.newAlpha=t},SetLayerName:function(e,t,a){this.layerId=e,this.oldName=t,this.newName=a}};TegakiHistoryActions.Draw.prototype.addCanvasState=function(e,t){t?this.imageDataAfter=$T.copyImageData(e):this.imageDataBefore=$T.copyImageData(e)},TegakiHistoryActions.Draw.prototype.exec=function(e){var t=TegakiLayers.getLayerById(this.layerId);e?(t.ctx.putImageData(this.imageDataAfter,0,0),TegakiLayers.syncLayerImageData(t,this.imageDataAfter)):(t.ctx.putImageData(this.imageDataBefore,0,0),TegakiLayers.syncLayerImageData(t,this.imageDataBefore)),TegakiUI.updateLayerPreview(t),TegakiLayers.setActiveLayer(this.layerId)},TegakiHistoryActions.Draw.prototype.undo=function(){this.exec(0)},TegakiHistoryActions.Draw.prototype.redo=function(){this.exec(1)},TegakiHistoryActions.DeleteLayers.prototype.undo=function(){var e,t,a,i,s,n;for(e=0,t=this.layerPosMap.length;e<t;++e)[s,i]=this.layerPosMap[e],i=TegakiLayers.cloneLayer(i),(a=Tegaki.layers[s])?((n=TegakiLayers.getLayerBelowId(a.id))&&(n=n.id),TegakiUI.updateLayersGridAdd(i,n),TegakiUI.updateLayerPreview(i),Tegaki.layersCnt.insertBefore(i.canvas,a.canvas),Tegaki.layers.splice(s,0,i)):(a=Tegaki.layers[0]?Tegaki.layers[Tegaki.layers.length-1].canvas:Tegaki.layersCnt.children[0],TegakiUI.updateLayersGridAdd(i,TegakiLayers.getTopLayerId()),TegakiUI.updateLayerPreview(i),Tegaki.layersCnt.insertBefore(i.canvas,a.nextElementSibling),Tegaki.layers.push(i));this.tgtLayerId&&((i=TegakiLayers.getLayerById(this.tgtLayerId)).ctx.putImageData(this.imageDataBefore,0,0),TegakiLayers.syncLayerImageData(i,this.imageDataBefore),TegakiLayers.setLayerAlpha(i,this.tgtLayerAlpha),TegakiUI.updateLayerPreview(i)),TegakiLayers.setActiveLayer(this.aLayerIdBefore)},TegakiHistoryActions.DeleteLayers.prototype.redo=function(){var e,t=[];for(e of this.layerPosMap)t.unshift(e[1].id);this.tgtLayerId?(this.mergeDown||t.unshift(this.tgtLayerId),TegakiLayers.mergeLayers(new Set(t))):TegakiLayers.deleteLayers(t),TegakiLayers.setActiveLayer(this.aLayerIdAfter)},TegakiHistoryActions.MoveLayers.prototype.undo=function(){var e,t,a,i,s;for(t of(new Array(Tegaki.layers.length),i={},this.layers))i[t[1].id]=t[0];for(e=0,s=Tegaki.layers.length;e<s;++e)void 0!==i[(t=Tegaki.layers[e]).id]&&(Tegaki.layers.splice(e,1),Tegaki.layers.splice(i[t.id],0,t));for(TegakiUI.updayeLayersGridOrder(),a=Tegaki.layersCnt.children[0],e=Tegaki.layers.length-1;e>=0;e--)t=Tegaki.layers[e],Tegaki.layersCnt.insertBefore(t.canvas,a.nextElementSibling);TegakiLayers.setActiveLayer(this.aLayerId)},TegakiHistoryActions.MoveLayers.prototype.redo=function(){var e,t=new Set;for(e of this.layers.slice().reverse())t.add(e[1].id);TegakiLayers.setActiveLayer(this.aLayerId),TegakiLayers.moveLayers(t,this.belowPos)},TegakiHistoryActions.AddLayer.prototype.undo=function(){TegakiLayers.deleteLayers([this.layer.id]),TegakiLayers.setActiveLayer(this.aLayerIdBefore),Tegaki.layerCounter--},TegakiHistoryActions.AddLayer.prototype.redo=function(){TegakiLayers.setActiveLayer(this.aLayerIdBefore),TegakiLayers.addLayer(this.layer),TegakiLayers.setActiveLayer(this.aLayerIdAfter)},TegakiHistoryActions.SetLayersAlpha.prototype.undo=function(){var e,t,a;for(t of this.layerAlphas)[e,t]=t,(a=TegakiLayers.getLayerById(e))&&TegakiLayers.setLayerAlpha(a,t);TegakiUI.updateLayerAlphaOpt()},TegakiHistoryActions.SetLayersAlpha.prototype.redo=function(){var e,t,a;for(t of this.layerAlphas)[e,t]=t,(a=TegakiLayers.getLayerById(e))&&TegakiLayers.setLayerAlpha(a,this.newAlpha);TegakiUI.updateLayerAlphaOpt()},TegakiHistoryActions.SetLayersAlpha.prototype.coalesce=function(e){var t;if(this.layerAlphas.length!==e.layerAlphas.length)return!1;for(t=0;t<this.layerAlphas.length;++t)if(this.layerAlphas[t][0]!==e.layerAlphas[t][0])return!1;return this.newAlpha=e.newAlpha,!0},TegakiHistoryActions.SetLayerName.prototype.exec=function(e){var t=TegakiLayers.getLayerById(this.layerId);t&&(t.name=e?this.newName:this.oldName,TegakiUI.updateLayerName(t))},TegakiHistoryActions.SetLayerName.prototype.undo=function(){this.exec(0)},TegakiHistoryActions.SetLayerName.prototype.redo=function(){this.exec(1)};var TegakiCursor={size:0,radius:0,points:null,tmpCtx:null,cursorCtx:null,flatCtxAbove:null,flatCtxBelow:null,cached:!1,init:function(e,t){var a;this.tmpCtx=$T.el("canvas").getContext("2d"),(a=$T.el("canvas")).id="tegaki-cursor-layer",a.width=e,a.height=t,Tegaki.layersCnt.appendChild(a),this.cursorCtx=a.getContext("2d"),(a=$T.el("canvas")).width=e,a.height=t,this.flatCtxAbove=a.getContext("2d"),(a=$T.el("canvas")).width=e,a.height=t,this.flatCtxBelow=a.getContext("2d")},updateCanvasSize:function(e,t){this.cursorCtx.canvas.width=e,this.cursorCtx.canvas.height=t,this.flatCtxAbove.canvas.width=e,this.flatCtxAbove.canvas.height=t,this.flatCtxBelow.canvas.width=e,this.flatCtxBelow.canvas.height=t},render:function(e,t){var a,i,s,n,o,r,l;for(a of(this.cached||this.buildCache(),i=this.size,e-=this.radius,t-=this.radius,$T.clearCtx(this.cursorCtx),$T.clearCtx(this.tmpCtx),this.tmpCtx.drawImage(this.flatCtxBelow.canvas,e,t,i,i,0,0,i,i),(l=Tegaki.activeLayer).visible&&(l.alpha<1?(this.tmpCtx.globalAlpha=l.alpha,this.tmpCtx.drawImage(Tegaki.activeLayer.canvas,e,t,i,i,0,0,i,i),this.tmpCtx.globalAlpha=1):this.tmpCtx.drawImage(Tegaki.activeLayer.canvas,e,t,i,i,0,0,i,i)),this.tmpCtx.drawImage(this.flatCtxAbove.canvas,e,t,i,i,0,0,i,i),s=this.tmpCtx.getImageData(0,0,i,i),n=new Uint32Array(s.data.buffer),o=this.cursorCtx.createImageData(i,i),r=new Uint32Array(o.data.buffer),this.points))r[a]=16777087^n[a];this.cursorCtx.putImageData(o,e,t)},buildCache:function(){var e,t,a,i,s;for((a=this.flatCtxBelow).globalAlpha=1,$T.clearCtx(a),a.drawImage(Tegaki.canvas,0,0),s=Tegaki.activeLayer.id,e=0,i=Tegaki.layers.length;e<i;++e)(t=Tegaki.layers[e]).visible&&(t.id!==s?(a.globalAlpha=t.alpha,a.drawImage(t.canvas,0,0)):((a=this.flatCtxAbove).globalAlpha=1,$T.clearCtx(a)));this.cached=!0},invalidateCache(){this.cached=!1},destroy(){this.size=0,this.radius=0,this.points=null,this.tmpCtx=null,this.cursorCtx=null,this.flatCtxAbove=null,this.flatCtxBelow=null},generate:function(e){var t,a,i,s,n,o,r;for(o=0|(e+1)%2,r=[],a=n=0|e/2,i=0,t=1-n,s=n;a>=i;)r.push(s+a-o+(s+i-o)*e),r.push(s+i-o+(s+a-o)*e),r.push(s-i+(s+a-o)*e),r.push(s-a+(s+i-o)*e),r.push(s-i+(s-a)*e),r.push(s-a+(s-i)*e),r.push(s+i-o+(s-a)*e),r.push(s+a-o+(s-i)*e),++i,t+=t<=0?2*i+1:2*(i- --a)+1;this.tmpCtx.canvas.width=e,this.tmpCtx.canvas.height=e,this.size=e,this.radius=n,this.points=r}};class TegakiEvent_void{constructor(){this.size=5}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp)}static unpack(e){return new this(e.readUint32())}}class TegakiEvent_c{constructor(){this.size=6}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeUint8(this.value)}static unpack(e){return new this(e.readUint32(),e.readUint8())}}class TegakiEventPrelude extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){}}class TegakiEventConclusion extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){}}class TegakiEventHistoryDummy extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){TegakiHistory.push(new TegakiHistoryActions.Dummy)}}class TegakiEventDrawStart{constructor(e,t,a,i){this.timeStamp=e,this.x=t,this.y=a,this.pressure=i,this.type=TegakiEvents[this.constructor.name][0],this.size=11}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeInt16(this.x),e.writeInt16(this.y),e.writeUint16(this.pressure)}static unpack(e){var t,a,i,s;return t=e.readUint32(),a=e.readInt16(),i=e.readInt16(),s=e.readUint16(),new TegakiEventDrawStart(t,a,i,s)}dispatch(){TegakiPressure.set(this.pressure),TegakiHistory.pendingAction=new TegakiHistoryActions.Draw(Tegaki.activeLayer.id),TegakiHistory.pendingAction.addCanvasState(Tegaki.activeLayer.imageData,0),Tegaki.tool.start(this.x,this.y)}}class TegakiEventDrawStartNoP{constructor(e,t,a){this.timeStamp=e,this.x=t,this.y=a,this.type=TegakiEvents[this.constructor.name][0],this.size=9}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeInt16(this.x),e.writeInt16(this.y)}static unpack(e){var t,a,i;return t=e.readUint32(),a=e.readInt16(),i=e.readInt16(),new TegakiEventDrawStartNoP(t,a,i)}dispatch(){TegakiPressure.set(.5),TegakiHistory.pendingAction=new TegakiHistoryActions.Draw(Tegaki.activeLayer.id),TegakiHistory.pendingAction.addCanvasState(Tegaki.activeLayer.imageData,0),Tegaki.tool.start(this.x,this.y)}}class TegakiEventDraw{constructor(e,t,a,i){this.timeStamp=e,this.x=t,this.y=a,this.pressure=i,this.type=TegakiEvents[this.constructor.name][0],this.size=11}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeInt16(this.x),e.writeInt16(this.y),e.writeUint16(this.pressure)}static unpack(e){var t,a,i,s;return t=e.readUint32(),a=e.readInt16(),i=e.readInt16(),s=e.readUint16(),new TegakiEventDraw(t,a,i,s)}dispatch(){TegakiPressure.push(this.pressure),Tegaki.tool.draw(this.x,this.y)}}class TegakiEventDrawNoP{constructor(e,t,a){this.timeStamp=e,this.x=t,this.y=a,this.type=TegakiEvents[this.constructor.name][0],this.size=9}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeInt16(this.x),e.writeInt16(this.y)}static unpack(e){var t,a,i;return t=e.readUint32(),a=e.readInt16(),i=e.readInt16(),new TegakiEventDraw(t,a,i)}dispatch(){TegakiPressure.push(.5),Tegaki.tool.draw(this.x,this.y)}}class TegakiEventDrawCommit extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){Tegaki.tool.commit(),TegakiUI.updateLayerPreview(Tegaki.activeLayer),TegakiHistory.pendingAction.addCanvasState(Tegaki.activeLayer.imageData,1),TegakiHistory.push(TegakiHistory.pendingAction),Tegaki.isPainting=!1}}class TegakiEventUndo extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){TegakiHistory.undo()}}class TegakiEventRedo extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){TegakiHistory.redo()}}class TegakiEventSetColor{constructor(e,t){this.timeStamp=e,[this.r,this.g,this.b]=t,this.type=TegakiEvents[this.constructor.name][0],this.size=8,this.coalesce=!0}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeUint8(this.r),e.writeUint8(this.g),e.writeUint8(this.b)}static unpack(e){var t,a;return t=e.readUint32(),a=[e.readUint8(),e.readUint8(),e.readUint8()],new TegakiEventSetColor(t,a)}dispatch(){Tegaki.setToolColorRGB(this.r,this.g,this.b)}}class TegakiEventSetTool extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolById(this.value)}}class TegakiEventSetToolSize extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolSize(this.value)}}class TegakiEventSetToolAlpha{constructor(e,t){this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0,this.size=9}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeFloat32(this.value)}static unpack(e){return new this(e.readUint32(),e.readFloat32())}dispatch(){Tegaki.setToolAlpha(this.value)}}class TegakiEventSetToolFlow{constructor(e,t){this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0,this.size=9}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeFloat32(this.value)}static unpack(e){return new this(e.readUint32(),e.readFloat32())}dispatch(){Tegaki.setToolFlow(this.value)}}class TegakiEventPreserveAlpha extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolPreserveAlpha(!!this.value)}}class TegakiEventSetToolSizeDynamics extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolSizeDynamics(!!this.value)}}class TegakiEventSetToolAlphaDynamics extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolAlphaDynamics(!!this.value)}}class TegakiEventSetToolFlowDynamics extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolFlowDynamics(!!this.value)}}class TegakiEventSetToolTip extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0}dispatch(){Tegaki.setToolTip(this.value)}}class TegakiEventAddLayer extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){Tegaki.addLayer()}}class TegakiEventDeleteLayers extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){Tegaki.deleteSelectedLayers()}}class TegakiEventMoveLayers extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0]}dispatch(){Tegaki.moveSelectedLayers(this.value)}}class TegakiEventMergeLayers extends TegakiEvent_void{constructor(e){super(),this.timeStamp=e,this.type=TegakiEvents[this.constructor.name][0]}static unpack(e){return super.unpack(e)}dispatch(){Tegaki.mergeSelectedLayers()}}class TegakiEventToggleLayerVisibility extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0]}dispatch(){Tegaki.toggleLayerVisibility(this.value)}}class TegakiEventSetActiveLayer extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0]}dispatch(){Tegaki.setActiveLayer(this.value)}}class TegakiEventToggleLayerSelection extends TegakiEvent_c{constructor(e,t){super(),this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0]}dispatch(){Tegaki.toggleSelectedLayer(this.value)}}class TegakiEventSetSelectedLayersAlpha{constructor(e,t){this.timeStamp=e,this.value=t,this.type=TegakiEvents[this.constructor.name][0],this.coalesce=!0,this.size=9}pack(e){e.writeUint8(this.type),e.writeUint32(this.timeStamp),e.writeFloat32(this.value)}static unpack(e){return new this(e.readUint32(),e.readFloat32())}dispatch(){Tegaki.setSelectedLayersAlpha(this.value)}}const TegakiEvents=Object.freeze({TegakiEventPrelude:[0,TegakiEventPrelude],TegakiEventDrawStart:[1,TegakiEventDrawStart],TegakiEventDraw:[2,TegakiEventDraw],TegakiEventDrawCommit:[3,TegakiEventDrawCommit],TegakiEventUndo:[4,TegakiEventUndo],TegakiEventRedo:[5,TegakiEventRedo],TegakiEventSetColor:[6,TegakiEventSetColor],TegakiEventDrawStartNoP:[7,TegakiEventDrawStartNoP],TegakiEventDrawNoP:[8,TegakiEventDrawNoP],TegakiEventSetTool:[10,TegakiEventSetTool],TegakiEventSetToolSize:[11,TegakiEventSetToolSize],TegakiEventSetToolAlpha:[12,TegakiEventSetToolAlpha],TegakiEventSetToolSizeDynamics:[13,TegakiEventSetToolSizeDynamics],TegakiEventSetToolAlphaDynamics:[14,TegakiEventSetToolAlphaDynamics],TegakiEventSetToolTip:[15,TegakiEventSetToolTip],TegakiEventPreserveAlpha:[16,TegakiEventPreserveAlpha],TegakiEventSetToolFlowDynamics:[17,TegakiEventSetToolFlowDynamics],TegakiEventSetToolFlow:[18,TegakiEventSetToolFlow],TegakiEventAddLayer:[20,TegakiEventAddLayer],TegakiEventDeleteLayers:[21,TegakiEventDeleteLayers],TegakiEventMoveLayers:[22,TegakiEventMoveLayers],TegakiEventMergeLayers:[23,TegakiEventMergeLayers],TegakiEventToggleLayerVisibility:[24,TegakiEventToggleLayerVisibility],TegakiEventSetActiveLayer:[25,TegakiEventSetActiveLayer],TegakiEventToggleLayerSelection:[26,TegakiEventToggleLayerSelection],TegakiEventSetSelectedLayersAlpha:[27,TegakiEventSetSelectedLayersAlpha],TegakiEventHistoryDummy:[254,TegakiEventHistoryDummy],TegakiEventConclusion:[255,TegakiEventConclusion]});var Tegaki={VERSION:"0.9.2",startTimeStamp:0,bg:null,canvas:null,ctx:null,layers:[],layersCnt:null,canvasCnt:null,ghostBuffer:null,blendBuffer:null,ghostBuffer32:null,blendBuffer32:null,activeLayer:null,layerCounter:0,selectedLayers:new Set,activePointerId:0,activePointerIsPen:!1,isPainting:!1,offsetX:0,offsetY:0,zoomLevel:0,zoomFactor:1,zoomFactorList:[.5,1,2,4,8,16],zoomBaseLevel:1,hasCustomCanvas:!1,TWOPI:2*Math.PI,toolList:[TegakiPencil,TegakiPen,TegakiAirbrush,TegakiBucket,TegakiTone,TegakiPipette,TegakiBlur,TegakiEraser],tools:{},tool:null,colorPaletteId:0,toolColor:"#000000",defaultTool:"pencil",bgColor:"#ffffff",maxSize:64,maxLayers:25,baseWidth:0,baseHeight:0,replayRecorder:null,replayViewer:null,onDoneCb:null,onCancelCb:null,replayMode:!1,saveReplay:!1,open:function(e={}){var t=Tegaki;if(t.bg){if(t.replayMode===!!e.replayMode)return void t.resume();t.destroy()}t.startTimeStamp=Date.now(),e.bgColor&&(t.bgColor=e.bgColor),t.hasCustomCanvas=!1,t.saveReplay=!!e.saveReplay,t.replayMode=!!e.replayMode,t.onDoneCb=e.onDone,t.onCancelCb=e.onCancel,t.baseWidth=e.width||0,t.baseHeight=e.height||0,t.createTools(),t.initKeybinds(),[t.bg,t.canvasCnt,t.layersCnt]=TegakiUI.buildUI(),document.body.appendChild(t.bg),document.body.classList.add("tegaki-backdrop"),t.replayMode?(TegakiUI.setReplayMode(!0),t.replayViewer=new TegakiReplayViewer,e.replayURL&&t.loadReplayFromURL(e.replayURL)):(t.init(),t.setTool(t.defaultTool),t.saveReplay&&(t.replayRecorder=new TegakiReplayRecorder,t.replayRecorder.start()))},init:function(){var e=Tegaki;e.createCanvas(),e.centerLayersCnt(),e.createBuffers(),e.updatePosOffset(),e.resetLayers(),e.bindGlobalEvents(),TegakiCursor.init(e.baseWidth,e.baseHeight),TegakiUI.updateUndoRedo(0,0),TegakiUI.updateZoomLevel()},initFromReplay:function(){var e,t;t=(e=Tegaki).replayViewer,e.initToolsFromReplay(),e.baseWidth=t.canvasWidth,e.baseHeight=t.canvasHeight,e.bgColor=$T.RgbToHex(...t.bgColor),e.toolColor=$T.RgbToHex(...t.toolColor)},initToolsFromReplay:function(){var e,t,a,i,s,n;for(a in t=(e=Tegaki).replayViewer,e.tools){for(n of((i=e.tools[a]).id===t.toolId&&(e.defaultTool=a),s=t.toolMap[i.id],["step","size","alpha","flow","tipId"]))void 0!==s[n]&&(i[n]=s[n]);for(n of["sizeDynamicsEnabled","alphaDynamicsEnabled","flowDynamicsEnabled","usePreserveAlpha"])void 0!==s[n]&&(i[n]=!!s[n])}},resetLayers:function(){var e,t;if(Tegaki.layers.length){for(e=0,t=Tegaki.layers.length;e<t;++e)Tegaki.layersCnt.removeChild(Tegaki.layers[e].canvas);Tegaki.layers=[],Tegaki.layerCounter=0,TegakiUI.updateLayersGridClear()}TegakiLayers.addLayer(),TegakiLayers.setActiveLayer(0)},createCanvas:function(){var e,t=Tegaki;(e=$T.el("canvas")).id="tegaki-canvas",e.width=t.baseWidth,e.height=t.baseHeight,t.canvas=e,t.ctx=e.getContext("2d"),t.ctx.fillStyle=t.bgColor,t.ctx.fillRect(0,0,t.baseWidth,t.baseHeight),t.layersCnt.appendChild(e)},createTools:function(){var e,t;for(e of Tegaki.toolList)t=new e,Tegaki.tools[t.name]=t},bindGlobalEvents:function(){var e=Tegaki;e.replayMode?$T.on(document,"visibilitychange",Tegaki.onVisibilityChange):($T.on(e.canvasCnt,"pointermove",e.onPointerMove),$T.on(e.canvasCnt,"pointerdown",e.onPointerDown),$T.on(document,"pointerup",e.onPointerUp),$T.on(document,"pointercancel",e.onPointerUp),$T.on(document,"keydown",TegakiKeybinds.resolve),$T.on(window,"beforeunload",Tegaki.onTabClose)),$T.on(e.bg,"contextmenu",e.onDummy),$T.on(window,"resize",e.updatePosOffset),$T.on(window,"scroll",e.updatePosOffset)},unBindGlobalEvents:function(){var e=Tegaki;e.replayMode?$T.off(document,"visibilitychange",Tegaki.onVisibilityChange):($T.off(e.canvasCnt,"pointermove",e.onPointerMove),$T.off(e.canvasCnt,"pointerdown",e.onPointerDown),$T.off(document,"pointerup",e.onPointerUp),$T.off(document,"pointercancel",e.onPointerUp),$T.off(document,"keydown",TegakiKeybinds.resolve),$T.off(window,"beforeunload",Tegaki.onTabClose)),$T.off(e.bg,"contextmenu",e.onDummy),$T.off(window,"resize",e.updatePosOffset),$T.off(window,"scroll",e.updatePosOffset)},createBuffers(){Tegaki.ghostBuffer=new ImageData(Tegaki.baseWidth,Tegaki.baseHeight),Tegaki.blendBuffer=new ImageData(Tegaki.baseWidth,Tegaki.baseHeight),Tegaki.ghostBuffer32=new Uint32Array(Tegaki.ghostBuffer.data.buffer),Tegaki.blendBuffer32=new Uint32Array(Tegaki.blendBuffer.data.buffer)},clearBuffers(){Tegaki.ghostBuffer32.fill(0),Tegaki.blendBuffer32.fill(0)},destroyBuffers(){Tegaki.ghostBuffer=null,Tegaki.blendBuffer=null,Tegaki.ghostBuffer32=null,Tegaki.blendBuffer32=null},disableSmoothing:function(e){e.mozImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1},centerLayersCnt:function(){var e=Tegaki.layersCnt.style;e.width=Tegaki.baseWidth+"px",e.height=Tegaki.baseHeight+"px"},onTabClose:function(e){e.preventDefault(),e.returnValue=""},onVisibilityChange:function(e){Tegaki.replayMode&&("visible"===document.visibilityState?Tegaki.replayViewer.autoPaused&&Tegaki.replayViewer.play():Tegaki.replayViewer.playing&&Tegaki.replayViewer.autoPause())},initKeybinds:function(){var e,t;if(!Tegaki.replayMode)for(t in TegakiKeybinds.bind("ctrl+z",TegakiHistory,"undo","undo","Ctrl+Z"),TegakiKeybinds.bind("ctrl+y",TegakiHistory,"redo","redo","Ctrl+Y"),TegakiKeybinds.bind("+",Tegaki,"setToolSizeUp","toolSize","Numpad +/-"),TegakiKeybinds.bind("-",Tegaki,"setToolSizeDown"),Tegaki.tools)(e=Tegaki.tools[t]).keybind&&TegakiKeybinds.bind(e.keybind,e,"set")},getCursorPos:function(e,t){return 0===t?0|(e.clientX+window.pageXOffset+Tegaki.canvasCnt.scrollLeft-Tegaki.offsetX)/Tegaki.zoomFactor:0|(e.clientY+window.pageYOffset+Tegaki.canvasCnt.scrollTop-Tegaki.offsetY)/Tegaki.zoomFactor},resume:function(){Tegaki.saveReplay&&Tegaki.replayRecorder.start(),Tegaki.bg.classList.remove("tegaki-hidden"),document.body.classList.add("tegaki-backdrop"),Tegaki.setZoom(0),Tegaki.centerLayersCnt(),Tegaki.updatePosOffset(),Tegaki.bindGlobalEvents()},hide:function(){Tegaki.saveReplay&&Tegaki.replayRecorder.stop(),Tegaki.bg.classList.add("tegaki-hidden"),document.body.classList.remove("tegaki-backdrop"),Tegaki.unBindGlobalEvents()},destroy:function(){Tegaki.unBindGlobalEvents(),TegakiKeybinds.clear(),TegakiHistory.clear(),Tegaki.bg.parentNode.removeChild(Tegaki.bg),document.body.classList.remove("tegaki-backdrop"),Tegaki.startTimeStamp=0,Tegaki.bg=null,Tegaki.canvasCnt=null,Tegaki.layersCnt=null,Tegaki.canvas=null,Tegaki.ctx=null,Tegaki.layers=[],Tegaki.layerCounter=0,Tegaki.zoomLevel=0,Tegaki.zoomFactor=1,Tegaki.activeLayer=null,Tegaki.tool=null,TegakiCursor.destroy(),Tegaki.replayRecorder=null,Tegaki.replayViewer=null,Tegaki.destroyBuffers()},flatten:function(e){var t,a,i,s;for(e?i=e.canvas:e=(i=$T.el("canvas")).getContext("2d"),i.width=Tegaki.canvas.width,i.height=Tegaki.canvas.height,e.drawImage(Tegaki.canvas,0,0),t=0,s=Tegaki.layers.length;t<s;++t)(a=Tegaki.layers[t]).visible&&(e.globalAlpha=a.alpha,e.drawImage(a.canvas,0,0));return i},onReplayLoaded:function(){TegakiUI.clearMsg(),Tegaki.initFromReplay(),Tegaki.init(),Tegaki.setTool(Tegaki.defaultTool),TegakiUI.updateReplayControls(),TegakiUI.updateReplayTime(!0),TegakiUI.enableReplayControls(!0),Tegaki.replayViewer.play()},onReplayGaplessClick:function(){Tegaki.replayViewer.toggleGapless(),TegakiUI.updateReplayGapless()},onReplayPlayPauseClick:function(){Tegaki.replayViewer.togglePlayPause()},onReplayRewindClick:function(){Tegaki.replayViewer.rewind()},onReplaySlowDownClick:function(){Tegaki.replayViewer.slowDown(),TegakiUI.updateReplaySpeed()},onReplaySpeedUpClick:function(){Tegaki.replayViewer.speedUp(),TegakiUI.updateReplaySpeed()},onReplayTimeChanged:function(){TegakiUI.updateReplayTime()},onReplayPlayPauseChanged:function(){TegakiUI.updateReplayPlayPause()},onReplayReset:function(){Tegaki.initFromReplay(),Tegaki.setTool(Tegaki.defaultTool),Tegaki.resizeCanvas(Tegaki.baseWidth,Tegaki.baseHeight),TegakiUI.updateReplayControls(),TegakiUI.updateReplayTime()},onMainColorClick:function(e){e.preventDefault(),$T.id("tegaki-colorpicker").click()},onPaletteColorClick:function(e){2===e.button?(this.style.backgroundColor=Tegaki.toolColor,this.setAttribute("data-color",Tegaki.toolColor)):0===e.button&&Tegaki.setToolColor(this.getAttribute("data-color"))},onColorPicked:function(e){$T.id("tegaki-color").style.backgroundColor=this.value,Tegaki.setToolColor(this.value)},onSwitchPaletteClick:function(e){var t;t=e.target.hasAttribute("data-prev")?Tegaki.colorPaletteId-1:Tegaki.colorPaletteId+1,Tegaki.setColorPalette(t)},setColorPalette:function(e){e<0||e>=TegakiColorPalettes.length||(Tegaki.colorPaletteId=e,TegakiUI.updateColorPalette())},setToolSizeUp:function(){Tegaki.setToolSize(Tegaki.tool.size+1)},setToolSizeDown:function(){Tegaki.setToolSize(Tegaki.tool.size-1)},setToolSize:function(e){e>0&&e<=Tegaki.maxSize&&(Tegaki.tool.setSize(e),Tegaki.updateCursorStatus(),Tegaki.recordEvent(TegakiEventSetToolSize,performance.now(),e),TegakiUI.updateToolSize())},setToolAlpha:function(e){(e=Math.fround(e))>=0&&e<=1&&(Tegaki.tool.setAlpha(e),Tegaki.recordEvent(TegakiEventSetToolAlpha,performance.now(),e),TegakiUI.updateToolAlpha())},setToolFlow:function(e){(e=Math.fround(e))>=0&&e<=1&&(Tegaki.tool.setFlow(e),Tegaki.recordEvent(TegakiEventSetToolFlow,performance.now(),e),TegakiUI.updateToolFlow())},setToolColor:function(e){Tegaki.toolColor=e,$T.id("tegaki-color").style.backgroundColor=e,$T.id("tegaki-colorpicker").value=e,Tegaki.tool.setColor(e),Tegaki.recordEvent(TegakiEventSetColor,performance.now(),Tegaki.tool.rgb)},setToolColorRGB:function(e,t,a){Tegaki.setToolColor($T.RgbToHex(e,t,a))},setTool:function(e){Tegaki.tools[e].set()},setToolById:function(e){var t;for(t in Tegaki.tools)if(Tegaki.tools[t].id===e)return void Tegaki.setTool(t)},setZoom:function(e){var t;(t=e+Tegaki.zoomBaseLevel)>=Tegaki.zoomFactorList.length||t<0||!Tegaki.canvas||(Tegaki.zoomLevel=e,Tegaki.zoomFactor=Tegaki.zoomFactorList[t],TegakiUI.updateZoomLevel(),Tegaki.layersCnt.style.width=Math.ceil(Tegaki.baseWidth*Tegaki.zoomFactor)+"px",Tegaki.layersCnt.style.height=Math.ceil(Tegaki.baseHeight*Tegaki.zoomFactor)+"px",e<0?Tegaki.layersCnt.classList.add("tegaki-smooth-layers"):Tegaki.layersCnt.classList.remove("tegaki-smooth-layers"),Tegaki.updatePosOffset())},onZoomChange:function(){this.hasAttribute("data-in")?Tegaki.setZoom(Tegaki.zoomLevel+1):Tegaki.setZoom(Tegaki.zoomLevel-1)},onNewClick:function(){var e,t,a,i=Tegaki;(e=prompt(TegakiStrings.promptWidth,i.canvas.width))&&(t=prompt(TegakiStrings.promptHeight,i.canvas.height))&&(t=+t,(e=+e)<1||t<1?TegakiUI.printMsg(TegakiStrings.badDimensions):(a={},i.copyContextState(i.activeLayer.ctx,a),i.resizeCanvas(e,t),i.copyContextState(a,i.activeLayer.ctx),i.setZoom(0),TegakiHistory.clear(),TegakiUI.updateLayerPreviewSize(),i.startTimeStamp=Date.now(),i.saveReplay&&(i.createTools(),i.setTool(i.defaultTool),i.replayRecorder=new TegakiReplayRecorder,i.replayRecorder.start())))},onOpenClick:function(){(!(TegakiHistory.undoStack[0]||TegakiHistory.redoStack[0])&&!Tegaki.saveReplay||confirm(TegakiStrings.confirmChangeCanvas))&&$T.id("tegaki-filepicker").click()},loadReplayFromFile:function(){Tegaki.replayViewer.debugLoadLocal()},loadReplayFromURL:function(e){TegakiUI.printMsg(TegakiStrings.loadingReplay,0),Tegaki.replayViewer.loadFromURL(e)},onExportClick:function(){Tegaki.flatten().toBlob((function(e){var t=$T.el("a");t.className="tegaki-hidden",t.download=$T.generateFilename()+".png",t.href=URL.createObjectURL(e),Tegaki.bg.appendChild(t),t.click(),Tegaki.bg.removeChild(t)}),"image/png")},onUndoClick:function(){TegakiHistory.undo()},onRedoClick:function(){TegakiHistory.redo()},onHistoryChange:function(e,t,a=0){TegakiUI.updateUndoRedo(e,t),-1===a?Tegaki.recordEvent(TegakiEventUndo,performance.now()):1===a&&Tegaki.recordEvent(TegakiEventRedo,performance.now())},onDoneClick:function(){Tegaki.hide(),Tegaki.onDoneCb()},onCancelClick:function(){confirm(TegakiStrings.confirmCancel)&&(Tegaki.destroy(),Tegaki.onCancelCb())},onCloseViewerClick:function(){Tegaki.replayViewer.destroy(),Tegaki.destroy()},onToolSizeChange:function(){var e=+this.value;e<1?e=1:e>Tegaki.maxSize&&(e=Tegaki.maxSize),Tegaki.setToolSize(e)},onToolAlphaChange:function(e){var t=+this.value;(t/=100)<0?t=0:t>1&&(t=1),Tegaki.setToolAlpha(t)},onToolFlowChange:function(e){var t=+this.value;(t/=100)<0?t=0:t>1&&(t=1),Tegaki.setToolFlow(t)},onToolPressureSizeClick:function(e){Tegaki.tool.useSizeDynamics&&Tegaki.setToolSizeDynamics(!Tegaki.tool.sizeDynamicsEnabled)},setToolSizeDynamics:function(e){Tegaki.tool.setSizeDynamics(e),TegakiUI.updateToolDynamics(),Tegaki.recordEvent(TegakiEventSetToolSizeDynamics,performance.now(),+e)},onToolPressureAlphaClick:function(e){Tegaki.tool.useAlphaDynamics&&Tegaki.setToolAlphaDynamics(!Tegaki.tool.alphaDynamicsEnabled)},setToolAlphaDynamics:function(e){Tegaki.tool.setAlphaDynamics(e),TegakiUI.updateToolDynamics(),Tegaki.recordEvent(TegakiEventSetToolAlphaDynamics,performance.now(),+e)},onToolPressureFlowClick:function(e){Tegaki.tool.useFlowDynamics&&Tegaki.setToolFlowDynamics(!Tegaki.tool.flowDynamicsEnabled)},setToolFlowDynamics:function(e){Tegaki.tool.setFlowDynamics(e),TegakiUI.updateToolDynamics(),Tegaki.recordEvent(TegakiEventSetToolFlowDynamics,performance.now(),+e)},onToolPreserveAlphaClick:function(e){Tegaki.tool.usePreserveAlpha&&Tegaki.setToolPreserveAlpha(!Tegaki.tool.preserveAlphaEnabled)},setToolPreserveAlpha:function(e){Tegaki.tool.setPreserveAlpha(e),TegakiUI.updateToolPreserveAlpha(),Tegaki.recordEvent(TegakiEventPreserveAlpha,performance.now(),+e)},onToolTipClick:function(e){var t=+e.target.getAttribute("data-id");t!==Tegaki.tool.tipId&&Tegaki.setToolTip(t)},setToolTip:function(e){Tegaki.tool.setTip(e),TegakiUI.updateToolShape(),Tegaki.recordEvent(TegakiEventSetToolTip,performance.now(),e)},onLayerSelectorClick:function(e){var t=+this.getAttribute("data-id");t&&!e.target.classList.contains("tegaki-ui-cb")&&(e.ctrlKey?Tegaki.toggleSelectedLayer(t):Tegaki.setActiveLayer(t))},toggleSelectedLayer:function(e){TegakiLayers.selectedLayersToggle(e),Tegaki.recordEvent(TegakiEventToggleLayerSelection,performance.now(),e)},setActiveLayer:function(e){TegakiLayers.setActiveLayer(e),Tegaki.recordEvent(TegakiEventSetActiveLayer,performance.now(),e)},onLayerAlphaDragStart:function(e){TegakiUI.setupDragLabel(e,Tegaki.onLayerAlphaDragMove)},onLayerAlphaDragMove:function(e){var t;e&&((t=Tegaki.activeLayer.alpha+e/100)<0?t=0:t>1&&(t=1),Tegaki.setSelectedLayersAlpha(t))},onLayerAlphaChange:function(){var e=+this.value;(e/=100)<0?e=0:e>1&&(e=1),Tegaki.setSelectedLayersAlpha(e)},setSelectedLayersAlpha:function(e){var t,a,i;if((e=Math.fround(e))>=0&&e<=1&&Tegaki.selectedLayers.size>0){for(a of(i=[],Tegaki.selectedLayers))(t=TegakiLayers.getLayerById(a))&&(i.push([t.id,t.alpha]),TegakiLayers.setLayerAlpha(t,e));TegakiUI.updateLayerAlphaOpt(),TegakiHistory.push(new TegakiHistoryActions.SetLayersAlpha(i,e)),Tegaki.recordEvent(TegakiEventSetSelectedLayersAlpha,performance.now(),e)}},onLayerNameChangeClick:function(e){var t,a,i;t=+this.getAttribute("data-id"),(i=TegakiLayers.getLayerById(t))&&(a=prompt(void 0,i.name))&&Tegaki.setLayerName(t,a)},setLayerName:function(e,t){var a,i;t=t.trim().slice(0,25),(i=TegakiLayers.getLayerById(e))&&t&&t!==i.name&&(a=i.name,i.name=t,TegakiUI.updateLayerName(i),TegakiHistory.push(new TegakiHistoryActions.SetLayerName(e,a,t)),Tegaki.recordEvent(TegakiEventHistoryDummy,performance.now()))},onLayerAddClick:function(){Tegaki.addLayer()},addLayer:function(){var e;Tegaki.layers.length>=Tegaki.maxLayers?TegakiUI.printMsg(TegakiStrings.tooManyLayers):(TegakiHistory.push(e=TegakiLayers.addLayer()),TegakiLayers.setActiveLayer(e.aLayerIdAfter),Tegaki.recordEvent(TegakiEventAddLayer,performance.now()))},onLayerDeleteClick:function(){Tegaki.deleteSelectedLayers()},deleteSelectedLayers:function(){var e,t;(t=Tegaki.selectedLayers).size!==Tegaki.layers.length&&(!t.size||Tegaki.layers.length<2||(TegakiHistory.push(e=TegakiLayers.deleteLayers(t)),TegakiLayers.selectedLayersClear(),TegakiLayers.setActiveLayer(e.aLayerIdAfter),Tegaki.recordEvent(TegakiEventDeleteLayers,performance.now())))},onLayerToggleVisibilityClick:function(){Tegaki.toggleLayerVisibility(+this.getAttribute("data-id"))},toggleLayerVisibility:function(e){var t=TegakiLayers.getLayerById(e);TegakiLayers.setLayerVisibility(t,!t.visible),Tegaki.recordEvent(TegakiEventToggleLayerVisibility,performance.now(),e)},onMergeLayersClick:function(){Tegaki.mergeSelectedLayers()},mergeSelectedLayers:function(){var e;Tegaki.selectedLayers.size&&(e=TegakiLayers.mergeLayers(Tegaki.selectedLayers))&&(TegakiHistory.push(e),TegakiLayers.setActiveLayer(e.aLayerIdAfter),Tegaki.recordEvent(TegakiEventMergeLayers,performance.now()))},onMoveLayerClick:function(e){var t,a;Tegaki.selectedLayers.size&&(a=e.target.hasAttribute("data-up"),(t=TegakiLayers.getSelectedEdgeLayerPos(a))<0||(a?t+=2:t>=1&&t--,Tegaki.moveSelectedLayers(t)))},moveSelectedLayers:function(e){TegakiHistory.push(TegakiLayers.moveLayers(Tegaki.selectedLayers,e)),Tegaki.recordEvent(TegakiEventMoveLayers,performance.now(),e)},onToolClick:function(){Tegaki.setTool(this.getAttribute("data-tool"))},onToolChanged:function(e){var t;Tegaki.tool=e,(t=$T.cls("tegaki-tool-active")[0])&&t.classList.remove("tegaki-tool-active"),$T.id("tegaki-tool-btn-"+e.name).classList.add("tegaki-tool-active"),Tegaki.recordEvent(TegakiEventSetTool,performance.now(),Tegaki.tool.id),TegakiUI.onToolChanged(),Tegaki.updateCursorStatus()},onLayerStackChanged:function(){TegakiCursor.invalidateCache()},onOpenFileSelected:function(){var e;this.files&&this.files[0]&&((e=new Image).onload=Tegaki.onOpenImageLoaded,e.onerror=Tegaki.onOpenImageError,e.src=URL.createObjectURL(this.files[0]))},onOpenImageLoaded:function(){var e={},t=Tegaki;t.hasCustomCanvas=!0,t.copyContextState(t.activeLayer.ctx,e),t.resizeCanvas(this.naturalWidth,this.naturalHeight),t.activeLayer.ctx.drawImage(this,0,0),TegakiLayers.syncLayerImageData(t.activeLayer),t.copyContextState(e,t.activeLayer.ctx),t.setZoom(0),TegakiHistory.clear(),TegakiUI.updateLayerPreviewSize(!0),t.startTimeStamp=Date.now(),t.saveReplay&&(t.replayRecorder.stop(),t.replayRecorder=null,t.saveReplay=!1,TegakiUI.setRecordingStatus(!1))},onOpenImageError:function(){TegakiUI.printMsg(TegakiStrings.errorLoadImage)},resizeCanvas:function(e,t){Tegaki.baseWidth=e,Tegaki.baseHeight=t,Tegaki.createBuffers(),Tegaki.canvas.width=e,Tegaki.canvas.height=t,TegakiCursor.updateCanvasSize(e,t),Tegaki.ctx.fillStyle=Tegaki.bgColor,Tegaki.ctx.fillRect(0,0,e,t),Tegaki.activeLayer=null,Tegaki.resetLayers(),Tegaki.centerLayersCnt(),Tegaki.updatePosOffset()},copyContextState:function(e,t){var a,i,s=["lineCap","lineJoin","strokeStyle","fillStyle","globalAlpha","lineWidth","globalCompositeOperation"];for(a=0;i=s[a];++a)t[i]=e[i]},updateCursorStatus:function(){!Tegaki.tool.noCursor&&Tegaki.tool.size>1?(Tegaki.cursor=!0,TegakiCursor.generate(Tegaki.tool.size)):(Tegaki.cursor=!1,$T.clearCtx(TegakiCursor.cursorCtx))},updatePosOffset:function(){var e=Tegaki.canvas.getBoundingClientRect();Tegaki.offsetX=e.left+window.pageXOffset+Tegaki.canvasCnt.scrollLeft+Tegaki.layersCnt.scrollLeft,Tegaki.offsetY=e.top+window.pageYOffset+Tegaki.canvasCnt.scrollTop+Tegaki.layersCnt.scrollTop},isScrollbarClick:function(e){var t,a;return t=Tegaki.canvasCnt.offsetWidth-Tegaki.canvasCnt.clientWidth,a=Tegaki.canvasCnt.offsetHeight-Tegaki.canvasCnt.clientHeight,t>0&&e.clientX>=Tegaki.canvasCnt.offsetLeft+Tegaki.canvasCnt.clientWidth&&e.clientX<=Tegaki.canvasCnt.offsetLeft+Tegaki.canvasCnt.clientWidth+t||a>0&&e.clientY>=Tegaki.canvasCnt.offsetTop+Tegaki.canvasCnt.clientHeight&&e.clientY<=Tegaki.canvasCnt.offsetTop+Tegaki.canvasCnt.clientHeight+t},onPointerMove:function(e){var t,a,i,s,n,o;if(void 0!==e.mozInputSource){if(Tegaki.activePointerIsPen&&"mouse"===e.pointerType)return}else if(Tegaki.activePointerId!==e.pointerId)return void(Tegaki.activePointerId=e.pointerId);if(Tegaki.isPainting)if(s=Tegaki.tool,Tegaki.activePointerIsPen&&e.getCoalescedEvents)for(e of(t=e.getCoalescedEvents(),n=e.timeStamp,t))a=Tegaki.getCursorPos(e,0),i=Tegaki.getCursorPos(e,1),s.enabledDynamics()?(o=TegakiPressure.toShort(e.pressure),TegakiPressure.push(o),Tegaki.recordEvent(TegakiEventDraw,n,a,i,o)):Tegaki.recordEvent(TegakiEventDrawNoP,n,a,i),s.draw(a,i);else a=Tegaki.getCursorPos(e,0),i=Tegaki.getCursorPos(e,1),o=TegakiPressure.toShort(e.pressure),Tegaki.recordEvent(TegakiEventDraw,e.timeStamp,a,i,o),TegakiPressure.push(o),s.draw(a,i);else a=Tegaki.getCursorPos(e,0),i=Tegaki.getCursorPos(e,1);Tegaki.cursor&&TegakiCursor.render(a,i)},onPointerDown:function(e){var t,a,i,s;Tegaki.isScrollbarClick(e)||(Tegaki.activePointerId=e.pointerId,Tegaki.activePointerIsPen="pen"===e.pointerType,null!==Tegaki.activeLayer?TegakiLayers.getActiveLayer().visible?(t=Tegaki.getCursorPos(e,0),a=Tegaki.getCursorPos(e,1),2===e.button||e.altKey?(e.preventDefault(),Tegaki.isPainting=!1,Tegaki.tools.pipette.draw(t,a)):0===e.button&&(e.preventDefault(),(i=Tegaki.tool).enabledDynamics()?(s=TegakiPressure.toShort(e.pressure),TegakiPressure.push(s),Tegaki.recordEvent(TegakiEventDrawStart,e.timeStamp,t,a,s)):Tegaki.recordEvent(TegakiEventDrawStartNoP,e.timeStamp,t,a),Tegaki.isPainting=!0,TegakiHistory.pendingAction=new TegakiHistoryActions.Draw(Tegaki.activeLayer.id),TegakiHistory.pendingAction.addCanvasState(Tegaki.activeLayer.imageData,0),i.start(t,a)),Tegaki.cursor&&TegakiCursor.render(t,a)):e.target.parentNode===Tegaki.layersCnt&&TegakiUI.printMsg(TegakiStrings.hiddenActiveLayer):e.target.parentNode===Tegaki.layersCnt&&TegakiUI.printMsg(TegakiStrings.noActiveLayer))},onPointerUp:function(e){Tegaki.activePointerId=e.pointerId,Tegaki.activePointerIsPen=!1,Tegaki.isPainting&&(Tegaki.recordEvent(TegakiEventDrawCommit,e.timeStamp),Tegaki.tool.commit(),TegakiUI.updateLayerPreview(Tegaki.activeLayer),TegakiHistory.pendingAction.addCanvasState(Tegaki.activeLayer.imageData,1),TegakiHistory.push(TegakiHistory.pendingAction),Tegaki.isPainting=!1)},onDummy:function(e){e.preventDefault(),e.stopPropagation()},recordEvent(e,...t){Tegaki.replayRecorder&&Tegaki.replayRecorder.push(new e(...t))}},TegakiColorPalettes=[["#ffffff","#000000","#888888","#b47575","#c096c0","#fa9696","#8080ff","#ffb6ff","#e7e58d","#25c7c9","#99cb7b","#e7962d","#f9ddcf","#fcece2"],["#000000","#ffffff","#7f7f7f","#c3c3c3","#880015","#b97a57","#ed1c24","#ffaec9","#ff7f27","#ffc90e","#fff200","#efe4b0","#22b14c","#b5e61d","#00a2e8","#99d9ea","#3f48cc","#7092be","#a349a4","#c8bfe7"],["#000000","#ffffff","#8a8a8a","#cacaca","#fcece2","#f9ddcf","#e0a899","#a05b53","#7a444a","#960018","#c41e3a","#de4537","#ff3300","#ff9800","#ffc107","#ffd700","#ffeb3b","#ffffcc","#f3e5ab","#cddc39","#8bc34a","#4caf50","#3e8948","#355e3b","#3eb489","#f0f8ff","#87ceeb","#6699cc","#007fff","#2d68c4","#364478","#352c4a","#9c27b0","#da70d6","#ff0090","#fa8072","#f19cbb","#c78b95"]];async function videoThumbnail(e){return new Promise(((t,a)=>{const i=document.createElement("video");i.setAttribute("src",URL.createObjectURL(e)),i.load(),i.addEventListener("error",(e=>{a(e)})),i.addEventListener("loadedmetadata",(()=>{setTimeout((()=>{i.currentTime=0}),500),i.addEventListener("seeked",(()=>{const e=document.createElement("canvas");e.width=i.videoWidth,e.height=i.videoHeight;const a=e.getContext("2d");a.drawImage(i,0,0,e.width,e.height),a.canvas.toBlob((e=>{t(e)}))}))}))}))}function doModal(e,t,a){try{const i=modal({modal:e});let s;document.body.insertAdjacentHTML("afterbegin",i);const n=document.getElementsByClassName("modal"),o=document.getElementsByClassName("modal-bg");if(window.dispatchEvent(new CustomEvent("showModal",{detail:{modal:n[0]}})),n.length>1){const e=parseInt(document.defaultView.getComputedStyle(n[1],null).getPropertyValue("z-index"));n[0].style.zIndex=e+3,o[0].style.zIndex=e+2}null!=a&&a(),document.getElementById("modalclose").onclick=()=>{removeModal(),clearInterval(s)},document.getElementsByClassName("modal-bg")[0].onclick=()=>{removeModal(),clearInterval(s)};const r=document.getElementById("modalframe");r&&("default"===localStorage.getItem("theme")&&(r.onload=()=>{const e=document.head.querySelector("#theme").href;r.contentDocument.styleSheets[1].ownerNode.href=e}),t&&(s=setInterval((()=>{r&&"Success"==r.contentDocument.title&&(clearInterval(s),removeModal(),t())}),100)))}catch(e){console.error(e)}}const modalClasses=["modal","modal-bg"];function removeModal(){modalClasses.forEach((e=>document.getElementsByClassName(e)[0].remove()))}let recaptchaResponse=null;function recaptchaCallback(e){recaptchaResponse=e}let tegakiWidth=localStorage.getItem("tegakiwidth-setting"),tegakiHeight=localStorage.getItem("tegakiheight-setting");class postFormHandler{constructor(e){this.form=e,this.resetOnSubmit="true"==this.form.dataset.resetOnSubmit,this.enctype=this.form.getAttribute("enctype"),this.messageBox=e.querySelector("#message"),this.minimal=this.form.elements.minimal,this.files=[],this.submit=e.querySelector('input[type="submit"]'),this.submit&&(this.originalSubmitText=this.submit.value),this.captchaField=e.querySelector(".captchafield")||e.querySelector(".g-recaptcha")||e.querySelector(".h-captcha"),this.tegakiButton=e.querySelector(".tegaki-button"),this.tegakiButton&&this.tegakiButton.addEventListener("click",(()=>this.doTegaki())),this.fileInput=e.querySelector('input[type="file"]'),this.fileInput&&(this.fileRequired=this.fileInput.required,this.fileLabel=this.fileInput.previousSibling,this.fileUploadList=this.fileInput.nextSibling,this.multipleFiles=this.fileLabel.parentNode.previousSibling.firstChild.textContent.endsWith("s"),this.fileLabelText=this.fileLabel.childNodes[0],this.fileLabel.addEventListener("dragover",(e=>this.fileLabelDrag(e))),this.fileLabel.addEventListener("drop",(e=>this.fileLabelDrop(e))),this.fileInput.addEventListener("change",(e=>this.fileInputChange(e))),this.fileLabel.addEventListener("auxclick",(e=>this.fileLabelAuxclick(e))),e.addEventListener("paste",(e=>this.paste(e)))),this.customFlagInput=this.form.elements.customflag,this.selectedFlagImage=document.getElementById("selected-flag"),this.customFlagInput&&this.selectedFlagImage&&(this.customFlagInput.addEventListener("change",(()=>this.updateFlagField()),!1),this.updateFlagField()),this.messageBox&&this.messageBox.addEventListener("keydown",(e=>this.controlEnterSubmit(e))),e.addEventListener("submit",(e=>this.formSubmit(e)))}reset(){this.form.reset(),this.updateFlagField(),this.updateMessageBox(),this.files=[],this.updateFilesText();const e=this.form.querySelector(".captcharefresh");e&&e.dispatchEvent(new Event("click"))}doTegaki(){Tegaki.open({onCancel:()=>{},onDone:()=>{Tegaki.flatten().toBlob((e=>{this.addFile(new File([e],"tegaki.png",{type:"image/png"})),this.updateFilesText(),Tegaki.resetLayers()}),"image/png")},width:tegakiWidth,height:tegakiHeight}),Tegaki.resetLayers(),Tegaki.setColorPalette(2)}updateFlagField(){this.customFlagInput&&-1!==this.customFlagInput.options.selectedIndex&&(this.selectedFlagImage.src=this.customFlagInput.options[this.customFlagInput.options.selectedIndex].dataset.src||"")}controlEnterSubmit(e){e.ctrlKey&&"Enter"===e.key&&this.formSubmit(e)}formSubmit(e){const t=recaptchaResponse;let a;if("multipart/form-data"===this.enctype){if(this.fileInput&&(this.fileInput.disabled=!0),a=new FormData(this.form),t&&a.append("captcha",t),this.fileInput&&(this.fileInput.disabled=!1),this.files&&this.files.length>0)for(let e=0;e<this.files.length;e++)a.append("file",this.files[e])}else a=new URLSearchParams([...new FormData(this.form)]),t&&a.set("captcha",t);if(this.minimal||a instanceof URLSearchParams&&"1"===a.get("edit"))return!0;e.preventDefault();const i=new XMLHttpRequest;this.submit.disabled=!0,this.submit.value="Processing...",this.files&&this.files.length>0&&(i.onloadstart=()=>{this.submit.value="0%"},i.upload.onprogress=e=>{const t=Math.floor(e.loaded/e.total*100);this.submit.value=`${t}%`},i.onload=()=>{this.submit.value=this.originalSubmitText}),i.onreadystatechange=()=>{if(4===i.readyState){let a;if(t&&grecaptcha?grecaptcha.reset():t&&hcaptcha&&hcaptcha.reset(),"false"===i.getResponseHeader("x-captcha-enabled")&&(captchaController.removeCaptcha(),this.captchaField=null),this.submit.disabled=!1,this.submit.value=this.originalSubmitText,i.responseText)try{a=JSON.parse(i.responseText)}catch(e){}if(a)if(200==i.status){if(a.postId&&(window.myPostId=a.postId),a.redirect){const e=a.redirect.split("/")[1],t=a.redirect.split("#")[1];e&&t&&appendLocalStorageArray("yous",`${e}-${t}`)}if(a.message||a.messages||a.error||a.errors)doModal(a);else if(socket&&socket.connected)window.location.hash=a.postId;else{if(!isThread)return window.location=a.redirect;setLocalStorage("myPostId",a.postId),forceUpdate()}this.resetOnSubmit&&this.reset()}else if(this.captchaField||"Incorrect captcha answer"!==a.message)if("Captcha expired"===a.message){const e=this.form.querySelector(".captcharefresh");e&&e.dispatchEvent(new Event("click"))}else a.bans?doModal(a,null,(()=>{const e=document.getElementById("modalbanned").querySelector("form"),t=new postFormHandler(e);for(let e of t.form.elements)"checkbox"===e.type&&(e.checked=!0);const a=t.captchaField;a&&captchaController.setupCaptchaField(a)})):doModal(a,(()=>{this.formSubmit(e)}));else captchaController.addMissingCaptcha(),this.captchaField=!0;else{if(i.responseURL&&i.responseURL!==`${location.origin}${this.form.getAttribute("action")}`)return window.location=i.responseURL;413===i.status?doModal({title:"Payload Too Large",message:"Your upload was too large"}):doModal({title:"Error",message:"Something broke"})}this.submit.value=this.originalSubmitText}},i.onerror=e=>{console.error(e),doModal({title:"Error",message:"Something broke"}),this.submit.disabled=!1,this.submit.value=this.originalSubmitText},i.open(this.form.getAttribute("method"),this.form.getAttribute("action"),!0),this.minimal||i.setRequestHeader("x-using-xhr",!0);"true"==localStorage.getItem("live")&&socket&&socket.connected&&i.setRequestHeader("x-using-live",!0),"multipart/form-data"!==this.enctype&&i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.send(a)}updateMessageBox(){this.messageBox&&this.messageBox.dispatchEvent(new Event("input"))}removeFile(e,t,a){let i;e.remove(),this.files.find(((e,s)=>{e.name===t&&e.size===a&&(i=s)})),this.files.splice(i,1),this.updateFilesText()}async addFile(e){let t;if(this.fileRequired&&this.fileInput.removeAttribute("required"),this.files.push(e),console.log("got file",e.name),window.crypto.subtle){let a;if(e.arryaBuffer)a=await e.arrayBuffer();else{const t=new FileReader;await new Promise((a=>{t.addEventListener("loadend",a),t.readAsArrayBuffer(e)})),t.result&&(a=t.result)}const i=await window.crypto.subtle.digest("SHA-256",a);t=Array.from(new Uint8Array(i)).map((e=>e.toString(16).padStart(2,"0"))).join(""),console.log("file hash",t)}const a={spoilers:"true"===this.fileUploadList.dataset.spoilers,stripFilenames:"true"===this.fileUploadList.dataset.stripFilenames,name:e.name,hash:t};switch(e.type.split("/")[0]){case"image":a.url=URL.createObjectURL(e);break;case"audio":a.url="/file/audio.png";break;case"video":try{const t=await videoThumbnail(e);a.url=URL.createObjectURL(t)}catch(e){a.url="/file/video.png"}break;default:a.url="/file/attachment.png"}const i=uploaditem({uploaditem:a});this.fileUploadList.insertAdjacentHTML("beforeend",i);const s=this.fileUploadList.lastChild;s.querySelector(".close").addEventListener("click",(()=>{this.removeFile(s,e.name,e.size)})),this.fileUploadList.style.display="unset"}updateFilesText(){this.fileLabelText&&(this.files&&0===this.files.length?(this.fileUploadList.textContent="",this.fileUploadList.style.display="none",this.fileLabelText.nodeValue="Select/Drop/Paste file"+(this.multipleFiles?"s":"")):this.fileLabelText.nodeValue=`${this.files.length} file${this.files.length>1?"s":""} selected`,this.fileInput.value=null)}clearFiles(){this.fileInput&&(this.files=[],this.fileInput.value=null,this.fileRequired&&this.fileInput.setAttribute("required",!0),this.updateFilesText())}paste(e){const t=e.clipboardData;if(t.items&&t.items.length>0){const e=t.items;for(let t=0;t<e.length;t++){const a=e[t];if("file"===a.kind){const e=new File([a.getAsFile()],"ClipboardImage.png",{type:a.type});this.addFile(e)}}this.updateFilesText()}}fileLabelDrag(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}fileLabelDrop(e){e.stopPropagation(),e.preventDefault();const t=e.dataTransfer.files;for(let e=0;e<t.length;e++)this.addFile(t[e]);this.updateFilesText()}fileInputChange(){const e=this.fileInput.files;for(let t=0;t<e.length;t++)this.addFile(e[t]);this.updateFilesText()}fileLabelAuxclick(e){1===e.button&&this.clearFiles()}}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}window.addEventListener("DOMContentLoaded",(()=>{const e=localStorage.getItem("myPostId");e&&(window.location.hash=e,localStorage.removeItem("myPostId")),window.addEventListener("addPost",(e=>{e.detail.hover||window.myPostId==e.detail.postId&&(window.location.hash=e.detail.postId,e.detail.post.previousSibling.scrollIntoView())}))})),window.addEventListener("settingsReady",(()=>{const e=document.getElementsByTagName("form");for(let t=0;t<e.length;t++)"post"===e[t].method&&new postFormHandler(e[t]);const t=document.getElementById("tegakiwidth-setting");t.value=tegakiWidth,t.addEventListener("change",(e=>{tegakiWidth=parseInt(e.target.value),setLocalStorage("tegakiwidth-setting",tegakiWidth)}),!1);const a=document.getElementById("tegakiheight-setting");a.value=tegakiHeight,a.addEventListener("change",(e=>{tegakiHeight=parseInt(e.target.value),setLocalStorage("tegakiheight-setting",tegakiHeight)}),!1)}));pug_match_html=/["&<>]/;function captchaformsection(e){var t="",a={},i=e||{};return function(e,i,s,n,o){a.captchaexpand=function(){this&&this.block,this&&this.attributes;switch(t+='<details class="row label mr-0"><summary class="pv-5">Captcha<span class="required">*</span></summary>',i){case"google":t=t+'<div class="g-recaptcha"'+pug_attr("data-sitekey",`${s}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"hcaptcha":t=t+'<div class="h-captcha"'+pug_attr("data-sitekey",`${n}`,!0,!1)+' data-theme="dark" data-size="compact" data-callback="recaptchaCallback"></div><noscript>Please enable JavaScript to solve the captcha.</noscript>';break;case"text":t=t+'<noscript class="no-m-p"><iframe class="captcha" src="/captcha.html"'+pug_attr("width=210",!0,!0,!1)+' height="80" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none;"></div><input class="captchafield" type="text" name="captcha" autocomplete="off" placeholder="Captcha text" pattern=".{6}"'+pug_attr("required",!0,!0,!1)+' title="6 characters"/>';break;case"grid":o||(t+='<a class="text-center" href="/faq.html#captcha">Instructions</a>'),t+='<div class="catalog"><noscript class="no-m-p"><iframe class="captcha" src="/captcha.html" width="150" height="150" scrolling="no" loading="lazy"></iframe></noscript><div class="jsonly captcha" style="display:none"></div><div class="captchafield noselect">';for(let a=0;a<e**2;a++)t=t+'<label class="captchachecklabel"><input type="checkbox" name="captcha"'+pug_attr("value",a,!0,!1)+'/><span class="captchacheckbox"></span></label>';t+="</div></div>"}t+="</details>"},a.captchaexpand()}.call(this,"captchaGridSize"in i?i.captchaGridSize:4,"captchaType"in i?i.captchaType:"text","googleRecaptchaSiteKey"in i?i.googleRecaptchaSiteKey:"undefined"!=typeof googleRecaptchaSiteKey?googleRecaptchaSiteKey:void 0,"hcaptchaSiteKey"in i?i.hcaptchaSiteKey:"undefined"!=typeof hcaptchaSiteKey?hcaptchaSiteKey:void 0,"minimal"in i?i.minimal:"undefined"!=typeof minimal?minimal:void 0),t}window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("message");if(e){const t=e.previousSibling,a=e.getAttribute("maxlength"),i=e.getAttribute("minlength");let s=e.value.length;const n=document.createElement("small");t.appendChild(n);const o=()=>{n.innerText=`(${s}/${a})`,s>=a||s<i?n.style.color="red":n.removeAttribute("style")},r=function(){e.value.length>a&&(e.value=e.value.substring(0,a)),s=e.value.length,o()};o(),e.addEventListener("input",r)}}));const renderCSSLink=document.createElement("style");renderCSSLink.type="text/css",renderCSSLink.id="rendercss",document.head.appendChild(renderCSSLink);const renderSheet=renderCSSLink.sheet,rulesKey=renderSheet.rules?"rules":"cssRules";class CssToggle{constructor(e,t,a,i){this.localStorageKey=t,this.localStorageDefault=a,setDefaultLocalStorage(this.localStorageKey,this.localStorageDefault),this.settingBoolean="true"==localStorage.getItem(this.localStorageKey),this.settingCss=i,window.addEventListener("settingsReady",(()=>{this.setting=document.getElementById(e),this.setting.checked=this.settingBoolean,this.setting.addEventListener("change",(()=>{this.toggle()}),!1)})),this.apply()}toggle(){this.settingBoolean=!this.settingBoolean,console.log("toggling",this.localStorageKey,this.settingBoolean),this.apply(),setLocalStorage(this.localStorageKey,this.settingBoolean)}apply(){if(this.settingBoolean)renderSheet.insertRule(this.settingCss);else for(let e=0;e<renderSheet[rulesKey].length;e++)renderSheet[rulesKey][e].selectorText==this.settingCss.split(" {")[0]&&renderSheet.deleteRule(e)}}const hidePostStubsCss=".post-container.hidden, .catalog-tile.hidden { display: none;margin-top: -1.5em;height: 0; }",hideDeletedPostContentCss='.post-container.marked[data-mark="Deleted"] .post-data { display: none; }',hideThumbnailsCss=".file-thumb, .catalog-thumb { visibility: hidden !important; }",hideRecursiveCss=".op.hidden ~ .anchor, .op.hidden ~ .post-container { display: none; }",heightUnlimitCss="img, video { max-height: unset; }",crispCss="img { image-rendering: crisp-edges; }",nonColorIdsCss=".user-id { background: transparent none repeat scroll 0% 0% !important; border-color: transparent; text-shadow: none; color: var(--font-color); }",alwaysShowSpoilersCss=".spoiler { color: var(--font-color) !important; background: transparent none repeat scroll 0% 0%; outline: 1px solid black; cursor: auto; }",smoothScrollingCss="html { scroll-behavior: smooth; }",threadWatcherCss="#threadwatcher { display: flex; }";let hoverCacheList;new CssToggle("hiderecursive-setting","hiderecursive",settings.hideRecursive,hideRecursiveCss),new CssToggle("heightlimit-setting","heightlimit",settings.heightUnlimit,heightUnlimitCss),new CssToggle("crispimages-setting","crispimages",settings.crispImages,crispCss),new CssToggle("hidethumbnails-setting","hidethumbnails",settings.hideThumbnails,hideThumbnailsCss),new CssToggle("noncolorids-setting","noncolorids",settings.nonColorIds,nonColorIdsCss),new CssToggle("alwaysshowspoilers-setting","alwaysshowspoilers",settings.alwaysShowSpoilers,alwaysShowSpoilersCss),new CssToggle("hidepoststubs-setting","hidepoststubs",settings.hidePostStubs,hidePostStubsCss),new CssToggle("hidedeletedpostcontent-setting","hidedeletedpostcontent",settings.hideDeletedPostContent,hideDeletedPostContentCss),new CssToggle("smoothscrolling-setting","smoothscrolling",settings.smoothScrolling,smoothScrollingCss),new CssToggle("threadwatcher-setting","threadwatcher",settings.threadWatcher,threadWatcherCss),isCatalog||window.addEventListener("DOMContentLoaded",(()=>{const e=".post-message a:not(.quote)",t=[{linkRegex:/^https?:\/\/(?:www\.|m\.)?(?:youtube\.com|youtu\.?be)\//i,toHtml:e=>{try{const t=new URL(e),a=t.searchParams.get("v")||("youtu.be"===t.hostname?t.pathname.substring(1):null);if(a&&11===a.length)return`<iframe class="embed-video" src="https://www.youtube.com/embed/${encodeURIComponent(a)}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" style="display:block;" allowfullscreen></iframe>`}catch(e){}return null}},{linkRegex:/^https?:\/\/(?:www\.)?bitchute\.com\/video\/[a-z0-9]{12}\//i,toHtml:e=>{try{const t=new URL(e).pathname.split("/")[2];if(t)return`<iframe class="embed-video" src="https://www.bitchute.com/embed/${encodeURIComponent(t)}/" frameborder="0" scrolling="no" style="display:block;" allowfullscreen></iframe>`}catch(e){}return null}}],a=(e,t)=>{"true"===e.dataset.open?(e.nextSibling.remove(),e.firstElementChild.textContent="Embed"):(e.insertAdjacentHTML("afterend",t),e.firstElementChild.textContent="Close"),e.dataset.open="true"===e.dataset.open?"false":"true"},i=e=>{for(let i=0;i<e.length;i++){const s=t.find((t=>t.linkRegex.test(e[i].href)));if(!s)continue;const n=s.toHtml(e[i].href);if(n){const t=document.createElement("span"),s=document.createTextNode("["),o=document.createElement("a"),r=document.createTextNode("]");t.classList.add("ml-5","noselect","bold"),o.classList.add("dummy-link"),o.textContent="Embed",t.appendChild(s),t.appendChild(o),t.appendChild(r),e[i].parentNode.insertBefore(t,e[i].nextSibling),o.addEventListener("click",(()=>a(t,n)),!1)}}},s=Array.from(document.querySelectorAll(e));i(s);const n=t=>{if(t.detail.hover)return;const a=Array.from(t.detail.post.querySelectorAll(e)).filter((e=>!(e.nextSibling&&e.nextSibling.classList&&e.nextSibling.classList.contains("dummy-link"))));i(a)};window.addEventListener("addPost",n),window.addEventListener("updatePostMessage",n)})),window.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#action-menu");e&&e.addEventListener("click",(()=>{e.parentElement.classList.contains("floatactions")?e.parentElement.classList.remove("floatactions"):e.scrollIntoView()}),!1);const t=document.getElementById("volume-setting");let a=localStorage.getItem("volume");t.value=a,t.addEventListener("change",(()=>{a=t.value;const e=document.querySelectorAll("audio,video");for(let t=0;t<e.length;t++)e[t].volume=a/100;console.log("adjusting default volume",a),setLocalStorage("volume",a)}),!1);const i=document.getElementById("loop-setting");let s="true"==localStorage.getItem("loop");i.checked=s,i.addEventListener("change",(()=>{s=i.checked,console.log("toggling video/audio looping",s),setLocalStorage("loop",s)}),!1);const n=document.getElementById("imageloadingbars-setting");let o="true"==localStorage.getItem("imageloadingbars");if(n.checked=o,n.addEventListener("change",(()=>{o=n.checked,console.log("toggling video/audio imageloadingbarsing",o),setLocalStorage("imageloadingbars",o)}),!1),!isCatalog){const e=document.getElementsByClassName("post-file-src"),t=function(e,t,i,n){"none"===e.style.display?(e.style.display="",t.style.display="none",i.style.maxWidth=""):(e.style.display="none",t.style.display="",t.offsetWidth>=i.offsetWidth&&(i.style.maxWidth=t.offsetWidth+"px"));const o="[Close]"===e.nextSibling.textContent?e.nextSibling:null;o&&(t.loop=s,t.volume=a/100,"hidden"===n.style.visibility?(n.style.visibility="visible",o.style.display="none",t.pause()):(n.style.visibility="hidden",o.style.display="block",t.play()))},i=function(e){if("VIDEO"===e.target.nodeName||"AUDIO"===e.target.nodeName)return void e.stopPropagation();if("true"==this.dataset.attachment)return;e.preventDefault();const a=this.firstChild,i=a.href,s=this.dataset.type,n=a.firstChild,o=n.classList.contains("spoilerimg"),r=this.previousSibling,l=this.closest(".post-file-src");let c="image"===s?n.nextSibling:a.nextSibling;if(c)t(n,c,r,l);else if("0.5"!==n.style.opacity){let d;switch(s){case"image":if(e.preventDefault(),o||(a.style.minWidth=a.offsetWidth+"px",a.style.minHeight=a.offsetHeight+"px"),n.style.opacity="0.5",n.style.cursor="wait","true"==localStorage.getItem("imageloadingbars")){const e=new XMLHttpRequest;e.onprogress=e=>{const t=Math.floor(e.loaded/e.total*100),a=Math.floor(e.loaded/e.total*n.offsetWidth);t>=100?l.removeAttribute("data-loading"):(l.setAttribute("data-loading",t),l.style=`--data-loading: ${a}px`)},c=document.createElement("img"),d=c;const s=function(){l.removeAttribute("data-loading"),l.removeAttribute("style");const e=this.response;d.onload=function(){n.style.opacity="",n.style.cursor="",a.appendChild(c),t(n,c,r,l)},d.src=window.URL.createObjectURL(e)};e.onload=s,e.responseType="blob",e.open("GET",i,!0),e.send(null)}else c=document.createElement("img"),d=c,d.onload=function(){n.style.opacity="",n.style.cursor="",a.appendChild(c),t(n,c,r,l)},d.src=i;break;case"video":case"audio":{e.preventDefault(),c=document.createElement(s);const p=document.createElement("span"),h=document.createTextNode("["),u=document.createElement("a"),g=document.createTextNode("]");return p.classList.add("noselect","bold"),p.style.marginBottom="3px",p.style.display="block",p.style.color="var(--font-color)",u.classList.add("dummy-link"),u.textContent="Close",p.appendChild(h),p.appendChild(u),p.appendChild(g),p.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t(n,c,r,l)}),!0),c.controls="true",d=document.createElement("source"),c.appendChild(d),"audio"===s&&"IMG"===n.nodeName?(c.style.backgroundImage=`url("${encodeURI(n.src)}")`,c.style.backgroundRepeat="no-repeat",c.style.backgroundPosition="top",c.style.backgroundSize="contain",c.style.minWidth=n.width+"px",c.style.paddingTop=n.height+"px"):o||(c.style.minWidth=a.offsetWidth+"px",c.style.minHeight=a.offsetHeight+"px"),l.appendChild(c),a.appendChild(p),t(n,c,r,l),void(d.src=i)}}}},n=e=>{for(let t=0;t<e.length;t++)e[t].addEventListener("click",i,!1)};n(e),window.addEventListener("addPost",(function(e){if(e.detail.hover)return;const t=e.detail.post.getElementsByClassName("post-file-src");n(t)}))}})),window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementsByClassName("quote");let t,a={},i=!1;const s=e=>{const t=e.getBoundingClientRect().top,a=e.getBoundingClientRect().bottom,i=window.innerHeight;return t>=38&&a<=i},n=(e,t,a,i)=>{const s=document.createElement("div");return s.id="float",s.classList.remove("hoverhighlighted"),s.appendChild(t.cloneNode(!0)),document.body.appendChild(s),((e,t,a,i)=>{const s=e.getBoundingClientRect(),n=t.firstChild,o=document.body.offsetWidth-10,r=window.innerHeight;a<o/2?(t.style.left=`${s.right+10}px`,s.right+10+n.offsetWidth>=o&&(t.style.right="5px")):(t.style.right=o-s.left+15+"px",s.left-15<n.offsetWidth&&(t.style.left="5px"));const l=i<r/2;l&&s.bottom+n.offsetHeight<r?t.style.top=`${s.top}px`:!l&&n.offsetHeight<i?t.style.top=s.bottom-n.offsetHeight+"px":t.style.top="42px"})(e,s,a,i),s},o=async function(e){i="mouseover"===e.type;let o,r=this.pathname.replace(/\.html$/,".json").split("/");if((isManage||isModView)&&5===r.length&&r.splice(2,1),o=r.join("/"),!this.hash)return;const l=document.getElementById("float");l&&document.body.removeChild(l);const c=this.closest(".post-container");let d=0;c&&(d=c.dataset.postId);const p=Date.now();t=p;const h=this.hash.substring(1),u=document.getElementById(h);let g,f;if(u&&o.split("/")[1]===u.nextSibling.dataset.board)g=u.nextSibling;else{let i=localStorage.getItem(`hovercache-${o}`);if(i&&(i=JSON.parse(i),i.postId==h?f=i:i.replies.length>0&&(f=i.replies.find((e=>e.postId==h)))),!f){let t;this.style.cursor="wait";try{a[o]||(a[o]=fetch(o).then((e=>e.json()))),t=await a[o]}catch(e){return console.error(e)}finally{this.style.cursor=""}if(!t)return localStorage.removeItem(`hovercache-${o}`);setLocalStorage(`hovercache-${o}`,JSON.stringify(t)),hoverCacheList.value=Object.keys(localStorage).filter((e=>e.startsWith("hovercache"))),f=t.postId==h?t:t.replies.find((e=>e.postId==h))}if(t!==p)return;if(!f)return;const s=post({post:f,...extraLocals}),n=document.createElement("div");n.innerHTML=s,g=n.firstChild.nextSibling}if(i&&!s(g)?g=n(this,g,e.clientX,e.clientY):i?g.classList.add("hoverhighlighted"):g.classList.remove("hoverhighlighted"),f){const e=new CustomEvent("addPost",{detail:{json:f,post:g,postId:f.postId,hover:!0,nonotify:!0}});window.dispatchEvent(e)}(i||s(g))&&((e,t)=>{let a=new Set;if(e.querySelectorAll(".post-message .quote").forEach((e=>a.add(e.href))),a.size>1){const a=e.querySelectorAll(`.post-message .quote[href$="${t}"]`);for(let e=0;e<a.length;e++){const t=a[e];t.style.borderBottom=""==t.style.borderBottom?"1px dashed":"",t.style.textDecoration=""==t.style.textDecoration?"none":""}}})(g,d)};for(let t=0;t<e.length;t++)e[t].addEventListener("mouseover",o,!1),e[t].addEventListener("mouseout",o,!1);window.addEventListener("addPost",(function(e){if(e.detail.hover)return;const t=document.getElementsByClassName("quote");for(let e=0;e<t.length;e++)t[e].removeEventListener("mouseover",o),t[e].removeEventListener("mouseout",o),t[e].addEventListener("mouseover",o,!1),t[e].addEventListener("mouseout",o,!1)})),window.addEventListener("updatePostMessage",(function(e){const t=e.detail.post.getElementsByClassName("quote");for(let e=0;e<t.length;e++)t[e].addEventListener("mouseover",o,!1),t[e].addEventListener("mouseout",o,!1)}))})),window.addEventListener("settingsReady",(function(){hoverCacheList=document.getElementById("hovercachelist-setting"),hoverCacheList.value=Object.keys(localStorage).filter((e=>e.startsWith("hovercache")));document.getElementById("hovercachelist-clear").addEventListener("click",(()=>{deleteStartsWith("hovercache"),hoverCacheList.value="",console.log("cleared cache")}),!1)})),window.addEventListener("settingsReady",(()=>{const e=["volume","loop","imageloadingbars","live","scroll","localtime","relative","24hour","notifications","hiddenimages","threadwatcher","notification-yous-only","yous-setting","filters1","name","theme","codetheme","customcss","disableboardcss","hiderecursive","watchlist","heightlimit","crispimages","hidethumbnails","noncolorids","alwaysshowspoilers","hidedeletedpostcontent","hidepoststubs","smoothscrolling","tegakiheight-setting","tegakiwidth-setting"],t=document.getElementById("import-export-setting");document.getElementById("export-setting").addEventListener("click",(()=>{const a=e.reduce(((e,t)=>(e[t]=localStorage.getItem(t),e)),{});t.value=JSON.stringify(a)}),!1);document.getElementById("import-setting").addEventListener("click",(()=>{if(t.value.length>0)try{const e=JSON.parse(t.value);Object.entries(e).forEach((e=>{setLocalStorage(e[0],e[1])})),location.reload()}catch(e){console.error(e)}}),!1)})),window.addEventListener("DOMContentLoaded",(()=>{let e={};const t=t=>{t.target.dataset.open?(e=>{e.target.nextSibling.style.display="unset";const t=e.target.closest(".thread");let a=Array.from(t.querySelectorAll(".post-container")).slice(1);e.target.dataset.shown>0&&(a=a.slice(0,-parseInt(e.target.dataset.shown))),a.forEach((e=>{e.previousSibling.remove(),e.remove()})),e.target.removeAttribute("data-open"),e.target.src="/file/plus.png"})(t):(async t=>{const a=t.target.dataset.thread,i=t.target.dataset.board,s=t.target.closest(".post-container"),n=s.nextSibling&&s.nextSibling.nextSibling,o=`/${i}/thread/${a}.json`;let r,l=localStorage.getItem(`hovercache-${o}`);if(l&&(l=JSON.parse(l),n&&l.replies.find((e=>e.postId==n.dataset.postId))&&(r=l.replies)),!r){let a;t.target.style.cursor="wait",t.target.classList.add("spin");try{e[o]||(e[o]=fetch(o).then((e=>e.json()))),a=await e[o]}catch(t){return console.error(t)}finally{t.target.style.cursor="",t.target.classList.remove("spin")}if(!a)return localStorage.removeItem(`hovercache-${o}`);setLocalStorage(`hovercache-${o}`,JSON.stringify(a)),hoverCacheList.value=Object.keys(localStorage).filter((e=>e.startsWith("hovercache"))),r=[...a.replies]}if(!r)return;const c=s.querySelector(".replies");if(c&&c.innerText.includes("+")){const e=c.lastElementChild;e.previousSibling.remove(),e.remove()}r=r.reverse(),t.target.nextSibling.style.display="none",t.target.src="/file/minus.png",t.target.dataset.open=!0,n&&(r=r.filter((e=>e.postId<n.dataset.postId))),r.forEach((e=>{newPost(e,{nonotify:!0,insertPoint:n?s.nextSibling:s,insertPosition:n?"beforebegin":"afterend"})}))})(t)},a=document.getElementsByClassName("expand-omitted");for(let e=0;e<a.length;e++)a[e].addEventListener("click",t,!1)}));const charset="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/",generatePassword=()=>{try{if(window.crypto){const e=new Uint8Array(20);return window.crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,e))}}catch(e){}return new Array(20).fill(null).map((()=>charset[Math.floor(Math.random()*charset.length)])).join("")};setDefaultLocalStorage("postpassword",generatePassword());class syncedField{constructor(e,t,a=!1,i=!0){this.fields=[],this.selector=e,this.key=t,this.oneWay=a,this.persistent=i,this.init()}init(){const e=document.getElementById("settingsmodal").querySelectorAll(this.selector);this.fields=this.fields.concat([...e]);const t=document.getElementById("postform");if(t){const e=t.querySelectorAll(this.selector);this.fields=this.fields.concat([...e])}const a=document.getElementById("actionform");if(a){const e=a.querySelectorAll(this.selector);this.fields=this.fields.concat([...e])}this.oneWay&&e[0].addEventListener("input",(e=>{this.update(e)}),!1);for(let e of this.fields)!this.oneWay&&e.addEventListener("input",(e=>{this.update(e)}),!1),e.form&&e.form.addEventListener("reset",(()=>{setTimeout((()=>{this.set(localStorage.getItem(this.key))}),0)}),!1);this.set(localStorage.getItem(this.key))}update(e){this.persistent&&setLocalStorage(this.key,e.target.value),this.set(e.target.value)}set(e){if(null!==e)for(let t of this.fields)if(t.value=e,"SELECT"===t.tagName){const e=new Event("change");t.dispatchEvent(e)}}}window.addEventListener("settingsReady",(()=>{new syncedField('input[name="postpassword"]',"postpassword"),new syncedField('input[name="name"]',"name");const e=window.location.pathname.split("/")[1];new syncedField('select[name="customflag"]',`customflag-${e}`)})),window.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("#postform"),t=document.querySelector('a[href="#postform"]'),a=document.querySelector(".bottom-reply"),i=i=>{i&&i.preventDefault(),history.replaceState({},"","#postform"),e.style.display="flex",t.style.visibility="hidden",a&&(a.style.display="none"),e.dispatchEvent(new Event("opened"))},s=i=>{i.preventDefault(),history.replaceState({},"",location.pathname),e.style.display="none",t.style.visibility="visible",a&&(a.style.display="")};if(e){const n=e?e.querySelector(".close"):null;t.addEventListener("click",i,!1),a&&a.addEventListener("click",i,!1),n.addEventListener("click",s,!1)}const n=document.getElementById("message"),o=function(e){i();let t,a=`>>${e}\n`;if(window.getSelection?t=window.getSelection().toString():document.getSelection?t=document.getSelection().toString():document.selection&&(t=document.selection.createRange().text),t&&t.length>0){a+=`${t.split(/\r?\n/).map((e=>e.trim().length>0?`>${e}`:e)).join("\n")}\n`}(e=>{const t=n.selectionStart;n.value=`${n.value.substr(0,t)}${e}${n.value.substr(t)}`,n.setSelectionRange(t+e.length,t+e.length)})(a),n.focus(),n.dispatchEvent(new Event("input"))},r=function(e){const t=this.textContent.trim();isThread&&!e.ctrlKey?o(t):setLocalStorage("clickedQuote",t)};if("#postform"===location.hash&&i(),isThread){const e=localStorage.getItem("clickedQuote");if(null!=e){o(e);const t=document.getElementById(e);t&&t.scrollIntoView()}localStorage.removeItem("clickedQuote")}const l=e=>{for(let t=0;t<e.length;t++)e[t].addEventListener("click",r,!1)},c=document.getElementsByClassName("post-quoters");l(c),window.addEventListener("addPost",(function(e){if(e.detail.hover)return;const t=e.detail.post.getElementsByClassName("post-quoters");l(t)}))})),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).io=t()}(this,(function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&a(e.prototype,t),i&&a(e,i),e}function s(){return s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var i in a)Object.prototype.hasOwnProperty.call(a,i)&&(e[i]=a[i])}return e},s.apply(this,arguments)}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function r(e,t){return r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},r(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function c(e,t,a){return c=l()?Reflect.construct:function(e,t,a){var i=[null];i.push.apply(i,t);var s=new(Function.bind.apply(e,i));return a&&r(s,a.prototype),s},c.apply(null,arguments)}function d(e){var t="function"==typeof Map?new Map:void 0;return d=function(e){if(null===e||(a=e,-1===Function.toString.call(a).indexOf("[native code]")))return e;var a;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return c(e,arguments,o(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),r(i,e)},d(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}function u(e){var t=l();return function(){var a,i=o(e);if(t){var s=o(this).constructor;a=Reflect.construct(i,arguments,s)}else a=i.apply(this,arguments);return h(this,a)}}function g(e,t,a){return g="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,a){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}(e,t);if(i){var s=Object.getOwnPropertyDescriptor(i,t);return s.get?s.get.call(a):s.value}},g(e,t,a||e)}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,i=new Array(t);a<t;a++)i[a]=e[a];return i}function m(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=function(e,t){if(e){if("string"==typeof e)return f(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?f(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var i=0,s=function(){};return{s:s,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,r=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return o=e.done,e},e:function(e){r=!0,n=e},f:function(){try{o||null==a.return||a.return()}finally{if(r)throw n}}}}var y=Object.create(null);y.open="0",y.close="1",y.ping="2",y.pong="3",y.message="4",y.upgrade="5",y.noop="6";var k=Object.create(null);Object.keys(y).forEach((function(e){k[y[e]]=e}));for(var v={type:"error",data:"parser error"},T="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),b="function"==typeof ArrayBuffer,w=function(e,t,a){var i,s=e.type,n=e.data;return T&&n instanceof Blob?t?a(n):L(n,a):b&&(n instanceof ArrayBuffer||(i=n,"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(i):i&&i.buffer instanceof ArrayBuffer))?t?a(n):L(new Blob([n]),a):a(y[s]+(n||""))},L=function(e,t){var a=new FileReader;return a.onload=function(){var e=a.result.split(",")[1];t("b"+e)},a.readAsDataURL(e)},C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",S="undefined"==typeof Uint8Array?[]:new Uint8Array(256),I=0;I<C.length;I++)S[C.charCodeAt(I)]=I;var E="function"==typeof ArrayBuffer,x=function(e,t){if("string"!=typeof e)return{type:"message",data:A(e,t)};var a=e.charAt(0);return"b"===a?{type:"message",data:_(e.substring(1),t)}:k[a]?e.length>1?{type:k[a],data:e.substring(1)}:{type:k[a]}:v},_=function(e,t){if(E){var a=function(e){var t,a,i,s,n,o=.75*e.length,r=e.length,l=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),d=new Uint8Array(c);for(t=0;t<r;t+=4)a=S[e.charCodeAt(t)],i=S[e.charCodeAt(t+1)],s=S[e.charCodeAt(t+2)],n=S[e.charCodeAt(t+3)],d[l++]=a<<2|i>>4,d[l++]=(15&i)<<4|s>>2,d[l++]=(3&s)<<6|63&n;return c}(e);return A(a,t)}return{base64:!0,data:e}},A=function(e,t){return"blob"===t&&e instanceof ArrayBuffer?new Blob([e]):e},$=String.fromCharCode(30);function D(e){if(e)return function(e){for(var t in D.prototype)e[t]=D.prototype[t];return e}(e)}D.prototype.on=D.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},D.prototype.once=function(e,t){function a(){this.off(e,a),t.apply(this,arguments)}return a.fn=t,this.on(e,a),this},D.prototype.off=D.prototype.removeListener=D.prototype.removeAllListeners=D.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var a,i=this._callbacks["$"+e];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var s=0;s<i.length;s++)if((a=i[s])===t||a.fn===t){i.splice(s,1);break}return 0===i.length&&delete this._callbacks["$"+e],this},D.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),a=this._callbacks["$"+e],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(a){i=0;for(var s=(a=a.slice(0)).length;i<s;++i)a[i].apply(this,t)}return this},D.prototype.emitReserved=D.prototype.emit,D.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},D.prototype.hasListeners=function(e){return!!this.listeners(e).length};var R="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function P(e){for(var t=arguments.length,a=new Array(t>1?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];return a.reduce((function(t,a){return e.hasOwnProperty(a)&&(t[a]=e[a]),t}),{})}var U=setTimeout,B=clearTimeout;function N(e,t){t.useNativeTimers?(e.setTimeoutFn=U.bind(R),e.clearTimeoutFn=B.bind(R)):(e.setTimeoutFn=setTimeout.bind(R),e.clearTimeoutFn=clearTimeout.bind(R))}var z,O=function(e){n(i,e);var a=u(i);function i(e,s,n){var o;return t(this,i),(o=a.call(this,e)).description=s,o.context=n,o.type="TransportError",o}return i}(d(Error)),F=function(e){n(s,e);var a=u(s);function s(e){var i;return t(this,s),(i=a.call(this)).writable=!1,N(p(i),e),i.opts=e,i.query=e.query,i.readyState="",i.socket=e.socket,i}return i(s,[{key:"onError",value:function(e,t,a){return g(o(s.prototype),"emitReserved",this).call(this,"error",new O(e,t,a)),this}},{key:"open",value:function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}},{key:"close",value:function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}},{key:"send",value:function(e){"open"===this.readyState&&this.write(e)}},{key:"onOpen",value:function(){this.readyState="open",this.writable=!0,g(o(s.prototype),"emitReserved",this).call(this,"open")}},{key:"onData",value:function(e){var t=x(e,this.socket.binaryType);this.onPacket(t)}},{key:"onPacket",value:function(e){g(o(s.prototype),"emitReserved",this).call(this,"packet",e)}},{key:"onClose",value:function(e){this.readyState="closed",g(o(s.prototype),"emitReserved",this).call(this,"close",e)}}]),s}(D),M="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),H={},j=0,q=0;function W(e){var t="";do{t=M[e%64]+t,e=Math.floor(e/64)}while(e>0);return t}function V(){var e=W(+new Date);return e!==z?(j=0,z=e):e+"."+W(j++)}for(;q<64;q++)H[M[q]]=q;function G(e){var t="";for(var a in e)e.hasOwnProperty(a)&&(t.length&&(t+="&"),t+=encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return t}function K(e){for(var t={},a=e.split("&"),i=0,s=a.length;i<s;i++){var n=a[i].split("=");t[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return t}var J=!1;try{J="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(e){}var Y=J;function X(e){var t=e.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!t||Y))return new XMLHttpRequest}catch(e){}if(!t)try{return new(R[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}function Z(){}var Q=null!=new X({xdomain:!1}).responseType,ee=function(e){n(o,e);var a=u(o);function o(e){var i;if(t(this,o),(i=a.call(this,e)).polling=!1,"undefined"!=typeof location){var s="https:"===location.protocol,n=location.port;n||(n=s?"443":"80"),i.xd="undefined"!=typeof location&&e.hostname!==location.hostname||n!==e.port,i.xs=e.secure!==s}var r=e&&e.forceBase64;return i.supportsBinary=Q&&!r,i}return i(o,[{key:"name",get:function(){return"polling"}},{key:"doOpen",value:function(){this.poll()}},{key:"pause",value:function(e){var t=this;this.readyState="pausing";var a=function(){t.readyState="paused",e()};if(this.polling||!this.writable){var i=0;this.polling&&(i++,this.once("pollComplete",(function(){--i||a()}))),this.writable||(i++,this.once("drain",(function(){--i||a()})))}else a()}},{key:"poll",value:function(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}},{key:"onData",value:function(e){var t=this;(function(e,t){for(var a=e.split($),i=[],s=0;s<a.length;s++){var n=x(a[s],t);if(i.push(n),"error"===n.type)break}return i})(e,this.socket.binaryType).forEach((function(e){if("opening"===t.readyState&&"open"===e.type&&t.onOpen(),"close"===e.type)return t.onClose({description:"transport closed by the server"}),!1;t.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}},{key:"doClose",value:function(){var e=this,t=function(){e.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}},{key:"write",value:function(e){var t=this;this.writable=!1,function(e,t){var a=e.length,i=new Array(a),s=0;e.forEach((function(e,n){w(e,!1,(function(e){i[n]=e,++s===a&&t(i.join($))}))}))}(e,(function(e){t.doWrite(e,(function(){t.writable=!0,t.emitReserved("drain")}))}))}},{key:"uri",value:function(){var e=this.query||{},t=this.opts.secure?"https":"http",a="";!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=V()),this.supportsBinary||e.sid||(e.b64=1),this.opts.port&&("https"===t&&443!==Number(this.opts.port)||"http"===t&&80!==Number(this.opts.port))&&(a=":"+this.opts.port);var i=G(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+a+this.opts.path+(i.length?"?"+i:"")}},{key:"request",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return s(e,{xd:this.xd,xs:this.xs},this.opts),new te(this.uri(),e)}},{key:"doWrite",value:function(e,t){var a=this,i=this.request({method:"POST",data:e});i.on("success",t),i.on("error",(function(e,t){a.onError("xhr post error",e,t)}))}},{key:"doPoll",value:function(){var e=this,t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(function(t,a){e.onError("xhr poll error",t,a)})),this.pollXhr=t}}]),o}(F),te=function(e){n(s,e);var a=u(s);function s(e,i){var n;return t(this,s),N(p(n=a.call(this)),i),n.opts=i,n.method=i.method||"GET",n.uri=e,n.async=!1!==i.async,n.data=void 0!==i.data?i.data:null,n.create(),n}return i(s,[{key:"create",value:function(){var e=this,t=P(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd,t.xscheme=!!this.opts.xs;var a=this.xhr=new X(t);try{a.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders)for(var i in a.setDisableHeaderCheck&&a.setDisableHeaderCheck(!0),this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(i)&&a.setRequestHeader(i,this.opts.extraHeaders[i])}catch(e){}if("POST"===this.method)try{a.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{a.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in a&&(a.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(a.timeout=this.opts.requestTimeout),a.onreadystatechange=function(){4===a.readyState&&(200===a.status||1223===a.status?e.onLoad():e.setTimeoutFn((function(){e.onError("number"==typeof a.status?a.status:0)}),0))},a.send(this.data)}catch(t){return void this.setTimeoutFn((function(){e.onError(t)}),0)}"undefined"!=typeof document&&(this.index=s.requestsCount++,s.requests[this.index]=this)}},{key:"onError",value:function(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}},{key:"cleanup",value:function(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=Z,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete s.requests[this.index],this.xhr=null}}},{key:"onLoad",value:function(){var e=this.xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}},{key:"abort",value:function(){this.cleanup()}}]),s}(D);function ae(){for(var e in te.requests)te.requests.hasOwnProperty(e)&&te.requests[e].abort()}te.requestsCount=0,te.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",ae):"function"==typeof addEventListener&&addEventListener("onpagehide"in R?"pagehide":"unload",ae,!1));var ie="function"==typeof Promise&&"function"==typeof Promise.resolve?function(e){return Promise.resolve().then(e)}:function(e,t){return t(e,0)},se=R.WebSocket||R.MozWebSocket,ne="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),oe=function(e){n(s,e);var a=u(s);function s(e){var i;return t(this,s),(i=a.call(this,e)).supportsBinary=!e.forceBase64,i}return i(s,[{key:"name",get:function(){return"websocket"}},{key:"doOpen",value:function(){if(this.check()){var e=this.uri(),t=this.opts.protocols,a=ne?{}:P(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(a.headers=this.opts.extraHeaders);try{this.ws=ne?new se(e,t,a):t?new se(e,t):new se(e)}catch(e){return this.emitReserved("error",e)}this.ws.binaryType=this.socket.binaryType||"arraybuffer",this.addEventListeners()}}},{key:"addEventListeners",value:function(){var e=this;this.ws.onopen=function(){e.opts.autoUnref&&e.ws._socket.unref(),e.onOpen()},this.ws.onclose=function(t){return e.onClose({description:"websocket connection closed",context:t})},this.ws.onmessage=function(t){return e.onData(t.data)},this.ws.onerror=function(t){return e.onError("websocket error",t)}}},{key:"write",value:function(e){var t=this;this.writable=!1;for(var a=function(a){var i=e[a],s=a===e.length-1;w(i,t.supportsBinary,(function(e){try{t.ws.send(e)}catch(e){}s&&ie((function(){t.writable=!0,t.emitReserved("drain")}),t.setTimeoutFn)}))},i=0;i<e.length;i++)a(i)}},{key:"doClose",value:function(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}},{key:"uri",value:function(){var e=this.query||{},t=this.opts.secure?"wss":"ws",a="";this.opts.port&&("wss"===t&&443!==Number(this.opts.port)||"ws"===t&&80!==Number(this.opts.port))&&(a=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=V()),this.supportsBinary||(e.b64=1);var i=G(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+a+this.opts.path+(i.length?"?"+i:"")}},{key:"check",value:function(){return!(!se||"__initialize"in se&&this.name===s.prototype.name)}}]),s}(F),re={websocket:oe,polling:ee},le=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ce=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function de(e){var t=e,a=e.indexOf("["),i=e.indexOf("]");-1!=a&&-1!=i&&(e=e.substring(0,a)+e.substring(a,i).replace(/:/g,";")+e.substring(i,e.length));for(var s,n,o=le.exec(e||""),r={},l=14;l--;)r[ce[l]]=o[l]||"";return-1!=a&&-1!=i&&(r.source=t,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=function(e,t){var a=t.replace(/\/{2,9}/g,"/").split("/");return"/"!=t.substr(0,1)&&0!==t.length||a.splice(0,1),"/"==t.substr(t.length-1,1)&&a.splice(a.length-1,1),a}(0,r.path),r.queryKey=(s=r.query,n={},s.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,a){t&&(n[t]=a)})),n),r}var pe=function(a){n(r,a);var o=u(r);function r(a){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t(this,r),i=o.call(this),a&&"object"===e(a)&&(n=a,a=null),a?(a=de(a),n.hostname=a.host,n.secure="https"===a.protocol||"wss"===a.protocol,n.port=a.port,a.query&&(n.query=a.query)):n.host&&(n.hostname=de(n.host).host),N(p(i),n),i.secure=null!=n.secure?n.secure:"undefined"!=typeof location&&"https:"===location.protocol,n.hostname&&!n.port&&(n.port=i.secure?"443":"80"),i.hostname=n.hostname||("undefined"!=typeof location?location.hostname:"localhost"),i.port=n.port||("undefined"!=typeof location&&location.port?location.port:i.secure?"443":"80"),i.transports=n.transports||["polling","websocket"],i.readyState="",i.writeBuffer=[],i.prevBufferLen=0,i.opts=s({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},n),i.opts.path=i.opts.path.replace(/\/$/,"")+"/","string"==typeof i.opts.query&&(i.opts.query=K(i.opts.query)),i.id=null,i.upgrades=null,i.pingInterval=null,i.pingTimeout=null,i.pingTimeoutTimer=null,"function"==typeof addEventListener&&(i.opts.closeOnBeforeunload&&addEventListener("beforeunload",(function(){i.transport&&(i.transport.removeAllListeners(),i.transport.close())}),!1),"localhost"!==i.hostname&&(i.offlineEventListener=function(){i.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",i.offlineEventListener,!1))),i.open(),i}return i(r,[{key:"createTransport",value:function(e){var t=s({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);var a=s({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new re[e](a)}},{key:"open",value:function(){var e,t=this;if(this.opts.rememberUpgrade&&r.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((function(){t.emitReserved("error","No transports available")}),0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}},{key:"setTransport",value:function(e){var t=this;this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(function(e){return t.onClose("transport close",e)}))}},{key:"probe",value:function(e){var t=this,a=this.createTransport(e),i=!1;r.priorWebsocketSuccess=!1;var s=function(){i||(a.send([{type:"ping",data:"probe"}]),a.once("packet",(function(e){if(!i)if("pong"===e.type&&"probe"===e.data){if(t.upgrading=!0,t.emitReserved("upgrading",a),!a)return;r.priorWebsocketSuccess="websocket"===a.name,t.transport.pause((function(){i||"closed"!==t.readyState&&(p(),t.setTransport(a),a.send([{type:"upgrade"}]),t.emitReserved("upgrade",a),a=null,t.upgrading=!1,t.flush())}))}else{var s=new Error("probe error");s.transport=a.name,t.emitReserved("upgradeError",s)}})))};function n(){i||(i=!0,p(),a.close(),a=null)}var o=function(e){var i=new Error("probe error: "+e);i.transport=a.name,n(),t.emitReserved("upgradeError",i)};function l(){o("transport closed")}function c(){o("socket closed")}function d(e){a&&e.name!==a.name&&n()}var p=function(){a.removeListener("open",s),a.removeListener("error",o),a.removeListener("close",l),t.off("close",c),t.off("upgrading",d)};a.once("open",s),a.once("error",o),a.once("close",l),this.once("close",c),this.once("upgrading",d),a.open()}},{key:"onOpen",value:function(){if(this.readyState="open",r.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause)for(var e=0,t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}},{key:"onPacket",value:function(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":var t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}},{key:"onHandshake",value:function(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}},{key:"resetPingTimeout",value:function(){var e=this;this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((function(){e.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}},{key:"onDrain",value:function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}},{key:"flush",value:function(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){var e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}},{key:"getWritablePackets",value:function(){if(!(this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;for(var e,t=1,a=0;a<this.writeBuffer.length;a++){var i=this.writeBuffer[a].data;if(i&&(t+="string"==typeof(e=i)?function(e){for(var t=0,a=0,i=0,s=e.length;i<s;i++)(t=e.charCodeAt(i))<128?a+=1:t<2048?a+=2:t<55296||t>=57344?a+=3:(i++,a+=4);return a}(e):Math.ceil(1.33*(e.byteLength||e.size))),a>0&&t>this.maxPayload)return this.writeBuffer.slice(0,a);t+=2}return this.writeBuffer}},{key:"write",value:function(e,t,a){return this.sendPacket("message",e,t,a),this}},{key:"send",value:function(e,t,a){return this.sendPacket("message",e,t,a),this}},{key:"sendPacket",value:function(e,t,a,i){if("function"==typeof t&&(i=t,t=void 0),"function"==typeof a&&(i=a,a=null),"closing"!==this.readyState&&"closed"!==this.readyState){(a=a||{}).compress=!1!==a.compress;var s={type:e,data:t,options:a};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),i&&this.once("flush",i),this.flush()}}},{key:"close",value:function(){var e=this,t=function(){e.onClose("forced close"),e.transport.close()},a=function a(){e.off("upgrade",a),e.off("upgradeError",a),t()},i=function(){e.once("upgrade",a),e.once("upgradeError",a)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(function(){e.upgrading?i():t()})):this.upgrading?i():t()),this}},{key:"onError",value:function(e){r.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}},{key:"onClose",value:function(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"==typeof removeEventListener&&removeEventListener("offline",this.offlineEventListener,!1),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}},{key:"filterUpgrades",value:function(e){for(var t=[],a=0,i=e.length;a<i;a++)~this.transports.indexOf(e[a])&&t.push(e[a]);return t}}]),r}(D);pe.protocol=4;var he,ue="function"==typeof ArrayBuffer,ge=Object.prototype.toString,fe="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===ge.call(Blob),me="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===ge.call(File);function ye(e){return ue&&(e instanceof ArrayBuffer||function(e){return"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer}(e))||fe&&e instanceof Blob||me&&e instanceof File}function ke(t,a){if(!t||"object"!==e(t))return!1;if(Array.isArray(t)){for(var i=0,s=t.length;i<s;i++)if(ke(t[i]))return!0;return!1}if(ye(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return ke(t.toJSON(),!0);for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&ke(t[n]))return!0;return!1}function ve(t,a){if(!t)return t;if(ye(t)){var i={_placeholder:!0,num:a.length};return a.push(t),i}if(Array.isArray(t)){for(var s=new Array(t.length),n=0;n<t.length;n++)s[n]=ve(t[n],a);return s}if("object"===e(t)&&!(t instanceof Date)){var o={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(o[r]=ve(t[r],a));return o}return t}function Te(t,a){if(!t)return t;if(t&&t._placeholder)return a[t.num];if(Array.isArray(t))for(var i=0;i<t.length;i++)t[i]=Te(t[i],a);else if("object"===e(t))for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(t[s]=Te(t[s],a));return t}!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(he||(he={}));var be=function(){function e(a){t(this,e),this.replacer=a}return i(e,[{key:"encode",value:function(e){return e.type!==he.EVENT&&e.type!==he.ACK||!ke(e)?[this.encodeAsString(e)]:(e.type=e.type===he.EVENT?he.BINARY_EVENT:he.BINARY_ACK,this.encodeAsBinary(e))}},{key:"encodeAsString",value:function(e){var t=""+e.type;return e.type!==he.BINARY_EVENT&&e.type!==he.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}},{key:"encodeAsBinary",value:function(e){var t=function(e){var t=[],a=e.data,i=e;return i.data=ve(a,t),i.attachments=t.length,{packet:i,buffers:t}}(e),a=this.encodeAsString(t.packet),i=t.buffers;return i.unshift(a),i}}]),e}(),we=function(a){n(r,a);var s=u(r);function r(e){var a;return t(this,r),(a=s.call(this)).reviver=e,a}return i(r,[{key:"add",value:function(e){var t;if("string"==typeof e)(t=this.decodeString(e)).type===he.BINARY_EVENT||t.type===he.BINARY_ACK?(this.reconstructor=new Le(t),0===t.attachments&&g(o(r.prototype),"emitReserved",this).call(this,"decoded",t)):g(o(r.prototype),"emitReserved",this).call(this,"decoded",t);else{if(!ye(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(t=this.reconstructor.takeBinaryData(e))&&(this.reconstructor=null,g(o(r.prototype),"emitReserved",this).call(this,"decoded",t))}}},{key:"decodeString",value:function(e){var t=0,a={type:Number(e.charAt(0))};if(void 0===he[a.type])throw new Error("unknown packet type "+a.type);if(a.type===he.BINARY_EVENT||a.type===he.BINARY_ACK){for(var i=t+1;"-"!==e.charAt(++t)&&t!=e.length;);var s=e.substring(i,t);if(s!=Number(s)||"-"!==e.charAt(t))throw new Error("Illegal attachments");a.attachments=Number(s)}if("/"===e.charAt(t+1)){for(var n=t+1;++t&&","!==e.charAt(t)&&t!==e.length;);a.nsp=e.substring(n,t)}else a.nsp="/";var o=e.charAt(t+1);if(""!==o&&Number(o)==o){for(var l=t+1;++t;){var c=e.charAt(t);if(null==c||Number(c)!=c){--t;break}if(t===e.length)break}a.id=Number(e.substring(l,t+1))}if(e.charAt(++t)){var d=this.tryParse(e.substr(t));if(!r.isPayloadValid(a.type,d))throw new Error("invalid payload");a.data=d}return a}},{key:"tryParse",value:function(e){try{return JSON.parse(e,this.reviver)}catch(e){return!1}}},{key:"destroy",value:function(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}],[{key:"isPayloadValid",value:function(t,a){switch(t){case he.CONNECT:return"object"===e(a);case he.DISCONNECT:return void 0===a;case he.CONNECT_ERROR:return"string"==typeof a||"object"===e(a);case he.EVENT:case he.BINARY_EVENT:return Array.isArray(a)&&a.length>0;case he.ACK:case he.BINARY_ACK:return Array.isArray(a)}}}]),r}(D),Le=function(){function e(a){t(this,e),this.packet=a,this.buffers=[],this.reconPack=a}return i(e,[{key:"takeBinaryData",value:function(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){var t=function(e,t){return e.data=Te(e.data,t),e.attachments=void 0,e}(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}},{key:"finishedReconstruction",value:function(){this.reconPack=null,this.buffers=[]}}]),e}(),Ce=Object.freeze({__proto__:null,protocol:5,get PacketType(){return he},Encoder:be,Decoder:we});function Se(e,t,a){return e.on(t,a),function(){e.off(t,a)}}var Ie=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),Ee=function(e){n(s,e);var a=u(s);function s(e,i,n){var o;return t(this,s),(o=a.call(this)).connected=!1,o.receiveBuffer=[],o.sendBuffer=[],o.ids=0,o.acks={},o.flags={},o.io=e,o.nsp=i,n&&n.auth&&(o.auth=n.auth),o.io._autoConnect&&o.open(),o}return i(s,[{key:"disconnected",get:function(){return!this.connected}},{key:"subEvents",value:function(){if(!this.subs){var e=this.io;this.subs=[Se(e,"open",this.onopen.bind(this)),Se(e,"packet",this.onpacket.bind(this)),Se(e,"error",this.onerror.bind(this)),Se(e,"close",this.onclose.bind(this))]}}},{key:"active",get:function(){return!!this.subs}},{key:"connect",value:function(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}},{key:"open",value:function(){return this.connect()}},{key:"send",value:function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return t.unshift("message"),this.emit.apply(this,t),this}},{key:"emit",value:function(e){if(Ie.hasOwnProperty(e))throw new Error('"'+e+'" is a reserved event name');for(var t=arguments.length,a=new Array(t>1?t-1:0),i=1;i<t;i++)a[i-1]=arguments[i];a.unshift(e);var s={type:he.EVENT,data:a,options:{}};if(s.options.compress=!1!==this.flags.compress,"function"==typeof a[a.length-1]){var n=this.ids++,o=a.pop();this._registerAckCallback(n,o),s.id=n}var r=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable,l=this.flags.volatile&&(!r||!this.connected);return l||(this.connected?(this.notifyOutgoingListeners(s),this.packet(s)):this.sendBuffer.push(s)),this.flags={},this}},{key:"_registerAckCallback",value:function(e,t){var a=this,i=this.flags.timeout;if(void 0!==i){var s=this.io.setTimeoutFn((function(){delete a.acks[e];for(var i=0;i<a.sendBuffer.length;i++)a.sendBuffer[i].id===e&&a.sendBuffer.splice(i,1);t.call(a,new Error("operation has timed out"))}),i);this.acks[e]=function(){a.io.clearTimeoutFn(s);for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];t.apply(a,[null].concat(i))}}else this.acks[e]=t}},{key:"packet",value:function(e){e.nsp=this.nsp,this.io._packet(e)}},{key:"onopen",value:function(){var e=this;"function"==typeof this.auth?this.auth((function(t){e.packet({type:he.CONNECT,data:t})})):this.packet({type:he.CONNECT,data:this.auth})}},{key:"onerror",value:function(e){this.connected||this.emitReserved("connect_error",e)}},{key:"onclose",value:function(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t)}},{key:"onpacket",value:function(e){if(e.nsp===this.nsp)switch(e.type){case he.CONNECT:if(e.data&&e.data.sid){var t=e.data.sid;this.onconnect(t)}else this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case he.EVENT:case he.BINARY_EVENT:this.onevent(e);break;case he.ACK:case he.BINARY_ACK:this.onack(e);break;case he.DISCONNECT:this.ondisconnect();break;case he.CONNECT_ERROR:this.destroy();var a=new Error(e.data.message);a.data=e.data.data,this.emitReserved("connect_error",a)}}},{key:"onevent",value:function(e){var t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}},{key:"emitEvent",value:function(e){if(this._anyListeners&&this._anyListeners.length){var t,a=m(this._anyListeners.slice());try{for(a.s();!(t=a.n()).done;)t.value.apply(this,e)}catch(e){a.e(e)}finally{a.f()}}g(o(s.prototype),"emit",this).apply(this,e)}},{key:"ack",value:function(e){var t=this,a=!1;return function(){if(!a){a=!0;for(var i=arguments.length,s=new Array(i),n=0;n<i;n++)s[n]=arguments[n];t.packet({type:he.ACK,id:e,data:s})}}}},{key:"onack",value:function(e){var t=this.acks[e.id];"function"==typeof t&&(t.apply(this,e.data),delete this.acks[e.id])}},{key:"onconnect",value:function(e){this.id=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect")}},{key:"emitBuffered",value:function(){var e=this;this.receiveBuffer.forEach((function(t){return e.emitEvent(t)})),this.receiveBuffer=[],this.sendBuffer.forEach((function(t){e.notifyOutgoingListeners(t),e.packet(t)})),this.sendBuffer=[]}},{key:"ondisconnect",value:function(){this.destroy(),this.onclose("io server disconnect")}},{key:"destroy",value:function(){this.subs&&(this.subs.forEach((function(e){return e()})),this.subs=void 0),this.io._destroy(this)}},{key:"disconnect",value:function(){return this.connected&&this.packet({type:he.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}},{key:"close",value:function(){return this.disconnect()}},{key:"compress",value:function(e){return this.flags.compress=e,this}},{key:"volatile",get:function(){return this.flags.volatile=!0,this}},{key:"timeout",value:function(e){return this.flags.timeout=e,this}},{key:"onAny",value:function(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}},{key:"prependAny",value:function(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}},{key:"offAny",value:function(e){if(!this._anyListeners)return this;if(e){for(var t=this._anyListeners,a=0;a<t.length;a++)if(e===t[a])return t.splice(a,1),this}else this._anyListeners=[];return this}},{key:"listenersAny",value:function(){return this._anyListeners||[]}},{key:"onAnyOutgoing",value:function(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}},{key:"prependAnyOutgoing",value:function(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}},{key:"offAnyOutgoing",value:function(e){if(!this._anyOutgoingListeners)return this;if(e){for(var t=this._anyOutgoingListeners,a=0;a<t.length;a++)if(e===t[a])return t.splice(a,1),this}else this._anyOutgoingListeners=[];return this}},{key:"listenersAnyOutgoing",value:function(){return this._anyOutgoingListeners||[]}},{key:"notifyOutgoingListeners",value:function(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){var t,a=m(this._anyOutgoingListeners.slice());try{for(a.s();!(t=a.n()).done;)t.value.apply(this,e.data)}catch(e){a.e(e)}finally{a.f()}}}}]),s}(D);function xe(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}xe.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),a=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-a:e+a}return 0|Math.min(e,this.max)},xe.prototype.reset=function(){this.attempts=0},xe.prototype.setMin=function(e){this.ms=e},xe.prototype.setMax=function(e){this.max=e},xe.prototype.setJitter=function(e){this.jitter=e};var _e=function(a){n(o,a);var s=u(o);function o(a,i){var n,r;t(this,o),(n=s.call(this)).nsps={},n.subs=[],a&&"object"===e(a)&&(i=a,a=void 0),(i=i||{}).path=i.path||"/socket.io",n.opts=i,N(p(n),i),n.reconnection(!1!==i.reconnection),n.reconnectionAttempts(i.reconnectionAttempts||1/0),n.reconnectionDelay(i.reconnectionDelay||1e3),n.reconnectionDelayMax(i.reconnectionDelayMax||5e3),n.randomizationFactor(null!==(r=i.randomizationFactor)&&void 0!==r?r:.5),n.backoff=new xe({min:n.reconnectionDelay(),max:n.reconnectionDelayMax(),jitter:n.randomizationFactor()}),n.timeout(null==i.timeout?2e4:i.timeout),n._readyState="closed",n.uri=a;var l=i.parser||Ce;return n.encoder=new l.Encoder,n.decoder=new l.Decoder,n._autoConnect=!1!==i.autoConnect,n._autoConnect&&n.open(),n}return i(o,[{key:"reconnection",value:function(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}},{key:"reconnectionAttempts",value:function(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}},{key:"reconnectionDelay",value:function(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}},{key:"randomizationFactor",value:function(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}},{key:"reconnectionDelayMax",value:function(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}},{key:"timeout",value:function(e){return arguments.length?(this._timeout=e,this):this._timeout}},{key:"maybeReconnectOnOpen",value:function(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}},{key:"open",value:function(e){var t=this;if(~this._readyState.indexOf("open"))return this;this.engine=new pe(this.uri,this.opts);var a=this.engine,i=this;this._readyState="opening",this.skipReconnect=!1;var s=Se(a,"open",(function(){i.onopen(),e&&e()})),n=Se(a,"error",(function(a){i.cleanup(),i._readyState="closed",t.emitReserved("error",a),e?e(a):i.maybeReconnectOnOpen()}));if(!1!==this._timeout){var o=this._timeout;0===o&&s();var r=this.setTimeoutFn((function(){s(),a.close(),a.emit("error",new Error("timeout"))}),o);this.opts.autoUnref&&r.unref(),this.subs.push((function(){clearTimeout(r)}))}return this.subs.push(s),this.subs.push(n),this}},{key:"connect",value:function(e){return this.open(e)}},{key:"onopen",value:function(){this.cleanup(),this._readyState="open",this.emitReserved("open");var e=this.engine;this.subs.push(Se(e,"ping",this.onping.bind(this)),Se(e,"data",this.ondata.bind(this)),Se(e,"error",this.onerror.bind(this)),Se(e,"close",this.onclose.bind(this)),Se(this.decoder,"decoded",this.ondecoded.bind(this)))}},{key:"onping",value:function(){this.emitReserved("ping")}},{key:"ondata",value:function(e){this.decoder.add(e)}},{key:"ondecoded",value:function(e){this.emitReserved("packet",e)}},{key:"onerror",value:function(e){this.emitReserved("error",e)}},{key:"socket",value:function(e,t){var a=this.nsps[e];return a||(a=new Ee(this,e,t),this.nsps[e]=a),a}},{key:"_destroy",value:function(e){for(var t=0,a=Object.keys(this.nsps);t<a.length;t++){var i=a[t];if(this.nsps[i].active)return}this._close()}},{key:"_packet",value:function(e){for(var t=this.encoder.encode(e),a=0;a<t.length;a++)this.engine.write(t[a],e.options)}},{key:"cleanup",value:function(){this.subs.forEach((function(e){return e()})),this.subs.length=0,this.decoder.destroy()}},{key:"_close",value:function(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}},{key:"disconnect",value:function(){return this._close()}},{key:"onclose",value:function(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}},{key:"reconnect",value:function(){var e=this;if(this._reconnecting||this.skipReconnect)return this;var t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{var a=this.backoff.duration();this._reconnecting=!0;var i=this.setTimeoutFn((function(){t.skipReconnect||(e.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((function(a){a?(t._reconnecting=!1,t.reconnect(),e.emitReserved("reconnect_error",a)):t.onreconnect()})))}),a);this.opts.autoUnref&&i.unref(),this.subs.push((function(){clearTimeout(i)}))}}},{key:"onreconnect",value:function(){var e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}]),o}(D),Ae={};function $e(t,a){"object"===e(t)&&(a=t,t=void 0);var i,s=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",a=arguments.length>2?arguments[2]:void 0,i=e;a=a||"undefined"!=typeof location&&location,null==e&&(e=a.protocol+"//"+a.host),"string"==typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?a.protocol+e:a.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==a?a.protocol+"//"+e:"https://"+e),i=de(e)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";var s=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+s+":"+i.port+t,i.href=i.protocol+"://"+s+(a&&a.port===i.port?"":":"+i.port),i}(t,(a=a||{}).path||"/socket.io"),n=s.source,o=s.id,r=s.path,l=Ae[o]&&r in Ae[o].nsps;return a.forceNew||a["force new connection"]||!1===a.multiplex||l?i=new _e(n,a):(Ae[o]||(Ae[o]=new _e(n,a)),i=Ae[o]),s.query&&!a.query&&(a.query=s.queryKey),i.socket(s.path,a)}return s($e,{Manager:_e,Socket:Ee,io:$e,connect:$e}),$e}));let customCSSString=localStorage.getItem("customcss"),disableBoardCss="true"==localStorage.getItem("disableboardcss");window.addEventListener("settingsReady",(function(){const e=document.getElementById("theme-setting");e.value=localStorage.getItem("theme"),e.addEventListener("change",(()=>{setLocalStorage("theme",e.value),changeTheme("theme")}),!1);const t=document.getElementById("codetheme-setting");t.value=localStorage.getItem("codetheme"),t.addEventListener("change",(()=>{setLocalStorage("codetheme",t.value),changeTheme("codetheme")}),!1);const a=document.getElementById("customcss-setting");a.value=customCSSString,a.addEventListener("input",(()=>{customCSSString=a.value,console.log("editing custom CSS",customCSSString.length),setLocalStorage("customcss",customCSSString),changeTheme("customcss")}),!1);const i=document.getElementById("disableboardcss-setting");i.addEventListener("change",(()=>{disableBoardCss=!disableBoardCss,setLocalStorage("disableboardcss",disableBoardCss),console.log("toggling disable board custom css",disableBoardCss),toggleBoardCss()}),!1),i.checked="true"==localStorage.getItem("disableboardcss")}));const customCSSLink=document.createElement("style");function toggleBoardCss(){const e=document.getElementById("board-customcss");e&&(disableBoardCss?e.setAttribute("media","screen and (max-width: 1px)"):e.removeAttribute("media"))}function changeTheme(e){switch(e){case"theme":case"codetheme":{const t=localStorage.getItem(e);let a=document.getElementById(`custom${e}`),i=document.getElementById(e);if("default"===t||t===i.dataset.theme)i.rel="stylesheet",setTimeout((()=>{a&&a.remove()}),100);else{const s=`/css/${e}s/${t}.css`;let n=localStorage.getItem(s);a||(a=document.createElement("style"),document.head.appendChild(a)),n&&(a.innerHTML=n),i.rel="";const o=document.createElement("link");o.rel="stylesheet",o.id=`custom${e}`,o.onload=function(){n="";const e=null!=o.sheet.rules?"rules":"cssRules";for(let t=0;t<o.sheet[e].length;t++)n+=o.sheet[e][t].cssText;setLocalStorage(s,n),a.innerHTML=n,a.remove()},o.href=s,document.head.appendChild(o)}break}case"customcss":customCSSLink.innerHTML=localStorage.getItem("customcss")}}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_classes(e,t){return Array.isArray(e)?pug_classes_array(e,t):e&&"object"==typeof e?pug_classes_object(e):e||""}function pug_classes_array(e,t){for(var a,i="",s="",n=Array.isArray(t),o=0;o<e.length;o++)(a=pug_classes(e[o]))&&(n&&t[o]&&(a=pug_escape(a)),i=i+s+a,s=" ");return i}function pug_classes_object(e){var t="",a="";for(var i in e)i&&e[i]&&pug_has_own_property.call(e,i)&&(t=t+a+i,a=" ");return t}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}customCSSLink.rel="stylesheet",customCSSLink.id="customcss",document.head.appendChild(customCSSLink),toggleBoardCss(),changeTheme("theme"),changeTheme("codetheme"),changeTheme("customcss"),window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("threadstats"),t=Array.from(document.getElementsByClassName("user-id")),a=new Map,i=new Set,s=e=>{a.set(e,a.get(e)+1||1)},n=e=>{for(let i=0;i<t.length;i++){const s=t[i].innerText;if(e&&e!==s)continue;const n=a.get(s);t[i].setAttribute("data-count",` (${n})`),t[i].setAttribute("title",`Double click to highlight (${n})`)}},o=e=>{const t=e.target.innerText,a=document.querySelectorAll(`.post-container[data-user-id="${t}"]`),s=i.has(t);i[s?"delete":"add"](t);for(let e=0;e<a.length;e++)a[e].classList[s?"remove":"add"]("highlighted")};for(let e=0;e<t.length;e++)t[e].addEventListener("dblclick",o),s(t[e].innerText);isThread&&(n(),window.addEventListener("addPost",(function(r){if(r.detail.hover)return;const l=r.detail.json.files.length,c=+e.children[0].innerText.match(/^(\d+)/g),d=+e.children[1].innerText.match(/^(\d+)/g)+l,p=c+1;if(e.children[0].innerText=`${p} repl${1===p?"y":"ies"}`,e.children[1].innerText=`${d} file${1===d?"":"s"}`,r.detail.json.userId){const l=r.detail.post.querySelector(".user-id");if(t.push(l),l.addEventListener("dblclick",o),s(r.detail.json.userId),n(r.detail.json.userId),i.has(r.detail.json.userId)&&r.detail.post.classList.add("highlighted"),!e.children[2]){const t=document.createTextNode(" |  "),a=document.createElement("span");e.appendChild(t),e.appendChild(a)}e.children[2].innerText=`${a.size} UID${1===a.size?"":"s"}`}})))}));pug_has_own_property=Object.prototype.hasOwnProperty,pug_match_html=/["&<>]/;function threadwatcher(e){var t,a="",i={},s=e||{};return function(e){i.threadwatcher=t=function(e){this&&this.block,this&&this.attributes;a=a+"<div"+pug_attr("class",pug_classes(["flex-center",e?"minimised":""],[!1,!0]),!1,!1)+' id="threadwatcher"><div class="row noselect" id="threadwatcher-dragHandle"><span class="fw text-center">Thread Watcher </span><span class="mr-0 close">'+pug_escape(null==(t=e?"[+]":"[−]")?"":t)+"</span></div></div>"},i.threadwatcher(e)}.call(this,"minimised"in s?s.minimised:"undefined"!=typeof minimised?minimised:void 0),a}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}window.addEventListener("DOMContentLoaded",(()=>{let e=document.hasFocus(),t=[];const a=document.title,i=e=>{const t=e.getBoundingClientRect().top,a=e.getBoundingClientRect().bottom,i=window.innerHeight;return(t>=0||a-t>i)&&a<=i},s=()=>{0===t.length?document.title=a:document.title=`(${t.length}) ${a}`},n=()=>{e=!e};window.addEventListener("focus",n),window.addEventListener("blur",n),window.addEventListener("scroll",(()=>{const e=t.length;t=t.filter((e=>!i(e)||(e.classList.remove("highlighted"),!1))),e!==t.length&&s()})),window.addEventListener("addPost",(function(a){if(a.detail.hover)return;const n=a.detail.post;e&&i(n)||(n.classList.add("highlighted"),t.push(n),s())}))}));pug_match_html=/["&<>]/;function uploaditem(e){var t,a="",i={},s=e||{};return function(e){i.uploaditem=t=function(e){this&&this.block,this&&this.attributes;a=a+'<div><div class="upload-item"><img class="upload-thumb"'+pug_attr("src",e.url,!0,!1)+"/><p>"+pug_escape(null==(t=e.name)?"":t)+'</p><a class="close">×</a></div>',e.hash&&(a+='<div class="row sb">',e.spoilers&&(a=a+'<label><input type="checkbox" name="spoiler"'+pug_attr("value",e.hash,!0,!1)+"/>Spoiler</label>"),e.stripFilenames&&(a=a+'<label><input type="checkbox" name="strip_filename"'+pug_attr("value",e.hash,!0,!1)+"/>Strip Filename</label>"),a+="</div>"),a+="</div>"},i.uploaditem(e)}.call(this,"uploaditem"in s?s.uploaditem:void 0!==uploaditem?uploaditem:void 0),a}function pug_attr(e,t,a,i){if(!1===t||null==t||!t&&("class"===e||"style"===e))return"";if(!0===t)return" "+(i?e:e+'="'+e+'"');var s=typeof t;return"object"!==s&&"function"!==s||"function"!=typeof t.toJSON||(t=t.toJSON()),"string"==typeof t||(t=JSON.stringify(t),a||-1===t.indexOf('"'))?(a&&(t=pug_escape(t))," "+e+'="'+t+'"'):" "+e+"='"+t.replace(/'/g,"&#39;")+"'"}function pug_classes(e,t){return Array.isArray(e)?pug_classes_array(e,t):e&&"object"==typeof e?pug_classes_object(e):e||""}function pug_classes_array(e,t){for(var a,i="",s="",n=Array.isArray(t),o=0;o<e.length;o++)(a=pug_classes(e[o]))&&(n&&t[o]&&(a=pug_escape(a)),i=i+s+a,s=" ");return i}function pug_classes_object(e){var t="",a="";for(var i in e)i&&e[i]&&pug_has_own_property.call(e,i)&&(t=t+a+i,a=" ");return t}function pug_escape(e){var t=""+e,a=pug_match_html.exec(t);if(!a)return e;var i,s,n,o="";for(i=a.index,s=0;i<t.length;i++){switch(t.charCodeAt(i)){case 34:n="&quot;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}s!==i&&(o+=t.substring(s,i)),s=i+1,o+=n}return s!==i?o+t.substring(s,i):o}window.addEventListener("DOMContentLoaded",(()=>{let e={};const t=async function(t){t.preventDefault();const a=this.closest(".post-container");if(!a)return;const i=this.hash.substring(1);let s,n=this.pathname.replace(/\.html$/,".json").split("/");(isManage||isModView)&&5===n.length&&n.splice(2,1),s=n.join("/");let o,r=localStorage.getItem(`hovercache-${s}`);if(r&&(r=JSON.parse(r),r.postId==i?o=r:r.replies.length>0&&(o=r.replies.find((e=>e.postId==i)))),!o){let a;this.style.cursor="wait";try{e[s]||(e[s]=fetch(s).then((e=>e.json()))),a=await e[s]}catch(t){return console.error(t)}finally{this.style.cursor=""}if(!a)return localStorage.removeItem(`hovercache-${s}`);setLocalStorage(`hovercache-${s}`,JSON.stringify(a)),hoverCacheList.value=Object.keys(localStorage).filter((e=>e.startsWith("hovercache"))),o=a.postId==i?a:a.replies.find((e=>e.postId==i))}if(!o)return;this.parentNode.remove();const l=a.querySelector(".post-message");l&&(l.innerHTML=o.message);const c=new CustomEvent("updatePostMessage",{detail:{nonotify:!0,post:a,postId:o.postId,json:o}});window.dispatchEvent(c)},a=document.getElementsByClassName("viewfulltext");for(let e=0;e<a.length;e++)a[e].addEventListener("click",t,!1)}));pug_has_own_property=Object.prototype.hasOwnProperty,pug_match_html=/["&<>]/;function watchedthread(e){var t,a="",i={},s=e||{};return function(e){i.watchedthread=t=function(e){this&&this.block,this&&this.attributes;a=a+'<div class="row watched-thread"'+pug_attr("data-id",`${e.board}-${e.postId}`,!0,!1)+pug_attr("data-unread",e.unread||null,!0,!1)+'><a class="close">×</a>';const i=`/${e.board}/thread/${e.postId}.html`;a=a+"<a"+(pug_attr("class",pug_classes([e.isCurrentThread?"bold":""],[!0]),!1,!1)+pug_attr("href",i,!0,!1))+">/"+pug_escape(null==(t=e.board)?"":t)+"/ - "+pug_escape(null==(t=e.subject||"No subject")?"":t)+'</a><a class="ml-a"'+pug_attr("href",`${i}#bottom`,!0,!1)+">[▼]</a></div>"},i.watchedthread(e)}.call(this,"watchedthread"in s?s.watchedthread:void 0!==watchedthread?watchedthread:void 0),a}